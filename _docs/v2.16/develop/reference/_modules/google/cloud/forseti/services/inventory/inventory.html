---
layout: docs

title: "google.cloud.forseti.services.inventory.inventory"



hide:
  right_sidebar: true
---
<h1>Source code for google.cloud.forseti.services.inventory.inventory</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2017 The Forseti Security Authors. All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#    http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="sd">&quot;&quot;&quot;Inventory API.&quot;&quot;&quot;</span>

<span class="c1"># pylint: disable=line-too-long,broad-except</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">Queue</span> <span class="k">import</span> <span class="n">Queue</span>
<span class="kn">import</span> <span class="nn">threading</span>

<span class="kn">from</span> <span class="nn">google.cloud.forseti.common.util</span> <span class="k">import</span> <span class="n">date_time</span>
<span class="kn">from</span> <span class="nn">google.cloud.forseti.common.util</span> <span class="k">import</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">google.cloud.forseti.services.inventory.crawler</span> <span class="k">import</span> <span class="n">run_crawler</span>
<span class="kn">from</span> <span class="nn">google.cloud.forseti.services.inventory.storage</span> <span class="k">import</span> <span class="n">DataAccess</span>
<span class="kn">from</span> <span class="nn">google.cloud.forseti.services.inventory.storage</span> <span class="k">import</span> <span class="n">initialize</span> <span class="k">as</span> <span class="n">init_storage</span>


<span class="n">LOGGER</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="Progress"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.inventory.html#google.cloud.forseti.services.inventory.inventory.Progress">[docs]</a><span class="k">class</span> <span class="nc">Progress</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Progress state.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">final_message</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">inventory_index_id</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize</span>

<span class="sd">        Args:</span>
<span class="sd">            final_message (bool): whether it is the last message</span>
<span class="sd">            step (str): which step is this progress about</span>
<span class="sd">            inventory_index_id (str): The id of the inventory index.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inventory_index_id</span> <span class="o">=</span> <span class="n">inventory_index_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">final_message</span> <span class="o">=</span> <span class="n">final_message</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="n">step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_warning</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_error</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span></div>


<div class="viewcode-block" id="QueueProgresser"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.inventory.html#google.cloud.forseti.services.inventory.inventory.QueueProgresser">[docs]</a><span class="k">class</span> <span class="nc">QueueProgresser</span><span class="p">(</span><span class="n">Progress</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Queue based progresser.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize</span>

<span class="sd">        Args:</span>
<span class="sd">            queue (Queue): progress queue to storage status</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">QueueProgresser</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">queue</span>

<div class="viewcode-block" id="QueueProgresser._notify"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.inventory.html#google.cloud.forseti.services.inventory.inventory.QueueProgresser._notify">[docs]</a>    <span class="k">def</span> <span class="nf">_notify</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Notify status update into queue.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">put_nowait</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="QueueProgresser._notify_eof"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.inventory.html#google.cloud.forseti.services.inventory.inventory.QueueProgresser._notify_eof">[docs]</a>    <span class="k">def</span> <span class="nf">_notify_eof</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Notify end of status updates into queue.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="QueueProgresser.on_new_object"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.inventory.html#google.cloud.forseti.services.inventory.inventory.QueueProgresser.on_new_object">[docs]</a>    <span class="k">def</span> <span class="nf">on_new_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the status with the new resource.</span>

<span class="sd">        Args:</span>
<span class="sd">            resource (Resource): db row of Resource</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">type</span><span class="p">(),</span> <span class="n">resource</span><span class="o">.</span><span class="n">key</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_notify</span><span class="p">()</span></div>

<div class="viewcode-block" id="QueueProgresser.on_warning"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.inventory.html#google.cloud.forseti.services.inventory.inventory.QueueProgresser.on_warning">[docs]</a>    <span class="k">def</span> <span class="nf">on_warning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">warning</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stores the warning and updates the counter.</span>

<span class="sd">        Args:</span>
<span class="sd">            warning (str): warning message</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">last_warning</span> <span class="o">=</span> <span class="n">warning</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_notify</span><span class="p">()</span></div>

<div class="viewcode-block" id="QueueProgresser.on_error"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.inventory.html#google.cloud.forseti.services.inventory.inventory.QueueProgresser.on_error">[docs]</a>    <span class="k">def</span> <span class="nf">on_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stores the error and updates the counter.</span>

<span class="sd">        Args:</span>
<span class="sd">            error (str): error message</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">last_error</span> <span class="o">=</span> <span class="n">error</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_notify</span><span class="p">()</span></div>

<div class="viewcode-block" id="QueueProgresser.get_summary"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.inventory.html#google.cloud.forseti.services.inventory.inventory.QueueProgresser.get_summary">[docs]</a>    <span class="k">def</span> <span class="nf">get_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Indicate end of updates, and return self as last state.</span>

<span class="sd">        Returns:</span>
<span class="sd">            object: Progresser in its last state.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_notify</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_notify_eof</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span></div></div>


<div class="viewcode-block" id="FirstMessageQueueProgresser"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.inventory.html#google.cloud.forseti.services.inventory.inventory.FirstMessageQueueProgresser">[docs]</a><span class="k">class</span> <span class="nc">FirstMessageQueueProgresser</span><span class="p">(</span><span class="n">QueueProgresser</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Queue base progresser</span>

<span class="sd">    Only delivers first message. Then throws away all subsequent messages.</span>
<span class="sd">    This is used to make sure that we&#39;re not creating an internal buffer of</span>
<span class="sd">    infinite size as we&#39;re crawling in background without a queue consumer.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize</span>

<span class="sd">        Args:</span>
<span class="sd">            *args (list): Arguments.</span>
<span class="sd">            **kwargs (dict): Arguments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FirstMessageQueueProgresser</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">first_message_sent</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="FirstMessageQueueProgresser._notify"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.inventory.html#google.cloud.forseti.services.inventory.inventory.FirstMessageQueueProgresser._notify">[docs]</a>    <span class="k">def</span> <span class="nf">_notify</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_message_sent</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">first_message_sent</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">QueueProgresser</span><span class="o">.</span><span class="n">_notify</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="FirstMessageQueueProgresser._notify_eof"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.inventory.html#google.cloud.forseti.services.inventory.inventory.FirstMessageQueueProgresser._notify_eof">[docs]</a>    <span class="k">def</span> <span class="nf">_notify_eof</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_message_sent</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">first_message_sent</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">QueueProgresser</span><span class="o">.</span><span class="n">_notify_eof</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="run_inventory"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.inventory.html#google.cloud.forseti.services.inventory.inventory.run_inventory">[docs]</a><span class="k">def</span> <span class="nf">run_inventory</span><span class="p">(</span><span class="n">service_config</span><span class="p">,</span>
                  <span class="n">queue</span><span class="p">,</span>
                  <span class="n">session</span><span class="p">,</span>
                  <span class="n">progresser</span><span class="p">,</span>
                  <span class="n">background</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Runs the inventory given the environment configuration.</span>

<span class="sd">    Args:</span>
<span class="sd">        service_config (object): Service configuration.</span>
<span class="sd">        queue (object): Queue to push status updates into.</span>
<span class="sd">        session (object): Database session.</span>
<span class="sd">        progresser (object): Progresser implementation to use.</span>
<span class="sd">        background (bool): whether to run the inventory in background</span>

<span class="sd">    Returns:</span>
<span class="sd">        QueueProgresser: Returns the result of the crawl.</span>

<span class="sd">    Raises:</span>
<span class="sd">        Exception: Reraises any exception.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">storage_cls</span> <span class="o">=</span> <span class="n">service_config</span><span class="o">.</span><span class="n">get_storage_class</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">storage_cls</span><span class="p">(</span><span class="n">session</span><span class="p">)</span> <span class="k">as</span> <span class="n">storage</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">progresser</span><span class="o">.</span><span class="n">inventory_index_id</span> <span class="o">=</span> <span class="n">storage</span><span class="o">.</span><span class="n">inventory_index</span><span class="o">.</span><span class="n">id</span>
            <span class="n">progresser</span><span class="o">.</span><span class="n">final_message</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">background</span> <span class="k">else</span> <span class="kc">False</span>
            <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">progresser</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">run_crawler</span><span class="p">(</span><span class="n">storage</span><span class="p">,</span>
                                 <span class="n">progresser</span><span class="p">,</span>
                                 <span class="n">service_config</span><span class="o">.</span><span class="n">get_inventory_config</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">storage</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
            <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">storage</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="run_import"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.inventory.html#google.cloud.forseti.services.inventory.inventory.run_import">[docs]</a><span class="k">def</span> <span class="nf">run_import</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">inventory_index_id</span><span class="p">,</span> <span class="n">background</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Runs the import against an inventory.</span>

<span class="sd">    Args:</span>
<span class="sd">        client (object): Api client to use.</span>
<span class="sd">        model_name (str): Model name to create.</span>
<span class="sd">        inventory_index_id (int64): Inventory index to source.</span>
<span class="sd">        background (bool): If the import should run in background.</span>

<span class="sd">    Returns:</span>
<span class="sd">        object: RPC response object to indicate status.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">new_model</span><span class="p">(</span><span class="s1">&#39;INVENTORY&#39;</span><span class="p">,</span>
                                  <span class="n">model_name</span><span class="p">,</span>
                                  <span class="n">inventory_index_id</span><span class="p">,</span>
                                  <span class="n">background</span><span class="p">)</span></div>


<div class="viewcode-block" id="Inventory"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.inventory.html#google.cloud.forseti.services.inventory.inventory.Inventory">[docs]</a><span class="k">class</span> <span class="nc">Inventory</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Inventory API implementation.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize</span>

<span class="sd">        Args:</span>
<span class="sd">            config (ServiceConfig): ServiceConfig in server</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

        <span class="n">init_storage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_engine</span><span class="p">())</span>

<div class="viewcode-block" id="Inventory.create"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.inventory.html#google.cloud.forseti.services.inventory.inventory.Inventory.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">background</span><span class="p">,</span> <span class="n">model_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new inventory,</span>

<span class="sd">        Args:</span>
<span class="sd">            background (bool): Run import in background, return immediately</span>
<span class="sd">            model_name (str): Model name to import into</span>

<span class="sd">        Yields:</span>
<span class="sd">            object: Yields status updates.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_lock</span><span class="p">:</span>
            <span class="n">queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">background</span><span class="p">:</span>
                <span class="n">progresser</span> <span class="o">=</span> <span class="n">FirstMessageQueueProgresser</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">progresser</span> <span class="o">=</span> <span class="n">QueueProgresser</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">do_inventory</span><span class="p">():</span>
                <span class="sd">&quot;&quot;&quot;Run the inventory.</span>

<span class="sd">                Returns:</span>
<span class="sd">                    object: inventory crawler result if no model_name specified,</span>
<span class="sd">                        otherwise, model import result</span>
<span class="sd">                &quot;&quot;&quot;</span>

                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">scoped_session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">run_inventory</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
                            <span class="n">queue</span><span class="p">,</span>
                            <span class="n">session</span><span class="p">,</span>
                            <span class="n">progresser</span><span class="p">,</span>
                            <span class="n">background</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">model_name</span><span class="p">:</span>
                            <span class="n">run_import</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">client</span><span class="p">(),</span>
                                       <span class="n">model_name</span><span class="p">,</span>
                                       <span class="n">result</span><span class="o">.</span><span class="n">inventory_index_id</span><span class="p">,</span>
                                       <span class="n">background</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">get_summary</span><span class="p">()</span>

                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">LOGGER</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                        <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                        <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">background</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">run_in_background</span><span class="p">(</span><span class="n">do_inventory</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">run_in_background</span><span class="p">(</span><span class="n">do_inventory</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">progress</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">progress</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="n">progress</span>
                    <span class="k">yield</span> <span class="n">progress</span>
                <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">()</span></div>

<div class="viewcode-block" id="Inventory.list"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.inventory.html#google.cloud.forseti.services.inventory.inventory.Inventory.list">[docs]</a>    <span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List stored inventory.</span>

<span class="sd">        Yields:</span>
<span class="sd">            object: Inventory metadata</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">scoped_session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">DataAccess</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">session</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">item</span></div>

<div class="viewcode-block" id="Inventory.get"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.inventory.html#google.cloud.forseti.services.inventory.inventory.Inventory.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inventory_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get inventory metadata by id.</span>

<span class="sd">        Args:</span>
<span class="sd">            inventory_id (str): Id of the inventory.</span>

<span class="sd">        Returns:</span>
<span class="sd">            object: Inventory metadata</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">scoped_session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">DataAccess</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">inventory_id</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="Inventory.delete"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.inventory.html#google.cloud.forseti.services.inventory.inventory.Inventory.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inventory_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete an inventory by id.</span>

<span class="sd">        Args:</span>
<span class="sd">            inventory_id (str): Id of the inventory.</span>

<span class="sd">        Returns:</span>
<span class="sd">            object: Inventory object that was deleted</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">scoped_session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">DataAccess</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">inventory_id</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="Inventory.purge"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.inventory.html#google.cloud.forseti.services.inventory.inventory.Inventory.purge">[docs]</a>    <span class="k">def</span> <span class="nf">purge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retention_days</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Purge the gcp_inventory data that&#39;s older than the retention days.</span>

<span class="sd">        Args:</span>
<span class="sd">            retention_days (string): Days of inventory tables to retain.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Purge result.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;retention_days is: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">retention_days</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">retention_days</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;retention_days is not specified.  Will use &#39;</span>
                        <span class="s1">&#39;configuration default.&#39;</span><span class="p">)</span>
            <span class="n">retention_days</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">inventory_config</span><span class="o">.</span><span class="n">retention_days</span><span class="p">)</span>
        <span class="n">retention_days</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">retention_days</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">retention_days</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">result_message</span> <span class="o">=</span> <span class="s1">&#39;Purge is disabled.  Nothing will be purged.&#39;</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">result_message</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result_message</span>

        <span class="n">utc_now</span> <span class="o">=</span> <span class="n">date_time</span><span class="o">.</span><span class="n">get_utc_now_datetime</span><span class="p">()</span>
        <span class="n">cutoff_datetime</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">utc_now</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">retention_days</span><span class="p">))</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Cut-off datetime to start purging is: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="n">cutoff_datetime</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">scoped_session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">inventory_indexes_to_purge</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">DataAccess</span><span class="o">.</span><span class="n">get_inventory_indexes_older_than_cutoff</span><span class="p">(</span>
                    <span class="n">session</span><span class="p">,</span> <span class="n">cutoff_datetime</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">inventory_indexes_to_purge</span><span class="p">:</span>
            <span class="n">result_message</span> <span class="o">=</span> <span class="s1">&#39;No inventory to be purged.&#39;</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">result_message</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result_message</span>

        <span class="n">purged_inventory_indexes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">inventory_index</span> <span class="ow">in</span> <span class="n">inventory_indexes_to_purge</span><span class="p">:</span>
            <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">inventory_index</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="n">purged_inventory_indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">inventory_index</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>

        <span class="n">purged_inventory_indexes_as_str</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">purged_inventory_indexes</span><span class="p">)</span>

        <span class="n">result_message</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;Inventory data from these inventory indexes have &#39;</span>
            <span class="s1">&#39;been purged: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">purged_inventory_indexes_as_str</span><span class="p">)</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">result_message</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result_message</span></div></div>
</pre></div>
