---
layout: docs

title: "google.cloud.forseti.scanner.audit.firewall_rules_engine"



hide:
  right_sidebar: true
---
<h1>Source code for google.cloud.forseti.scanner.audit.firewall_rules_engine</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2017 The Forseti Security Authors. All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#    http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="sd">&quot;&quot;&quot;Rules engine for firewall rules.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">namedtuple</span>

<span class="kn">from</span> <span class="nn">google.cloud.forseti.common.gcp_type</span> <span class="k">import</span> <span class="n">firewall_rule</span>
<span class="kn">from</span> <span class="nn">google.cloud.forseti.common.gcp_type</span> <span class="k">import</span> <span class="n">resource</span> <span class="k">as</span> <span class="n">resource_mod</span>
<span class="kn">from</span> <span class="nn">google.cloud.forseti.common.gcp_type</span> <span class="k">import</span> <span class="n">resource_util</span>
<span class="kn">from</span> <span class="nn">google.cloud.forseti.common.util</span> <span class="k">import</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">google.cloud.forseti.common.util</span> <span class="k">import</span> <span class="n">relationship</span>
<span class="kn">from</span> <span class="nn">google.cloud.forseti.scanner.audit</span> <span class="k">import</span> <span class="n">base_rules_engine</span> <span class="k">as</span> <span class="n">bre</span>
<span class="kn">from</span> <span class="nn">google.cloud.forseti.scanner.audit</span> <span class="k">import</span> <span class="n">rules</span> <span class="k">as</span> <span class="n">scanner_rules</span>

<span class="n">LOGGER</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="Error"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.scanner.audit.firewall_rules_engine.html#google.cloud.forseti.scanner.audit.firewall_rules_engine.Error">[docs]</a><span class="k">class</span> <span class="nc">Error</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base error class for the module.&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="DuplicateFirewallRuleError"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.scanner.audit.firewall_rules_engine.html#google.cloud.forseti.scanner.audit.firewall_rules_engine.DuplicateFirewallRuleError">[docs]</a><span class="k">class</span> <span class="nc">DuplicateFirewallRuleError</span><span class="p">(</span><span class="n">Error</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raised if a rule id is reused in the rule definitions, must be unique.&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="DuplicateFirewallGroupError"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.scanner.audit.firewall_rules_engine.html#google.cloud.forseti.scanner.audit.firewall_rules_engine.DuplicateFirewallGroupError">[docs]</a><span class="k">class</span> <span class="nc">DuplicateFirewallGroupError</span><span class="p">(</span><span class="n">Error</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raised if group id is reused in the group definitions, must be unique.&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="RuleDoesntExistError"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.scanner.audit.firewall_rules_engine.html#google.cloud.forseti.scanner.audit.firewall_rules_engine.RuleDoesntExistError">[docs]</a><span class="k">class</span> <span class="nc">RuleDoesntExistError</span><span class="p">(</span><span class="n">Error</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raised if a rule group tries to add a rule that doesn&#39;t exist.&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="GroupDoesntExistError"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.scanner.audit.firewall_rules_engine.html#google.cloud.forseti.scanner.audit.firewall_rules_engine.GroupDoesntExistError">[docs]</a><span class="k">class</span> <span class="nc">GroupDoesntExistError</span><span class="p">(</span><span class="n">Error</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raised if an org policy tries to add a group that doesn&#39;t exist.&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="InvalidRuleDefinition"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.scanner.audit.firewall_rules_engine.html#google.cloud.forseti.scanner.audit.firewall_rules_engine.InvalidRuleDefinition">[docs]</a><span class="k">class</span> <span class="nc">InvalidRuleDefinition</span><span class="p">(</span><span class="n">Error</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raised if a rule definition is invalid.&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="InvalidGroupDefinition"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.scanner.audit.firewall_rules_engine.html#google.cloud.forseti.scanner.audit.firewall_rules_engine.InvalidGroupDefinition">[docs]</a><span class="k">class</span> <span class="nc">InvalidGroupDefinition</span><span class="p">(</span><span class="n">Error</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raised if a group definition is invalid.&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="InvalidOrgDefinition"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.scanner.audit.firewall_rules_engine.html#google.cloud.forseti.scanner.audit.firewall_rules_engine.InvalidOrgDefinition">[docs]</a><span class="k">class</span> <span class="nc">InvalidOrgDefinition</span><span class="p">(</span><span class="n">Error</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raised if a org definition is invalid.&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="FirewallRulesEngine"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.scanner.audit.firewall_rules_engine.html#google.cloud.forseti.scanner.audit.firewall_rules_engine.FirewallRulesEngine">[docs]</a><span class="k">class</span> <span class="nc">FirewallRulesEngine</span><span class="p">(</span><span class="n">bre</span><span class="o">.</span><span class="n">BaseRulesEngine</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Rules engine for firewall resources.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rules_file_path</span><span class="p">,</span> <span class="n">snapshot_timestamp</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize.</span>

<span class="sd">        Args:</span>
<span class="sd">          rules_file_path (str): File location of rules.</span>
<span class="sd">          snapshot_timestamp (str): The snapshot to work with.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FirewallRulesEngine</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">rules_file_path</span><span class="o">=</span><span class="n">rules_file_path</span><span class="p">,</span>
            <span class="n">snapshot_timestamp</span><span class="o">=</span><span class="n">snapshot_timestamp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_repository_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rule_book</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="FirewallRulesEngine.build_rule_book"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.scanner.audit.firewall_rules_engine.html#google.cloud.forseti.scanner.audit.firewall_rules_engine.FirewallRulesEngine.build_rule_book">[docs]</a>    <span class="k">def</span> <span class="nf">build_rule_book</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">global_configs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build RuleBook from the rule definition file.</span>

<span class="sd">        Args:</span>
<span class="sd">          global_configs (dict): Global configurations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">del</span> <span class="n">global_configs</span>  <span class="c1"># unused.</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repository_lock</span><span class="p">:</span>
            <span class="n">rule_file_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_rule_definitions</span><span class="p">()</span>
            <span class="n">rule_defs</span> <span class="o">=</span> <span class="n">rule_file_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rules&#39;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">group_defs</span> <span class="o">=</span> <span class="n">rule_file_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rule_groups&#39;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">org_policy</span> <span class="o">=</span> <span class="n">rule_file_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;org_policy&#39;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rule_book</span> <span class="o">=</span> <span class="n">RuleBook</span><span class="p">(</span>
                <span class="n">rule_defs</span><span class="o">=</span><span class="n">rule_defs</span><span class="p">,</span>
                <span class="n">group_defs</span><span class="o">=</span><span class="n">group_defs</span><span class="p">,</span>
                <span class="n">org_policy</span><span class="o">=</span><span class="n">org_policy</span><span class="p">,</span>
                <span class="n">snapshot_timestamp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">snapshot_timestamp</span><span class="p">)</span></div>

<div class="viewcode-block" id="FirewallRulesEngine.find_violations"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.scanner.audit.firewall_rules_engine.html#google.cloud.forseti.scanner.audit.firewall_rules_engine.FirewallRulesEngine.find_violations">[docs]</a>    <span class="k">def</span> <span class="nf">find_violations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">policy</span><span class="p">,</span> <span class="n">force_rebuild</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determine whether policy violates rules.</span>

<span class="sd">        Args:</span>
<span class="sd">          resource (Resource): The resource that the policy belongs to.</span>
<span class="sd">          policy (dict): The policy to compare against the rules.</span>
<span class="sd">          force_rebuild (bool): If True, rebuilds the rule book.</span>
<span class="sd">            This will reload the rules definition file and add the rules to the</span>
<span class="sd">            book.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: A list of the rule violations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule_book</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">force_rebuild</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">build_rule_book</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_rules_path</span><span class="p">)</span>

        <span class="n">violations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule_book</span><span class="o">.</span><span class="n">find_violations</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">policy</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">violations</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="RuleBook"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.scanner.audit.firewall_rules_engine.html#google.cloud.forseti.scanner.audit.firewall_rules_engine.RuleBook">[docs]</a><span class="k">class</span> <span class="nc">RuleBook</span><span class="p">(</span><span class="n">bre</span><span class="o">.</span><span class="n">BaseRuleBook</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The RuleBook for firewall auditing.</span>

<span class="sd">    Rules from the rules definition file are parsed and then the hierarchy and</span>
<span class="sd">    enforcement points are parsed. Rules then are assessed at the first</span>
<span class="sd">    applicable point in the ancestory tree that has rules.</span>

<span class="sd">    Sample org structure:</span>

<span class="sd">            org 1234</span>
<span class="sd">           /        \</span>
<span class="sd">          f-1       p-c</span>
<span class="sd">         /  \</span>
<span class="sd">       p-a  p-b</span>

<span class="sd">    Rules can be applied at any node above. When a policy is being audited,</span>
<span class="sd">    it the rulebook will start at the lowest level (the project) and will</span>
<span class="sd">    walk up the hierarchy until it reaches the first instance with rules and</span>
<span class="sd">    these are the only rules that are checked.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">rule_defs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">snapshot_timestamp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">group_defs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">org_policy</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize.</span>

<span class="sd">        Args:</span>
<span class="sd">          rule_defs (list): The parsed list of dictionary rules from the YAML</span>
<span class="sd">            definition file.</span>
<span class="sd">          snapshot_timestamp (str): The snapshot to work with.</span>
<span class="sd">          group_defs (list): The parsed list of dictionary group ids to rules.</span>
<span class="sd">          org_policy (dict): The parsed org policy configuration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RuleBook</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rule_indices</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rules_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rule_groups_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">org_policy_rules_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_timestamp</span> <span class="o">=</span> <span class="n">snapshot_timestamp</span> <span class="ow">or</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_repository_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rule_defs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_rules</span><span class="p">(</span><span class="n">rule_defs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">group_defs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_rule_groups</span><span class="p">(</span><span class="n">group_defs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">org_policy</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_org_policy</span><span class="p">(</span><span class="n">org_policy</span><span class="p">)</span>

<div class="viewcode-block" id="RuleBook.add_rules"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.scanner.audit.firewall_rules_engine.html#google.cloud.forseti.scanner.audit.firewall_rules_engine.RuleBook.add_rules">[docs]</a>    <span class="k">def</span> <span class="nf">add_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule_defs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds rules to rule book.</span>

<span class="sd">        Args:</span>
<span class="sd">          rule_defs (list): Rule definition dictionaries from yaml config file.</span>

<span class="sd">        Raises:</span>
<span class="sd">          InvalidRuleDefinition: If the rule is missing required fields or the</span>
<span class="sd">            fields have invalid values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repository_lock</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rule_def</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rule_defs</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">rule_def</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_rule</span><span class="p">(</span><span class="n">rule_def</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span></div>

<div class="viewcode-block" id="RuleBook.add_rule"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.scanner.audit.firewall_rules_engine.html#google.cloud.forseti.scanner.audit.firewall_rules_engine.RuleBook.add_rule">[docs]</a>    <span class="k">def</span> <span class="nf">add_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule_def</span><span class="p">,</span> <span class="n">rule_index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds a rule to the rule book.</span>

<span class="sd">        Args:</span>
<span class="sd">          rule_def (Rule): A Rule used to check for violations.</span>
<span class="sd">          rule_index (int): Used for logs.</span>

<span class="sd">        Raises:</span>
<span class="sd">          DuplicateFirewallRuleError: When the rule by the same name exists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rule</span> <span class="o">=</span> <span class="n">Rule</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="n">rule_def</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rule</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules_map</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DuplicateFirewallRuleError</span><span class="p">(</span>
                <span class="s1">&#39;Rule id &quot;</span><span class="si">%s</span><span class="s1">&quot; already in rules (rule </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">rule</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">rule_index</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rule_indices</span><span class="p">[</span><span class="n">rule</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">rule_index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rules_map</span><span class="p">[</span><span class="n">rule</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">rule</span></div>

<div class="viewcode-block" id="RuleBook.add_rule_groups"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.scanner.audit.firewall_rules_engine.html#google.cloud.forseti.scanner.audit.firewall_rules_engine.RuleBook.add_rule_groups">[docs]</a>    <span class="k">def</span> <span class="nf">add_rule_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_defs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates group to rule matching.</span>

<span class="sd">        Args:</span>
<span class="sd">          group_defs (dict): A dictionary with a group id and a list of rule ids</span>
<span class="sd">            that will be included by including this group in a policy.</span>

<span class="sd">        Raises:</span>
<span class="sd">          DuplicateFirewallGroupError: Raised if the group id already exists.</span>
<span class="sd">          RuleDoesntExistError: Raised if a rule included in the group does not</span>
<span class="sd">            exist.</span>
<span class="sd">          InvalidGroupDefinition: Raised if a group definition is invalid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">group_def</span> <span class="ow">in</span> <span class="n">group_defs</span><span class="p">:</span>
            <span class="n">group_id</span> <span class="o">=</span> <span class="n">group_def</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;group_id&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">group_id</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InvalidGroupDefinition</span><span class="p">(</span><span class="s1">&#39;Group requires a group id&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">group_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule_groups_map</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">DuplicateFirewallGroupError</span><span class="p">(</span>
                    <span class="s1">&#39;Group id already exists: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">group_id</span><span class="p">)</span>
            <span class="n">rule_ids</span> <span class="o">=</span> <span class="n">group_def</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rule_ids&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rule_ids</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InvalidGroupDefinition</span><span class="p">(</span>
                    <span class="s1">&#39;Group &quot;</span><span class="si">%s</span><span class="s1">&quot; does not have any rules&#39;</span> <span class="o">%</span> <span class="n">group_id</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">rule_id</span> <span class="ow">in</span> <span class="n">rule_ids</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">rule_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules_map</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">RuleDoesntExistError</span><span class="p">(</span>
                        <span class="s1">&#39;Rule id &quot;</span><span class="si">%s</span><span class="s1">&quot; does not exist, cannot be in group&#39;</span> <span class="o">%</span>
                        <span class="n">rule_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rule_groups_map</span><span class="p">[</span><span class="n">group_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">rule_ids</span></div>

<div class="viewcode-block" id="RuleBook.add_org_policy"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.scanner.audit.firewall_rules_engine.html#google.cloud.forseti.scanner.audit.firewall_rules_engine.RuleBook.add_org_policy">[docs]</a>    <span class="k">def</span> <span class="nf">add_org_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">org_def</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates org policy and rule mapping.</span>

<span class="sd">        Sample org structure:</span>

<span class="sd">                org 1234</span>
<span class="sd">               /        \</span>
<span class="sd">              f-1       p-c</span>
<span class="sd">             /  \</span>
<span class="sd">           p-a  p-b</span>

<span class="sd">        Rules can be applied at any node above. When a policy is being audited,</span>
<span class="sd">        it the rulebook will start at the lowest level (the project) and will</span>
<span class="sd">        walk up the hierarchy until it reaches the first instance with rules and</span>
<span class="sd">        these are the only rules that are checked.</span>

<span class="sd">        Args:</span>
<span class="sd">          org_def (dict): A dictionary of resource ids and enforced rules.</span>

<span class="sd">        Raises:</span>
<span class="sd">          RuleDoesntExistError: Raised if a rule included in the group does not</span>
<span class="sd">            exist.</span>
<span class="sd">          GroupDoesntExistError: Raised if a group included in an org policy</span>
<span class="sd">            does not exist.</span>
<span class="sd">          InvalidOrgDefinition: Raised if org policy doesn&#39;t have resources.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">resources</span> <span class="o">=</span> <span class="n">org_def</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;resources&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">resources</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidOrgDefinition</span><span class="p">(</span><span class="s1">&#39;Org policy does not have any resources&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">resource</span> <span class="ow">in</span> <span class="n">resources</span><span class="p">:</span>
            <span class="n">resource_type</span> <span class="o">=</span> <span class="n">resource_mod</span><span class="o">.</span><span class="n">ResourceType</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span>
                <span class="n">resource</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">))</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;resource_ids&#39;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">rules</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rules&#39;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="n">rules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;group_ids&#39;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">expanded_rules</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">group_id</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">group_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule_groups_map</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">GroupDoesntExistError</span><span class="p">(</span>
                        <span class="s1">&#39;Group &quot;</span><span class="si">%s</span><span class="s1">&quot; does not exist&#39;</span> <span class="o">%</span> <span class="n">group_id</span><span class="p">)</span>
                <span class="n">expanded_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule_groups_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">group_id</span><span class="p">,</span> <span class="p">[])</span>
                <span class="n">expanded_rules</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">expanded_group</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">rule_id</span> <span class="ow">in</span> <span class="n">rules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rule_ids&#39;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="k">if</span> <span class="n">rule_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules_map</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">RuleDoesntExistError</span><span class="p">(</span>
                        <span class="s1">&#39;Rule id &quot;</span><span class="si">%s</span><span class="s1">&quot; does not exist&#39;</span> <span class="o">%</span> <span class="n">rule_id</span><span class="p">)</span>
                <span class="n">expanded_rules</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rule_id</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">resource_id</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
                <span class="n">gcp_resource</span> <span class="o">=</span> <span class="n">resource_util</span><span class="o">.</span><span class="n">create_resource</span><span class="p">(</span>
                    <span class="n">resource_id</span><span class="o">=</span><span class="n">resource_id</span><span class="p">,</span>
                    <span class="n">resource_type</span><span class="o">=</span><span class="n">resource_type</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">org_policy_rules_map</span><span class="p">[</span><span class="n">gcp_resource</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">expanded_rules</span><span class="p">)</span></div>

<div class="viewcode-block" id="RuleBook.find_violations"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.scanner.audit.firewall_rules_engine.html#google.cloud.forseti.scanner.audit.firewall_rules_engine.RuleBook.find_violations">[docs]</a>    <span class="k">def</span> <span class="nf">find_violations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">policies</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find policy binding violations in the rule book.</span>

<span class="sd">        Args:</span>
<span class="sd">            resource (Resource): The GCP resource associated with the</span>
<span class="sd">                policy binding.</span>
<span class="sd">                This is where we start looking for rule violations and</span>
<span class="sd">                we move up the resource hierarchy (if permitted by the</span>
<span class="sd">                resource&#39;s &quot;inherit_from_parents&quot; property).</span>
<span class="sd">            policies(list): A list of FirewallRule policies.</span>

<span class="sd">        Returns:</span>
<span class="sd">            iterable: A generator of the rule violations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">violations</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">()</span>

        <span class="n">resource_ancestors</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">relationship</span><span class="o">.</span><span class="n">find_ancestors</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">policies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">full_name</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">curr_resource</span> <span class="ow">in</span> <span class="n">resource_ancestors</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">curr_resource</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">org_policy_rules_map</span><span class="p">:</span>
                <span class="n">org_policy_rules</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">org_policy_rules_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">curr_resource</span><span class="p">,</span> <span class="p">[])</span>
                <span class="k">for</span> <span class="n">rule_id</span> <span class="ow">in</span> <span class="n">org_policy_rules</span><span class="p">:</span>
                    <span class="n">rule</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules_map</span><span class="p">[</span><span class="n">rule_id</span><span class="p">]</span>
                    <span class="n">violations</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span>
                        <span class="n">violations</span><span class="p">,</span>
                        <span class="n">rule</span><span class="o">.</span><span class="n">find_violations</span><span class="p">(</span><span class="n">policies</span><span class="p">))</span>
                <span class="k">break</span>  <span class="c1"># Only the first rules found in the ancestry are applied</span>
        <span class="k">return</span> <span class="n">violations</span></div></div>


<div class="viewcode-block" id="Rule"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.scanner.audit.firewall_rules_engine.html#google.cloud.forseti.scanner.audit.firewall_rules_engine.Rule">[docs]</a><span class="k">class</span> <span class="nc">Rule</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Rule properties from the firewall rules definitions file.</span>
<span class="sd">    Also finds violations.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">VALID_RULE_MODES</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span>
        <span class="n">scanner_rules</span><span class="o">.</span><span class="n">RuleMode</span><span class="o">.</span><span class="n">WHITELIST</span><span class="p">,</span>
        <span class="n">scanner_rules</span><span class="o">.</span><span class="n">RuleMode</span><span class="o">.</span><span class="n">BLACKLIST</span><span class="p">,</span>
        <span class="n">scanner_rules</span><span class="o">.</span><span class="n">RuleMode</span><span class="o">.</span><span class="n">REQUIRED</span><span class="p">,</span>
        <span class="n">scanner_rules</span><span class="o">.</span><span class="n">RuleMode</span><span class="o">.</span><span class="n">MATCHES</span><span class="p">,</span>
    <span class="p">])</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">rule_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">match_policies</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">verify_policies</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">mode</span><span class="o">=</span><span class="n">scanner_rules</span><span class="o">.</span><span class="n">RuleMode</span><span class="o">.</span><span class="n">WHITELIST</span><span class="p">,</span>
                 <span class="n">exact_match</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize.</span>

<span class="sd">        Args:</span>
<span class="sd">          rule_id (str): The id of the rule.</span>
<span class="sd">          match_policies (list): A list of policy dictionaries.</span>
<span class="sd">          verify_policies (list): A list of policy dictionaries.</span>
<span class="sd">          mode (RuleMode): The RuleMode for this rule.</span>
<span class="sd">          exact_match (bool): Whether to exactly match required rules.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">rule_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_match_policies</span> <span class="o">=</span> <span class="n">match_policies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_match_rules</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exact_match</span> <span class="o">=</span> <span class="n">exact_match</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verify_policies</span> <span class="o">=</span> <span class="n">verify_policies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verify_rules</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="Rule.__hash__"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.scanner.audit.firewall_rules_engine.html#google.cloud.forseti.scanner.audit.firewall_rules_engine.Rule.__hash__">[docs]</a>    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Makes a hash of the rule id.</span>

<span class="sd">        Returns:</span>
<span class="sd">          int: The hash of the rule id.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span></div>

<div class="viewcode-block" id="Rule.from_config"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.scanner.audit.firewall_rules_engine.html#google.cloud.forseti.scanner.audit.firewall_rules_engine.Rule.from_config">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">rule_def</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates a Rule from a config file.</span>

<span class="sd">        Args:</span>
<span class="sd">          rule_def (dict): A dictionary rule definition parsed from YAML config.</span>

<span class="sd">        Returns:</span>
<span class="sd">          Rule: A rule created from the rule definition.</span>

<span class="sd">        Raises:</span>
<span class="sd">          InvalidRuleDefinition: If rule is missing required fields.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rule_id</span> <span class="o">=</span> <span class="n">rule_def</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rule_id&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rule_id</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidRuleDefinition</span><span class="p">(</span><span class="s1">&#39;Rule requires rule_id&#39;</span><span class="p">)</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="n">rule_def</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mode&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mode</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidRuleDefinition</span><span class="p">(</span><span class="s1">&#39;Rule requires mode&#39;</span><span class="p">)</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">VALID_RULE_MODES</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidRuleDefinition</span><span class="p">(</span><span class="s1">&#39;Mode </span><span class="si">%s</span><span class="s1"> is not in valid modes: </span><span class="si">%s</span><span class="s1">&#39;</span>
                                        <span class="o">%</span> <span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">VALID_RULE_MODES</span><span class="p">))</span>
        <span class="n">match_policies</span> <span class="o">=</span> <span class="n">rule_def</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;match_policies&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">verify_policies</span> <span class="o">=</span> <span class="n">rule_def</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;verify_policies&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;whitelist&#39;</span><span class="p">,</span> <span class="s1">&#39;blacklist&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">match_policies</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">verify_policies</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InvalidRuleDefinition</span><span class="p">(</span>
                    <span class="s1">&#39;Whitelist and blacklist rules require match and verify &#39;</span>
                    <span class="s1">&#39;policies&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;required&#39;</span><span class="p">,</span> <span class="s1">&#39;matches&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">match_policies</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InvalidRuleDefinition</span><span class="p">(</span>
                    <span class="s1">&#39;Required and matches rules require match policies&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verify_policies</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InvalidRuleDefinition</span><span class="p">(</span>
                    <span class="s1">&#39;Required and matches rules cannot have verify policies&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Rule</span><span class="p">(</span>
            <span class="n">rule_id</span><span class="o">=</span><span class="n">rule_id</span><span class="p">,</span>
            <span class="n">match_policies</span><span class="o">=</span><span class="n">match_policies</span><span class="p">,</span>
            <span class="n">verify_policies</span><span class="o">=</span><span class="n">verify_policies</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
            <span class="n">exact_match</span><span class="o">=</span><span class="n">rule_def</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;exact_match&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Rule.create_rules"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.scanner.audit.firewall_rules_engine.html#google.cloud.forseti.scanner.audit.firewall_rules_engine.Rule.create_rules">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">create_rules</span><span class="p">(</span><span class="n">policies</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates FirewallRules from policies.</span>

<span class="sd">        Args:</span>
<span class="sd">          policies (list): A list of policy dictionaries.</span>
<span class="sd">          validate (bool): Whether to validate that this is a valid firewall</span>
<span class="sd">            rule (one that can be passed to the API).</span>

<span class="sd">        Returns:</span>
<span class="sd">          list: A list of FirewallRule.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">match_rules</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">policy</span> <span class="ow">in</span> <span class="n">policies</span><span class="p">:</span>
            <span class="n">rule</span> <span class="o">=</span> <span class="n">firewall_rule</span><span class="o">.</span><span class="n">FirewallRule</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
                <span class="n">policy</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="n">validate</span><span class="p">)</span>
            <span class="n">match_rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">match_rules</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">match_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The FirewallRules used to filter policies.</span>

<span class="sd">        Returns:</span>
<span class="sd">          list: A list of FirewallRule.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match_rules</span><span class="p">:</span>
            <span class="n">validate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">in</span> <span class="p">{</span>
                <span class="n">scanner_rules</span><span class="o">.</span><span class="n">RuleMode</span><span class="o">.</span><span class="n">REQUIRED</span><span class="p">,</span>
                <span class="n">scanner_rules</span><span class="o">.</span><span class="n">RuleMode</span><span class="o">.</span><span class="n">MATCHES</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_match_rules</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_rules</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_match_policies</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="n">validate</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match_rules</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">verify_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The FirewallRules used to check policies.</span>

<span class="sd">        Returns:</span>
<span class="sd">          list: A list of FirewallRule.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verify_rules</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_verify_rules</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_rules</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify_policies</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verify_rules</span>

<div class="viewcode-block" id="Rule.find_violations"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.scanner.audit.firewall_rules_engine.html#google.cloud.forseti.scanner.audit.firewall_rules_engine.Rule.find_violations">[docs]</a>    <span class="k">def</span> <span class="nf">find_violations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">firewall_policies</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Finds policy violations in a list of firewall policies.</span>

<span class="sd">        Args:</span>
<span class="sd">          firewall_policies (list): A list of FirewallRule.</span>

<span class="sd">        Returns:</span>
<span class="sd">          iterable: A generator of RuleViolations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">scanner_rules</span><span class="o">.</span><span class="n">RuleMode</span><span class="o">.</span><span class="n">MATCHES</span><span class="p">:</span>
            <span class="n">violations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_yield_match_violations</span><span class="p">(</span><span class="n">firewall_policies</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">scanner_rules</span><span class="o">.</span><span class="n">RuleMode</span><span class="o">.</span><span class="n">REQUIRED</span><span class="p">:</span>
            <span class="n">violations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_yield_required_violations</span><span class="p">(</span><span class="n">firewall_policies</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">scanner_rules</span><span class="o">.</span><span class="n">RuleMode</span><span class="o">.</span><span class="n">WHITELIST</span><span class="p">:</span>
            <span class="n">violations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_yield_whitelist_violations</span><span class="p">(</span><span class="n">firewall_policies</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">scanner_rules</span><span class="o">.</span><span class="n">RuleMode</span><span class="o">.</span><span class="n">BLACKLIST</span><span class="p">:</span>
            <span class="n">violations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_yield_blacklist_violations</span><span class="p">(</span><span class="n">firewall_policies</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">violations</span></div>

<div class="viewcode-block" id="Rule._yield_match_violations"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.scanner.audit.firewall_rules_engine.html#google.cloud.forseti.scanner.audit.firewall_rules_engine.Rule._yield_match_violations">[docs]</a>    <span class="k">def</span> <span class="nf">_yield_match_violations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">firewall_policies</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Finds policies that don&#39;t match the required policy.</span>

<span class="sd">        Args:</span>
<span class="sd">          firewall_policies (list): A list of FirewallRules to check.</span>

<span class="sd">        Yields:</span>
<span class="sd">          iterable: A generator of RuleViolations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">inserts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="n">deletes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rule</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">match_rules</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">is_rule_exists_violation</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">firewall_policies</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">_exact_match</span><span class="p">):</span>
                <span class="n">inserts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: rule </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">policy</span> <span class="ow">in</span> <span class="n">firewall_policies</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_rule_exists_violation</span><span class="p">(</span><span class="n">policy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_rules</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">_exact_match</span><span class="p">):</span>
                <span class="n">deletes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">policy</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="n">updates</span> <span class="o">=</span> <span class="n">inserts</span> <span class="o">&amp;</span> <span class="n">deletes</span>
        <span class="n">inserts</span><span class="p">,</span> <span class="n">deletes</span> <span class="o">=</span> <span class="p">(</span><span class="n">inserts</span> <span class="o">-</span> <span class="n">updates</span><span class="p">,</span> <span class="n">deletes</span> <span class="o">-</span> <span class="n">updates</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">inserts</span> <span class="ow">or</span> <span class="n">deletes</span> <span class="ow">or</span> <span class="n">updates</span><span class="p">:</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_violation</span><span class="p">(</span>
                <span class="n">firewall_policies</span><span class="p">,</span> <span class="s1">&#39;FIREWALL_MATCHES_VIOLATION&#39;</span><span class="p">,</span>
                <span class="n">recommended_actions</span><span class="o">=</span><span class="p">{</span>
                    <span class="s1">&#39;INSERT_FIREWALL_RULES&#39;</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">inserts</span><span class="p">),</span>
                    <span class="s1">&#39;DELETE_FIREWALL_RULES&#39;</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">deletes</span><span class="p">),</span>
                    <span class="s1">&#39;UPDATE_FIREWALL_RULES&#39;</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">updates</span><span class="p">),</span>
                <span class="p">})</span></div>

<div class="viewcode-block" id="Rule._yield_required_violations"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.scanner.audit.firewall_rules_engine.html#google.cloud.forseti.scanner.audit.firewall_rules_engine.Rule._yield_required_violations">[docs]</a>    <span class="k">def</span> <span class="nf">_yield_required_violations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">firewall_policies</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Finds missing policies that are required.</span>

<span class="sd">        Args:</span>
<span class="sd">          firewall_policies (list): A list of FirewallRules to check.</span>

<span class="sd">        Yields:</span>
<span class="sd">          iterable: A generator of RuleViolations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rule</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">match_rules</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">is_rule_exists_violation</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">firewall_policies</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">_exact_match</span><span class="p">):</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_violation</span><span class="p">(</span>
                    <span class="n">firewall_policies</span><span class="p">,</span> <span class="s1">&#39;FIREWALL_REQUIRED_VIOLATION&#39;</span><span class="p">,</span>
                    <span class="n">recommended_actions</span><span class="o">=</span><span class="p">{</span>
                        <span class="s1">&#39;INSERT_FIREWALL_RULES&#39;</span><span class="p">:</span> <span class="p">[</span>
                            <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: rule </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                        <span class="p">],</span>
                    <span class="p">})</span></div>

<div class="viewcode-block" id="Rule._yield_whitelist_violations"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.scanner.audit.firewall_rules_engine.html#google.cloud.forseti.scanner.audit.firewall_rules_engine.Rule._yield_whitelist_violations">[docs]</a>    <span class="k">def</span> <span class="nf">_yield_whitelist_violations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">firewall_policies</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Finds policies that aren&#39;t whitelisted.</span>

<span class="sd">        Args:</span>
<span class="sd">          firewall_policies (list): A list of FirewallRules to check.</span>

<span class="sd">        Yields:</span>
<span class="sd">          iterable: A generator of RuleViolations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">policy</span> <span class="ow">in</span> <span class="n">firewall_policies</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">policy</span> <span class="o">&gt;</span> <span class="n">rule</span> <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_rules</span><span class="p">]):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">is_whitelist_violation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verify_rules</span><span class="p">,</span> <span class="n">policy</span><span class="p">):</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_violation</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">policy</span><span class="p">],</span> <span class="s1">&#39;FIREWALL_WHITELIST_VIOLATION&#39;</span><span class="p">,</span>
                    <span class="n">recommended_actions</span><span class="o">=</span><span class="p">{</span>
                        <span class="s1">&#39;DELETE_FIREWALL_RULES&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">policy</span><span class="o">.</span><span class="n">name</span><span class="p">],</span>
                    <span class="p">})</span></div>

<div class="viewcode-block" id="Rule._yield_blacklist_violations"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.scanner.audit.firewall_rules_engine.html#google.cloud.forseti.scanner.audit.firewall_rules_engine.Rule._yield_blacklist_violations">[docs]</a>    <span class="k">def</span> <span class="nf">_yield_blacklist_violations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">firewall_policies</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Finds blacklisted policies.</span>

<span class="sd">        Args:</span>
<span class="sd">          firewall_policies (list): A list of FirewallRules to check.</span>

<span class="sd">        Yields:</span>
<span class="sd">          iterable: A generator of RuleViolations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">policy</span> <span class="ow">in</span> <span class="n">firewall_policies</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">policy</span> <span class="o">&gt;</span> <span class="n">rule</span> <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_rules</span><span class="p">]):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">is_blacklist_violation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verify_rules</span><span class="p">,</span> <span class="n">policy</span><span class="p">):</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_violation</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">policy</span><span class="p">],</span> <span class="s1">&#39;FIREWALL_BLACKLIST_VIOLATION&#39;</span><span class="p">,</span>
                    <span class="n">recommended_actions</span><span class="o">=</span><span class="p">{</span>
                        <span class="s1">&#39;DELETE_FIREWALL_RULES&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">policy</span><span class="o">.</span><span class="n">name</span><span class="p">],</span>
                    <span class="p">})</span></div>

<div class="viewcode-block" id="Rule._create_violation"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.scanner.audit.firewall_rules_engine.html#google.cloud.forseti.scanner.audit.firewall_rules_engine.Rule._create_violation">[docs]</a>    <span class="k">def</span> <span class="nf">_create_violation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policies</span><span class="p">,</span> <span class="n">violation_type</span><span class="p">,</span>
                          <span class="n">recommended_actions</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates a RuleViolation.</span>

<span class="sd">        Args:</span>
<span class="sd">          policies (list): A list of FirewallRule that violate the policy.</span>
<span class="sd">          violation_type (str): The type of violation.</span>
<span class="sd">          recommended_actions (list): The list of actions to take.</span>

<span class="sd">        Returns:</span>
<span class="sd">          RuleViolation: A RuleViolation for the given policies.</span>

<span class="sd">        Raises:</span>
<span class="sd">          ValueError: If no policies are passed in.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">policies</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No policies in violation&#39;</span><span class="p">)</span>
        <span class="n">inventory_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">policy</span> <span class="ow">in</span> <span class="n">policies</span><span class="p">:</span>
            <span class="n">inventory_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">policy</span><span class="o">.</span><span class="n">as_json</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">RuleViolation</span><span class="p">(</span>
            <span class="n">resource_name</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">policies</span><span class="p">]),</span>
            <span class="n">resource_type</span><span class="o">=</span><span class="n">resource_mod</span><span class="o">.</span><span class="n">ResourceType</span><span class="o">.</span><span class="n">FIREWALL_RULE</span><span class="p">,</span>
            <span class="n">resource_id</span><span class="o">=</span><span class="n">policies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">project_id</span><span class="p">,</span>
            <span class="n">full_name</span><span class="o">=</span><span class="n">policies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span>
            <span class="n">rule_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">violation_type</span><span class="o">=</span><span class="n">violation_type</span><span class="p">,</span>
            <span class="n">policy_names</span><span class="o">=</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">policies</span><span class="p">],</span>
            <span class="n">recommended_actions</span><span class="o">=</span><span class="n">recommended_actions</span><span class="p">,</span>
            <span class="n">resource_data</span><span class="o">=</span><span class="n">inventory_data</span>
        <span class="p">)</span></div></div>


<span class="c1"># Rule violation.</span>
<span class="c1"># resource_type: string</span>
<span class="c1"># resource_id: string</span>
<span class="c1"># rule_name: string</span>
<span class="c1"># violation_type: FIREWALL_VIOLATION</span>
<span class="c1"># policy_names: string</span>
<span class="c1"># recommeded_action: string</span>
<span class="n">RuleViolation</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;RuleViolation&#39;</span><span class="p">,</span>
                           <span class="p">[</span><span class="s1">&#39;resource_type&#39;</span><span class="p">,</span> <span class="s1">&#39;resource_id&#39;</span><span class="p">,</span> <span class="s1">&#39;full_name&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;rule_id&#39;</span><span class="p">,</span> <span class="s1">&#39;violation_type&#39;</span><span class="p">,</span> <span class="s1">&#39;policy_names&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;recommended_actions&#39;</span><span class="p">,</span> <span class="s1">&#39;resource_data&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;resource_name&#39;</span><span class="p">])</span>


<div class="viewcode-block" id="is_whitelist_violation"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.scanner.audit.firewall_rules_engine.html#google.cloud.forseti.scanner.audit.firewall_rules_engine.is_whitelist_violation">[docs]</a><span class="k">def</span> <span class="nf">is_whitelist_violation</span><span class="p">(</span><span class="n">rules</span><span class="p">,</span> <span class="n">policy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Checks if the policy is not a subset of those allowed by the rules.</span>

<span class="sd">    Args:</span>
<span class="sd">      rules (list): A list of FirewallRule that the policy must be a subset of.</span>
<span class="sd">      policy (FirweallRule): A FirewallRule.</span>

<span class="sd">    Returns:</span>
<span class="sd">      bool: If the policy is a subset of one of the allowed rules or not.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">policy_subset_check</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">policy</span> <span class="o">&lt;</span> <span class="n">rule</span><span class="p">:</span>
            <span class="n">policy_subset_check</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">policy_subset_check</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">policy_subset_check</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="is_blacklist_violation"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.scanner.audit.firewall_rules_engine.html#google.cloud.forseti.scanner.audit.firewall_rules_engine.is_blacklist_violation">[docs]</a><span class="k">def</span> <span class="nf">is_blacklist_violation</span><span class="p">(</span><span class="n">rules</span><span class="p">,</span> <span class="n">policy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Checks if the policy is a superset of any not allowed by the rules.</span>

<span class="sd">    Args:</span>
<span class="sd">      rules (list): A list of FirewallRule that the policy must be a subset of.</span>
<span class="sd">      policy (FirweallRule): A FirewallRule.</span>

<span class="sd">    Returns:</span>
<span class="sd">      bool: If the policy is a superset of one of the blacklisted rules or not.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">policy_superset_check</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">policy</span> <span class="o">&gt;</span> <span class="n">rule</span><span class="p">:</span>
            <span class="n">policy_superset_check</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">policy_superset_check</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">policy_superset_check</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="is_rule_exists_violation"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.scanner.audit.firewall_rules_engine.html#google.cloud.forseti.scanner.audit.firewall_rules_engine.is_rule_exists_violation">[docs]</a><span class="k">def</span> <span class="nf">is_rule_exists_violation</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">policies</span><span class="p">,</span> <span class="n">exact_match</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Checks if the rule is the same as one of the policies.</span>

<span class="sd">    Args:</span>
<span class="sd">      rule (FirweallRule): A FirewallRule.</span>
<span class="sd">      policies (list): A list of FirewallRule that must have the rule.</span>
<span class="sd">      exact_match (bool): Whether to match the rule exactly.</span>

<span class="sd">    Returns:</span>
<span class="sd">      bool: If the required rule is in the policies.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">exact_match</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">policy</span> <span class="ow">in</span> <span class="n">policies</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">policy</span> <span class="o">==</span> <span class="n">rule</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">final_result</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">final_result</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">policy</span> <span class="ow">in</span> <span class="n">policies</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">policy</span><span class="o">.</span><span class="n">is_equilvalent</span><span class="p">(</span><span class="n">rule</span><span class="p">):</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">final_result</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">final_result</span></div>
</pre></div>
