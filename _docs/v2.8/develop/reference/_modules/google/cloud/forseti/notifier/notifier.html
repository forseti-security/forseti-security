---
layout: docs

title: "google.cloud.forseti.notifier.notifier"



hide:
  right_sidebar: true
---
<h1>Source code for google.cloud.forseti.notifier.notifier</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2017 The Forseti Security Authors. All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#    http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="sd">&quot;&quot;&quot;Notifier runner.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">inspect</span>

<span class="c1"># pylint: disable=line-too-long</span>
<span class="kn">from</span> <span class="nn">google.cloud.forseti.common.util</span> <span class="k">import</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">google.cloud.forseti.common.util</span> <span class="k">import</span> <span class="n">string_formats</span>
<span class="kn">from</span> <span class="nn">google.cloud.forseti.notifier.notifiers.base_notification</span> <span class="k">import</span> <span class="n">BaseNotification</span>
<span class="kn">from</span> <span class="nn">google.cloud.forseti.notifier.notifiers</span> <span class="k">import</span> <span class="n">cscc_notifier</span>
<span class="kn">from</span> <span class="nn">google.cloud.forseti.notifier.notifiers.inventory_summary</span> <span class="k">import</span> <span class="n">InventorySummary</span>
<span class="kn">from</span> <span class="nn">google.cloud.forseti.services.inventory.storage</span> <span class="k">import</span> <span class="n">DataAccess</span>
<span class="kn">from</span> <span class="nn">google.cloud.forseti.services.scanner</span> <span class="k">import</span> <span class="n">dao</span> <span class="k">as</span> <span class="n">scanner_dao</span>
<span class="c1"># pylint: enable=line-too-long</span>


<span class="n">LOGGER</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="c1"># pylint: disable=inconsistent-return-statements</span>
<div class="viewcode-block" id="find_notifiers"><a class="viewcode-back" href="../../../../../google.cloud.forseti.notifier.notifier.html#google.cloud.forseti.notifier.notifier.find_notifiers">[docs]</a><span class="k">def</span> <span class="nf">find_notifiers</span><span class="p">(</span><span class="n">notifier_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the first class in the given sub module</span>

<span class="sd">    Args:</span>
<span class="sd">        notifier_name (str): Name of the notifier.</span>

<span class="sd">    Return:</span>
<span class="sd">        class: The class in the sub module</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span>
            <span class="s1">&#39;google.cloud.forseti.notifier.notifiers.</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">notifier_name</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">module</span><span class="p">):</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> \
                    <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">BaseNotification</span><span class="p">)</span> \
                    <span class="ow">and</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">BaseNotification</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">obj</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Can</span><span class="se">\&#39;</span><span class="s1">t import notifier </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">notifier_name</span><span class="p">)</span></div>

<span class="c1"># pylint: enable=inconsistent-return-statements</span>


<div class="viewcode-block" id="convert_to_timestamp"><a class="viewcode-back" href="../../../../../google.cloud.forseti.notifier.notifier.html#google.cloud.forseti.notifier.notifier.convert_to_timestamp">[docs]</a><span class="k">def</span> <span class="nf">convert_to_timestamp</span><span class="p">(</span><span class="n">violations</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert violation created_at_datetime to timestamp string.</span>

<span class="sd">    Args:</span>
<span class="sd">        violations (dict): List of violations as dict with</span>
<span class="sd">            created_at_datetime.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: List of violations as dict with created_at_datetime</span>
<span class="sd">            converted to timestamp string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">violation</span> <span class="ow">in</span> <span class="n">violations</span><span class="p">:</span>
        <span class="n">violation</span><span class="p">[</span><span class="s1">&#39;created_at_datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">violation</span><span class="p">[</span><span class="s1">&#39;created_at_datetime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span>
                <span class="n">string_formats</span><span class="o">.</span><span class="n">TIMESTAMP_TIMEZONE</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">violations</span></div>


<span class="c1"># pylint: disable=too-many-branches,too-many-statements</span>
<div class="viewcode-block" id="run"><a class="viewcode-back" href="../../../../../google.cloud.forseti.notifier.notifier.html#google.cloud.forseti.notifier.notifier.run">[docs]</a><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">inventory_index_id</span><span class="p">,</span> <span class="n">progress_queue</span><span class="p">,</span> <span class="n">service_config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Run the notifier.</span>

<span class="sd">    Entry point when the notifier is run as a library.</span>

<span class="sd">    Args:</span>
<span class="sd">        inventory_index_id (int64): Inventory index id.</span>
<span class="sd">        progress_queue (Queue): The progress queue.</span>
<span class="sd">        service_config (ServiceConfig): Forseti 2.0 service configs.</span>
<span class="sd">    Returns:</span>
<span class="sd">        int: Status code.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=too-many-locals</span>
    <span class="n">global_configs</span> <span class="o">=</span> <span class="n">service_config</span><span class="o">.</span><span class="n">get_global_config</span><span class="p">()</span>
    <span class="n">notifier_configs</span> <span class="o">=</span> <span class="n">service_config</span><span class="o">.</span><span class="n">get_notifier_config</span><span class="p">()</span>

    <span class="n">violations</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">with</span> <span class="n">service_config</span><span class="o">.</span><span class="n">scoped_session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">inventory_index_id</span><span class="p">:</span>
            <span class="n">inventory_index_id</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">DataAccess</span><span class="o">.</span><span class="n">get_latest_inventory_index_id</span><span class="p">(</span><span class="n">session</span><span class="p">))</span>
        <span class="n">scanner_index_id</span> <span class="o">=</span> <span class="n">scanner_dao</span><span class="o">.</span><span class="n">get_latest_scanner_index_id</span><span class="p">(</span>
            <span class="n">session</span><span class="p">,</span> <span class="n">inventory_index_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">scanner_index_id</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;No success or partial success scanner index found for &#39;</span>
                <span class="s1">&#39;inventory index: &quot;</span><span class="si">%s</span><span class="s1">&quot;.&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">inventory_index_id</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># get violations</span>
            <span class="n">violation_access</span> <span class="o">=</span> <span class="n">scanner_dao</span><span class="o">.</span><span class="n">ViolationAccess</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
            <span class="n">violations</span> <span class="o">=</span> <span class="n">violation_access</span><span class="o">.</span><span class="n">list</span><span class="p">(</span>
                <span class="n">scanner_index_id</span><span class="o">=</span><span class="n">scanner_index_id</span><span class="p">)</span>
            <span class="n">violations_as_dict</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">violation</span> <span class="ow">in</span> <span class="n">violations</span><span class="p">:</span>
                <span class="n">violations_as_dict</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">scanner_dao</span><span class="o">.</span><span class="n">convert_sqlalchemy_object_to_dict</span><span class="p">(</span><span class="n">violation</span><span class="p">))</span>
            <span class="n">violations_as_dict</span> <span class="o">=</span> <span class="n">convert_to_timestamp</span><span class="p">(</span><span class="n">violations_as_dict</span><span class="p">)</span>
            <span class="n">violation_map</span> <span class="o">=</span> <span class="n">scanner_dao</span><span class="o">.</span><span class="n">map_by_resource</span><span class="p">(</span><span class="n">violations_as_dict</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">retrieved_v</span> <span class="ow">in</span> <span class="n">violation_map</span><span class="p">:</span>
                <span class="n">log_message</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s1">&#39;Retrieved </span><span class="si">{}</span><span class="s1"> violations for resource </span><span class="se">\&#39;</span><span class="si">{}</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="nb">len</span><span class="p">(</span><span class="n">violation_map</span><span class="p">[</span><span class="n">retrieved_v</span><span class="p">]),</span> <span class="n">retrieved_v</span><span class="p">))</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">log_message</span><span class="p">)</span>
                <span class="n">progress_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">log_message</span><span class="p">)</span>

            <span class="c1"># build notification notifiers</span>
            <span class="n">notifiers</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">resource</span> <span class="ow">in</span> <span class="n">notifier_configs</span><span class="p">[</span><span class="s1">&#39;resources&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">violation_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">resource</span><span class="p">[</span><span class="s1">&#39;resource&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">log_message</span> <span class="o">=</span> <span class="s1">&#39;Resource </span><span class="se">\&#39;</span><span class="si">{}</span><span class="se">\&#39;</span><span class="s1"> has no violations&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">resource</span><span class="p">[</span><span class="s1">&#39;resource&#39;</span><span class="p">])</span>
                    <span class="n">progress_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">log_message</span><span class="p">)</span>
                    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">log_message</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">resource</span><span class="p">[</span><span class="s1">&#39;should_notify&#39;</span><span class="p">]:</span>
                    <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Not notifying for: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">resource</span><span class="p">[</span><span class="s1">&#39;resource&#39;</span><span class="p">])</span>
                    <span class="k">continue</span>
                <span class="k">for</span> <span class="n">notifier</span> <span class="ow">in</span> <span class="n">resource</span><span class="p">[</span><span class="s1">&#39;notifiers&#39;</span><span class="p">]:</span>
                    <span class="n">log_message</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s1">&#39;Running </span><span class="se">\&#39;</span><span class="si">{}</span><span class="se">\&#39;</span><span class="s1"> notifier for resource </span><span class="se">\&#39;</span><span class="si">{}</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">notifier</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">resource</span><span class="p">[</span><span class="s1">&#39;resource&#39;</span><span class="p">]))</span>
                    <span class="n">progress_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">log_message</span><span class="p">)</span>
                    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">log_message</span><span class="p">)</span>
                    <span class="n">chosen_pipeline</span> <span class="o">=</span> <span class="n">find_notifiers</span><span class="p">(</span><span class="n">notifier</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
                    <span class="n">notifiers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chosen_pipeline</span><span class="p">(</span>
                        <span class="n">resource</span><span class="p">[</span><span class="s1">&#39;resource&#39;</span><span class="p">],</span> <span class="n">inventory_index_id</span><span class="p">,</span>
                        <span class="n">violation_map</span><span class="p">[</span><span class="n">resource</span><span class="p">[</span><span class="s1">&#39;resource&#39;</span><span class="p">]],</span> <span class="n">global_configs</span><span class="p">,</span>
                        <span class="n">notifier_configs</span><span class="p">,</span> <span class="n">notifier</span><span class="p">[</span><span class="s1">&#39;configuration&#39;</span><span class="p">]))</span>

            <span class="c1"># Run the notifiers.</span>
            <span class="k">for</span> <span class="n">notifier</span> <span class="ow">in</span> <span class="n">notifiers</span><span class="p">:</span>
                <span class="n">notifier</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

            <span class="c1"># Run the CSCC notifier.</span>
            <span class="n">violation_configs</span> <span class="o">=</span> <span class="n">notifier_configs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;violation&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">violation_configs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">violation_configs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cscc&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;enabled&#39;</span><span class="p">):</span>
                    <span class="n">source_id</span> <span class="o">=</span> <span class="n">violation_configs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cscc&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;source_id&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">source_id</span><span class="p">:</span>
                        <span class="c1"># beta mode</span>
                        <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="s1">&#39;Running CSCC notifier with beta API. source_id: &#39;</span>
                            <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">source_id</span><span class="p">)</span>
                        <span class="p">(</span><span class="n">cscc_notifier</span><span class="o">.</span><span class="n">CsccNotifier</span><span class="p">(</span><span class="n">inventory_index_id</span><span class="p">)</span>
                         <span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">violations_as_dict</span><span class="p">,</span> <span class="n">source_id</span><span class="o">=</span><span class="n">source_id</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># alpha mode</span>
                        <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Running CSCC notifier with alpha API.&#39;</span><span class="p">)</span>
                        <span class="n">gcs_path</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">violation_configs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cscc&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gcs_path&#39;</span><span class="p">))</span>
                        <span class="n">mode</span> <span class="o">=</span> <span class="n">violation_configs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cscc&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mode&#39;</span><span class="p">)</span>
                        <span class="n">organization_id</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">violation_configs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cscc&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                <span class="s1">&#39;organization_id&#39;</span><span class="p">))</span>
                        <span class="p">(</span><span class="n">cscc_notifier</span><span class="o">.</span><span class="n">CsccNotifier</span><span class="p">(</span><span class="n">inventory_index_id</span><span class="p">)</span>
                         <span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">violations_as_dict</span><span class="p">,</span> <span class="n">gcs_path</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span>
                              <span class="n">organization_id</span><span class="p">))</span>

        <span class="n">InventorySummary</span><span class="p">(</span><span class="n">service_config</span><span class="p">,</span> <span class="n">inventory_index_id</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        <span class="n">log_message</span> <span class="o">=</span> <span class="s1">&#39;Notification completed!&#39;</span>
        <span class="n">progress_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">log_message</span><span class="p">)</span>
        <span class="n">progress_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">log_message</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span></div>
    <span class="c1"># pylint: enable=too-many-branches,too-many-statements</span>
</pre></div>
