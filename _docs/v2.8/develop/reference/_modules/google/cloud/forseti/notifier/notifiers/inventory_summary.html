---
layout: docs

title: "google.cloud.forseti.notifier.notifiers.inventory_summary"



hide:
  right_sidebar: true
---
<h1>Source code for google.cloud.forseti.notifier.notifiers.inventory_summary</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2018 The Forseti Security Authors. All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#    http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="sd">&quot;&quot;&quot;Upload inventory summary to GCS.&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">googleapiclient.errors</span> <span class="k">import</span> <span class="n">HttpError</span>

<span class="c1"># pylint: disable=line-too-long</span>
<span class="kn">from</span> <span class="nn">google.cloud.forseti.common.util</span> <span class="k">import</span> <span class="n">date_time</span>
<span class="kn">from</span> <span class="nn">google.cloud.forseti.common.util</span> <span class="k">import</span> <span class="n">email</span>
<span class="kn">from</span> <span class="nn">google.cloud.forseti.common.util</span> <span class="k">import</span> <span class="n">errors</span> <span class="k">as</span> <span class="n">util_errors</span>
<span class="kn">from</span> <span class="nn">google.cloud.forseti.common.util</span> <span class="k">import</span> <span class="n">file_uploader</span>
<span class="kn">from</span> <span class="nn">google.cloud.forseti.common.util</span> <span class="k">import</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">google.cloud.forseti.common.util</span> <span class="k">import</span> <span class="n">string_formats</span>
<span class="kn">from</span> <span class="nn">google.cloud.forseti.notifier.notifiers.base_notification</span> <span class="k">import</span> <span class="n">BaseNotification</span>
<span class="kn">from</span> <span class="nn">google.cloud.forseti.services.inventory.storage</span> <span class="k">import</span> <span class="n">InventoryIndex</span>
<span class="c1"># pylint: enable=line-too-long</span>

<span class="n">LOGGER</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="InventorySummary"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.notifier.notifiers.inventory_summary.html#google.cloud.forseti.notifier.notifiers.inventory_summary.InventorySummary">[docs]</a><span class="k">class</span> <span class="nc">InventorySummary</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create and send inventory summary.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">service_config</span><span class="p">,</span> <span class="n">inventory_index_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialization.</span>

<span class="sd">        Args:</span>
<span class="sd">            inventory_index_id (int64): Inventory index id.</span>
<span class="sd">            service_config (ServiceConfig): Forseti 2.0 service configs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service_config</span> <span class="o">=</span> <span class="n">service_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inventory_index_id</span> <span class="o">=</span> <span class="n">inventory_index_id</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">notifier_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_config</span><span class="o">.</span><span class="n">get_notifier_config</span><span class="p">()</span>

<div class="viewcode-block" id="InventorySummary._get_output_filename"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.notifier.notifiers.inventory_summary.html#google.cloud.forseti.notifier.notifiers.inventory_summary.InventorySummary._get_output_filename">[docs]</a>    <span class="k">def</span> <span class="nf">_get_output_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename_template</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the output filename.</span>

<span class="sd">        Args:</span>
<span class="sd">            filename_template (string): template to use for the output filename</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The output filename for the inventory summary file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">utc_now_datetime</span> <span class="o">=</span> <span class="n">date_time</span><span class="o">.</span><span class="n">get_utc_now_datetime</span><span class="p">()</span>
        <span class="n">output_timestamp</span> <span class="o">=</span> <span class="n">utc_now_datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span>
            <span class="n">string_formats</span><span class="o">.</span><span class="n">TIMESTAMP_TIMEZONE_FILES</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">filename_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inventory_index_id</span><span class="p">),</span>
                                        <span class="n">output_timestamp</span><span class="p">)</span></div>

<div class="viewcode-block" id="InventorySummary._upload_to_gcs"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.notifier.notifiers.inventory_summary.html#google.cloud.forseti.notifier.notifiers.inventory_summary.InventorySummary._upload_to_gcs">[docs]</a>    <span class="k">def</span> <span class="nf">_upload_to_gcs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">summary_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Upload inventory summary to GCS.</span>

<span class="sd">        Args:</span>
<span class="sd">            summary_data (list): Summary of inventory data as a list of dicts.</span>
<span class="sd">                Example: [{resource_type, count}, {}, {}, ...]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Uploading inventory summary data to GCS.&#39;</span><span class="p">)</span>
        <span class="n">gcs_summary_config</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">notifier_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;inventory&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gcs_summary&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">gcs_summary_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gcs_path&#39;</span><span class="p">):</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;gcs_path not set for inventory summary notifier.&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">gcs_summary_config</span><span class="p">[</span><span class="s1">&#39;gcs_path&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;gs://&#39;</span><span class="p">):</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Invalid GCS path: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">gcs_summary_config</span><span class="p">[</span><span class="s1">&#39;gcs_path&#39;</span><span class="p">])</span>
            <span class="k">return</span>

        <span class="n">data_format</span> <span class="o">=</span> <span class="n">gcs_summary_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data_format&#39;</span><span class="p">,</span> <span class="s1">&#39;csv&#39;</span><span class="p">)</span>
        <span class="n">BaseNotification</span><span class="o">.</span><span class="n">check_data_format</span><span class="p">(</span><span class="n">data_format</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data_format</span> <span class="o">==</span> <span class="s1">&#39;csv&#39;</span><span class="p">:</span>
                <span class="n">gcs_upload_path</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">gcs_summary_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gcs_path&#39;</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_get_output_filename</span><span class="p">(</span>
                        <span class="n">string_formats</span><span class="o">.</span><span class="n">INVENTORY_SUMMARY_CSV_FMT</span><span class="p">))</span>
                <span class="n">file_uploader</span><span class="o">.</span><span class="n">upload_csv</span><span class="p">(</span>
                    <span class="s1">&#39;inv_summary&#39;</span><span class="p">,</span> <span class="n">summary_data</span><span class="p">,</span> <span class="n">gcs_upload_path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gcs_upload_path</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">gcs_summary_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gcs_path&#39;</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_get_output_filename</span><span class="p">(</span>
                        <span class="n">string_formats</span><span class="o">.</span><span class="n">INVENTORY_SUMMARY_JSON_FMT</span><span class="p">))</span>
                <span class="n">file_uploader</span><span class="o">.</span><span class="n">upload_json</span><span class="p">(</span><span class="n">summary_data</span><span class="p">,</span> <span class="n">gcs_upload_path</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">HttpError</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Unable to upload inventory summary in bucket </span><span class="si">%s</span><span class="s1">:&#39;</span><span class="p">,</span>
                             <span class="n">gcs_upload_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="InventorySummary._send_email"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.notifier.notifiers.inventory_summary.html#google.cloud.forseti.notifier.notifiers.inventory_summary.InventorySummary._send_email">[docs]</a>    <span class="k">def</span> <span class="nf">_send_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">summary_data</span><span class="p">,</span> <span class="n">details_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Send the email for inventory summary.</span>

<span class="sd">        Args:</span>
<span class="sd">            summary_data (list): Summary of inventory data as a list of dicts.</span>
<span class="sd">                Example: [{resource_type, count}, {}, {}, ...]</span>

<span class="sd">            details_data (list): Details of inventory data as a list of dicts.</span>
<span class="sd">                Example: [[{resource_type, count}, {}, {}, ...]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Sending inventory summary by email.&#39;</span><span class="p">)</span>

        <span class="n">email_summary_config</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">notifier_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;inventory&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email_summary&#39;</span><span class="p">))</span>

        <span class="n">email_util</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">EmailUtil</span><span class="p">(</span>
            <span class="n">email_summary_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sendgrid_api_key&#39;</span><span class="p">))</span>

        <span class="n">email_subject</span> <span class="o">=</span> <span class="s1">&#39;Inventory Summary: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inventory_index_id</span><span class="p">)</span>

        <span class="n">inventory_index_datetime</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">date_time</span><span class="o">.</span><span class="n">get_date_from_microtimestamp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inventory_index_id</span><span class="p">))</span>

        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">inventory_index_datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span>
            <span class="n">string_formats</span><span class="o">.</span><span class="n">DEFAULT_FORSETI_TIMESTAMP</span><span class="p">)</span>

        <span class="n">gsuite_dwd_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_gsuite_dwd_status</span><span class="p">(</span><span class="n">summary_data</span><span class="p">)</span>

        <span class="n">email_content</span> <span class="o">=</span> <span class="n">email_util</span><span class="o">.</span><span class="n">render_from_template</span><span class="p">(</span>
            <span class="s1">&#39;inventory_summary.jinja&#39;</span><span class="p">,</span>
            <span class="p">{</span><span class="s1">&#39;inventory_index_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory_index_id</span><span class="p">,</span>
             <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span>
             <span class="s1">&#39;gsuite_dwd_status&#39;</span><span class="p">:</span> <span class="n">gsuite_dwd_status</span><span class="p">,</span>
             <span class="s1">&#39;summary_data&#39;</span><span class="p">:</span> <span class="n">summary_data</span><span class="p">,</span>
             <span class="s1">&#39;details_data&#39;</span><span class="p">:</span> <span class="n">details_data</span><span class="p">})</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">email_util</span><span class="o">.</span><span class="n">send</span><span class="p">(</span>
                <span class="n">email_sender</span><span class="o">=</span><span class="n">email_summary_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sender&#39;</span><span class="p">),</span>
                <span class="n">email_recipient</span><span class="o">=</span><span class="n">email_summary_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;recipient&#39;</span><span class="p">),</span>
                <span class="n">email_subject</span><span class="o">=</span><span class="n">email_subject</span><span class="p">,</span>
                <span class="n">email_content</span><span class="o">=</span><span class="n">email_content</span><span class="p">,</span>
                <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;text/html&#39;</span><span class="p">)</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Inventory summary sent successfully by email.&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">util_errors</span><span class="o">.</span><span class="n">EmailSendError</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Unable to send inventory summary email&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="InventorySummary.transform_to_template"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.notifier.notifiers.inventory_summary.html#google.cloud.forseti.notifier.notifiers.inventory_summary.InventorySummary.transform_to_template">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">transform_to_template</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper method to return sorted list of dicts.</span>

<span class="sd">        Args:</span>
<span class="sd">            data (dict): dictionary of resource_type: count pairs.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: Sorted data as a list of dicts.</span>
<span class="sd">                Example: [{resource_type, count}, {}, {}, ...]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">template_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">template_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">resource_type</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">value</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">template_data</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">k</span><span class="p">[</span><span class="s1">&#39;resource_type&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="InventorySummary._get_gsuite_dwd_status"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.notifier.notifiers.inventory_summary.html#google.cloud.forseti.notifier.notifiers.inventory_summary.InventorySummary._get_gsuite_dwd_status">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_gsuite_dwd_status</span><span class="p">(</span><span class="n">summary_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the status of whether G Suite DwD is enabled or not.</span>

<span class="sd">        Args:</span>
<span class="sd">            summary_data (list): Summary of inventory data as a list of dicts.</span>
<span class="sd">                Example: [{resource_type, count}, {}, {}, ...]</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: disabled or enabled.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gsuite_types</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;gsuite_user&#39;</span><span class="p">])</span>
        <span class="n">summary_data_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">summary_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;disabled&#39;</span>

        <span class="k">for</span> <span class="n">resource</span> <span class="ow">in</span> <span class="n">summary_data</span><span class="p">:</span>
            <span class="n">summary_data_keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">resource</span><span class="p">[</span><span class="s1">&#39;resource_type&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">gsuite_types</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">summary_data_keys</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;enabled&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;disabled&#39;</span></div>

<div class="viewcode-block" id="InventorySummary._get_summary_data"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.notifier.notifiers.inventory_summary.html#google.cloud.forseti.notifier.notifiers.inventory_summary.InventorySummary._get_summary_data">[docs]</a>    <span class="k">def</span> <span class="nf">_get_summary_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the summarized inventory data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: Summary of sorted inventory data as a list of dicts.</span>
<span class="sd">                Example: [{resource_type, count}, {}, {}, ...]</span>

<span class="sd">        Raises:</span>
<span class="sd">            NoDataError: If summary data is not found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Getting inventory summary data.&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_config</span><span class="o">.</span><span class="n">scoped_session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">inventory_index</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">InventoryIndex</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inventory_index_id</span><span class="p">))</span>

            <span class="n">summary</span> <span class="o">=</span> <span class="n">inventory_index</span><span class="o">.</span><span class="n">get_summary</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">summary</span><span class="p">:</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;No inventory summary data found for inventory &#39;</span>
                             <span class="s1">&#39;index id: </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory_index_id</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">util_errors</span><span class="o">.</span><span class="n">NoDataError</span>

            <span class="n">summary_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_to_template</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">summary_data</span></div>

<div class="viewcode-block" id="InventorySummary._get_details_data"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.notifier.notifiers.inventory_summary.html#google.cloud.forseti.notifier.notifiers.inventory_summary.InventorySummary._get_details_data">[docs]</a>    <span class="k">def</span> <span class="nf">_get_details_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the detailed summarized inventory data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: Summary details of sorted inventory data as a list of dicts.</span>
<span class="sd">                Example: [{resource_type, count}, {}, {}, ...]</span>

<span class="sd">        Raises:</span>
<span class="sd">            NoDataError: If summary details data is not found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Getting inventory summary details data.&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_config</span><span class="o">.</span><span class="n">scoped_session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">inventory_index</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">InventoryIndex</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inventory_index_id</span><span class="p">))</span>

            <span class="n">details</span> <span class="o">=</span> <span class="n">inventory_index</span><span class="o">.</span><span class="n">get_details</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">details</span><span class="p">:</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;No inventory summary detail data found for &#39;</span>
                             <span class="s1">&#39;inventory index id: </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inventory_index_id</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">util_errors</span><span class="o">.</span><span class="n">NoDataError</span>

            <span class="n">details_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_to_template</span><span class="p">(</span><span class="n">details</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">details_data</span></div>

<div class="viewcode-block" id="InventorySummary.run"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.notifier.notifiers.inventory_summary.html#google.cloud.forseti.notifier.notifiers.inventory_summary.InventorySummary.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate inventory summary.&quot;&quot;&quot;</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Running inventory summary notifier.&#39;</span><span class="p">)</span>

        <span class="n">inventory_notifier_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">notifier_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;inventory&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">inventory_notifier_config</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No inventory configuration for notifier.&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">is_gcs_summary_enabled</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">inventory_notifier_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gcs_summary&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;enabled&#39;</span><span class="p">))</span>
            <span class="n">is_email_summary_enabled</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">inventory_notifier_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email_summary&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;enabled&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s1">&#39;Inventory summary can not be created because unable to get &#39;</span>
                <span class="s1">&#39;inventory summary configuration.&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_gcs_summary_enabled</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_email_summary_enabled</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;All inventory summaries are disabled.&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">summary_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_summary_data</span><span class="p">()</span>
            <span class="n">details_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_details_data</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">util_errors</span><span class="o">.</span><span class="n">NoDataError</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Inventory summary can not be created because &#39;</span>
                             <span class="s1">&#39;no summary data is found for index id: </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">inventory_index_id</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">is_gcs_summary_enabled</span><span class="p">:</span>
            <span class="n">summary_and_details_data</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">((</span><span class="n">summary_data</span> <span class="o">+</span> <span class="n">details_data</span><span class="p">),</span>
                                              <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">k</span><span class="p">[</span><span class="s1">&#39;resource_type&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_upload_to_gcs</span><span class="p">(</span><span class="n">summary_and_details_data</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_email_summary_enabled</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_send_email</span><span class="p">(</span><span class="n">summary_data</span><span class="p">,</span> <span class="n">details_data</span><span class="p">)</span>

        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Completed running inventory summary.&#39;</span><span class="p">)</span></div></div>
</pre></div>
