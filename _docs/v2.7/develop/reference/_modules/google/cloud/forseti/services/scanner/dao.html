---
layout: docs

title: "google.cloud.forseti.services.scanner.dao"



hide:
  right_sidebar: true
---
<h1>Source code for google.cloud.forseti.services.scanner.dao</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2017 The Forseti Security Authors. All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#    http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="sd">&quot;&quot;&quot; Database access objects for Forseti Scanner. &quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">defaultdict</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">BigInteger</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">Column</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">DateTime</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">Integer</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">String</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">Text</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">and_</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">inspect</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="k">import</span> <span class="n">declarative_base</span>

<span class="kn">from</span> <span class="nn">google.cloud.forseti.common.data_access</span> <span class="k">import</span> <span class="n">violation_map</span> <span class="k">as</span> <span class="n">vm</span>
<span class="kn">from</span> <span class="nn">google.cloud.forseti.common.util</span> <span class="k">import</span> <span class="n">date_time</span>
<span class="kn">from</span> <span class="nn">google.cloud.forseti.common.util</span> <span class="k">import</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">google.cloud.forseti.common.util.index_state</span> <span class="k">import</span> <span class="n">IndexState</span>

<span class="n">LOGGER</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">BASE</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>
<span class="n">CURRENT_SCHEMA</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">SUCCESS_STATES</span> <span class="o">=</span> <span class="p">[</span><span class="n">IndexState</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">,</span> <span class="n">IndexState</span><span class="o">.</span><span class="n">PARTIAL_SUCCESS</span><span class="p">]</span>


<div class="viewcode-block" id="ScannerIndex"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.scanner.dao.html#google.cloud.forseti.services.scanner.dao.ScannerIndex">[docs]</a><span class="k">class</span> <span class="nc">ScannerIndex</span><span class="p">(</span><span class="n">BASE</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represents a scanner run.&quot;&quot;&quot;</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;scanner_index&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">BigInteger</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">inventory_index_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">BigInteger</span><span class="p">)</span>
    <span class="n">created_at_datetime</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">())</span>
    <span class="n">completed_at_datetime</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">())</span>
    <span class="n">scanner_status</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Text</span><span class="p">())</span>
    <span class="n">schema_version</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">())</span>
    <span class="n">scanner_index_warnings</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Text</span><span class="p">(</span><span class="mi">16777215</span><span class="p">))</span>
    <span class="n">scanner_index_errors</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Text</span><span class="p">())</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Text</span><span class="p">())</span>

<div class="viewcode-block" id="ScannerIndex.__repr__"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.scanner.dao.html#google.cloud.forseti.services.scanner.dao.ScannerIndex.__repr__">[docs]</a>    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Object string representation.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: String representation of the object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;&quot;&lt;</span><span class="si">{}</span><span class="s2">(id=&#39;</span><span class="si">{}</span><span class="s2">&#39;, version=&#39;</span><span class="si">{}</span><span class="s2">&#39;, timestamp=&#39;</span><span class="si">{}</span><span class="s2">&#39;)&gt;&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">schema_version</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">created_at_datetime</span><span class="p">)</span></div>

<div class="viewcode-block" id="ScannerIndex.create"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.scanner.dao.html#google.cloud.forseti.services.scanner.dao.ScannerIndex.create">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">inv_index_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new scanner index row.</span>

<span class="sd">        Args:</span>
<span class="sd">            inv_index_id (str): Id of the inventory index.</span>

<span class="sd">        Returns:</span>
<span class="sd">            object: ScannerIndex row object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">utc_now</span> <span class="o">=</span> <span class="n">date_time</span><span class="o">.</span><span class="n">get_utc_now_datetime</span><span class="p">()</span>
        <span class="n">micro_timestamp</span> <span class="o">=</span> <span class="n">date_time</span><span class="o">.</span><span class="n">get_utc_now_microtimestamp</span><span class="p">(</span><span class="n">utc_now</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ScannerIndex</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="n">micro_timestamp</span><span class="p">,</span>
            <span class="n">inventory_index_id</span><span class="o">=</span><span class="n">inv_index_id</span><span class="p">,</span>
            <span class="n">created_at_datetime</span><span class="o">=</span><span class="n">utc_now</span><span class="p">,</span>
            <span class="n">scanner_status</span><span class="o">=</span><span class="n">IndexState</span><span class="o">.</span><span class="n">CREATED</span><span class="p">,</span>
            <span class="n">schema_version</span><span class="o">=</span><span class="n">CURRENT_SCHEMA</span><span class="p">)</span></div>

<div class="viewcode-block" id="ScannerIndex.complete"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.scanner.dao.html#google.cloud.forseti.services.scanner.dao.ScannerIndex.complete">[docs]</a>    <span class="k">def</span> <span class="nf">complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">IndexState</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Mark the scanner as completed with a final scanner_status.</span>

<span class="sd">        Args:</span>
<span class="sd">            status (str): Final scanner_status.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">completed_at_datetime</span> <span class="o">=</span> <span class="n">date_time</span><span class="o">.</span><span class="n">get_utc_now_datetime</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scanner_status</span> <span class="o">=</span> <span class="n">status</span></div>

<div class="viewcode-block" id="ScannerIndex.add_warning"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.scanner.dao.html#google.cloud.forseti.services.scanner.dao.ScannerIndex.add_warning">[docs]</a>    <span class="k">def</span> <span class="nf">add_warning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">warning</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a warning to the scanner.</span>

<span class="sd">        Args:</span>
<span class="sd">            session (object): session object to work on.</span>
<span class="sd">            warning (str): Warning message</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">warning_message</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">warning</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">scanner_index_warnings</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scanner_index_warnings</span> <span class="o">=</span> <span class="n">warning_message</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scanner_index_warnings</span> <span class="o">+=</span> <span class="n">warning_message</span>
        <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>

<div class="viewcode-block" id="ScannerIndex.set_error"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.scanner.dao.html#google.cloud.forseti.services.scanner.dao.ScannerIndex.set_error">[docs]</a>    <span class="k">def</span> <span class="nf">set_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Indicate a broken scanner run.</span>

<span class="sd">        Args:</span>
<span class="sd">            session (object): session object to work on.</span>
<span class="sd">            message (str): Error message to set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scanner_index_errors</span> <span class="o">=</span> <span class="n">message</span>
        <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="get_latest_scanner_index_id"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.scanner.dao.html#google.cloud.forseti.services.scanner.dao.get_latest_scanner_index_id">[docs]</a><span class="k">def</span> <span class="nf">get_latest_scanner_index_id</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">inv_index_id</span><span class="p">,</span> <span class="n">index_state</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return last `ScannerIndex` row with the given state or `None`.</span>

<span class="sd">    Either return the latest `ScannerIndex` row where the `scanner_status`</span>
<span class="sd">    matches the given `index_state` parameter (if passed) or the latest row</span>
<span class="sd">    that represents a (partially) successful scanner run.</span>

<span class="sd">    Args:</span>
<span class="sd">        session (object): session object to work on.</span>
<span class="sd">        inv_index_id (str): Id of the inventory index.</span>
<span class="sd">        index_state (str): we want the latest `ScannerIndex` with this state</span>

<span class="sd">    Returns:</span>
<span class="sd">        sqlalchemy_object: the latest `ScannerIndex` row or `None`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">scanner_index</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">index_state</span><span class="p">:</span>
        <span class="n">scanner_index</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">ScannerIndex</span><span class="p">)</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">and_</span><span class="p">(</span>
                <span class="n">ScannerIndex</span><span class="o">.</span><span class="n">scanner_status</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">SUCCESS_STATES</span><span class="p">),</span>
                <span class="n">ScannerIndex</span><span class="o">.</span><span class="n">inventory_index_id</span> <span class="o">==</span> <span class="n">inv_index_id</span><span class="p">))</span>
            <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">ScannerIndex</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span><span class="n">first</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">scanner_index</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">ScannerIndex</span><span class="p">)</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">and_</span><span class="p">(</span>
                <span class="n">ScannerIndex</span><span class="o">.</span><span class="n">scanner_status</span> <span class="o">==</span> <span class="n">index_state</span><span class="p">,</span>
                <span class="n">ScannerIndex</span><span class="o">.</span><span class="n">inventory_index_id</span> <span class="o">==</span> <span class="n">inv_index_id</span><span class="p">))</span>
            <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">ScannerIndex</span><span class="o">.</span><span class="n">created_at_datetime</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span><span class="n">first</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">scanner_index</span><span class="o">.</span><span class="n">id</span> <span class="k">if</span> <span class="n">scanner_index</span> <span class="k">else</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Violation"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.scanner.dao.html#google.cloud.forseti.services.scanner.dao.Violation">[docs]</a><span class="k">class</span> <span class="nc">Violation</span><span class="p">(</span><span class="n">BASE</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Row entry for a violation.&quot;&quot;&quot;</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;violations&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">created_at_datetime</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">())</span>
    <span class="n">full_name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">1024</span><span class="p">))</span>
    <span class="n">resource_data</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Text</span><span class="p">(</span><span class="mi">16777215</span><span class="p">))</span>
    <span class="n">resource_name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">resource_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">resource_type</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">rule_index</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">rule_name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">256</span><span class="p">))</span>
    <span class="n">scanner_index_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">BigInteger</span><span class="p">)</span>
    <span class="n">violation_data</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Text</span><span class="p">)</span>
    <span class="n">violation_hash</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">256</span><span class="p">))</span>
    <span class="n">violation_type</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<div class="viewcode-block" id="Violation.__repr__"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.scanner.dao.html#google.cloud.forseti.services.scanner.dao.Violation.__repr__">[docs]</a>    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: string representation of the Violation row entry.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">string</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;&lt;Violation(violation_type=</span><span class="si">{}</span><span class="s1">, resource_type=</span><span class="si">{}</span><span class="s1"> &#39;</span>
                  <span class="s1">&#39;rule_name=</span><span class="si">{}</span><span class="s1">)&gt;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">violation_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule_name</span><span class="p">)</span></div>

<div class="viewcode-block" id="Violation.get_schema_update_actions"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.scanner.dao.html#google.cloud.forseti.services.scanner.dao.Violation.get_schema_update_actions">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_schema_update_actions</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;Maintain all the schema changes for this table.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A mapping of Action: Column.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">columns_to_create</span> <span class="o">=</span> <span class="p">[</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;resource_name&#39;</span><span class="p">,</span>
                                    <span class="n">String</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span>
                                    <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)]</span>

        <span class="n">schema_update_actions</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;CREATE&#39;</span><span class="p">:</span> <span class="n">columns_to_create</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">schema_update_actions</span></div></div>


<div class="viewcode-block" id="ViolationAccess"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.scanner.dao.html#google.cloud.forseti.services.scanner.dao.ViolationAccess">[docs]</a><span class="k">class</span> <span class="nc">ViolationAccess</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Facade for violations, implement APIs against violations table.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor for the Violation Access.</span>

<span class="sd">        Args:</span>
<span class="sd">            session (Session): SQLAlchemy session object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>

<div class="viewcode-block" id="ViolationAccess.create"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.scanner.dao.html#google.cloud.forseti.services.scanner.dao.ViolationAccess.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">violations</span><span class="p">,</span> <span class="n">scanner_index_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save violations to the db table.</span>

<span class="sd">        Args:</span>
<span class="sd">            violations (list): A list of violations.</span>
<span class="sd">            scanner_index_id (int): id of the `ScannerIndex` row for this</span>
<span class="sd">                scanner run.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">created_at_datetime</span> <span class="o">=</span> <span class="n">date_time</span><span class="o">.</span><span class="n">get_utc_now_datetime</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">violation</span> <span class="ow">in</span> <span class="n">violations</span><span class="p">:</span>
            <span class="n">violation_hash</span> <span class="o">=</span> <span class="n">_create_violation_hash</span><span class="p">(</span>
                <span class="n">violation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;full_name&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                <span class="n">violation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;resource_data&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                <span class="n">violation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;violation_data&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
            <span class="p">)</span>

            <span class="n">violation</span> <span class="o">=</span> <span class="n">Violation</span><span class="p">(</span>
                <span class="n">created_at_datetime</span><span class="o">=</span><span class="n">created_at_datetime</span><span class="p">,</span>
                <span class="n">full_name</span><span class="o">=</span><span class="n">violation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;full_name&#39;</span><span class="p">),</span>
                <span class="n">resource_data</span><span class="o">=</span><span class="n">violation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;resource_data&#39;</span><span class="p">),</span>
                <span class="n">resource_name</span><span class="o">=</span><span class="n">violation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;resource_name&#39;</span><span class="p">),</span>
                <span class="n">resource_id</span><span class="o">=</span><span class="n">violation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;resource_id&#39;</span><span class="p">),</span>
                <span class="n">resource_type</span><span class="o">=</span><span class="n">violation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;resource_type&#39;</span><span class="p">),</span>
                <span class="n">rule_index</span><span class="o">=</span><span class="n">violation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rule_index&#39;</span><span class="p">),</span>
                <span class="n">rule_name</span><span class="o">=</span><span class="n">violation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rule_name&#39;</span><span class="p">),</span>
                <span class="n">scanner_index_id</span><span class="o">=</span><span class="n">scanner_index_id</span><span class="p">,</span>
                <span class="n">violation_data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                    <span class="n">violation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;violation_data&#39;</span><span class="p">)),</span>
                <span class="n">violation_hash</span><span class="o">=</span><span class="n">violation_hash</span><span class="p">,</span>
                <span class="n">violation_type</span><span class="o">=</span><span class="n">violation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;violation_type&#39;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">violation</span><span class="p">)</span></div>

<div class="viewcode-block" id="ViolationAccess.list"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.scanner.dao.html#google.cloud.forseti.services.scanner.dao.ViolationAccess.list">[docs]</a>    <span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inv_index_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scanner_index_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List all violations from the db table.</span>

<span class="sd">        If</span>
<span class="sd">            * neither index is passed we return all violations.</span>
<span class="sd">            * the `inv_index_id` is passed the violations from all scanner</span>
<span class="sd">              runs for that inventory index will be returned.</span>
<span class="sd">            * the `scanner_index_id` is passed the violations from that</span>
<span class="sd">              specific scanner run will be returned.</span>

<span class="sd">        NOTA BENE: do *NOT* call this method with both indices!</span>

<span class="sd">        Args:</span>
<span class="sd">            inv_index_id (str): Id of the inventory index.</span>
<span class="sd">            scanner_index_id (int): Id of the scanner index.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: List of Violation row entry objects.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: if called with both the inventory and the scanner index</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">inv_index_id</span> <span class="ow">or</span> <span class="n">scanner_index_id</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Violation</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">inv_index_id</span> <span class="ow">and</span> <span class="n">scanner_index_id</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Please call list() with the inventory index XOR the scanner &#39;</span>
                <span class="s1">&#39;index, not both.&#39;</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">inv_index_id</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Violation</span><span class="p">,</span> <span class="n">ScannerIndex</span><span class="p">)</span>
                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">and_</span><span class="p">(</span>
                    <span class="n">ScannerIndex</span><span class="o">.</span><span class="n">scanner_status</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">SUCCESS_STATES</span><span class="p">),</span>
                    <span class="n">ScannerIndex</span><span class="o">.</span><span class="n">inventory_index_id</span> <span class="o">==</span> <span class="n">inv_index_id</span><span class="p">))</span>
                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Violation</span><span class="o">.</span><span class="n">scanner_index_id</span> <span class="o">==</span> <span class="n">ScannerIndex</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="o">.</span><span class="n">all</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">scanner_index_id</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Violation</span><span class="p">,</span> <span class="n">ScannerIndex</span><span class="p">)</span>
                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">and_</span><span class="p">(</span>
                    <span class="n">ScannerIndex</span><span class="o">.</span><span class="n">scanner_status</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">SUCCESS_STATES</span><span class="p">),</span>
                    <span class="n">ScannerIndex</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">scanner_index_id</span><span class="p">))</span>
                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Violation</span><span class="o">.</span><span class="n">scanner_index_id</span> <span class="o">==</span> <span class="n">ScannerIndex</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="o">.</span><span class="n">all</span><span class="p">())</span>

        <span class="n">violations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">violation</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">violations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">violation</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">violations</span></div></div>


<span class="c1"># pylint: disable=invalid-name</span>
<div class="viewcode-block" id="convert_sqlalchemy_object_to_dict"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.scanner.dao.html#google.cloud.forseti.services.scanner.dao.convert_sqlalchemy_object_to_dict">[docs]</a><span class="k">def</span> <span class="nf">convert_sqlalchemy_object_to_dict</span><span class="p">(</span><span class="n">sqlalchemy_obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert a sqlalchemy row/record object to a dictionary.</span>

<span class="sd">    Args:</span>
<span class="sd">        sqlalchemy_obj (sqlalchemy_object): A sqlalchemy row/record object</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dict of sqlalchemy object&#39;s attributes.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="p">{</span><span class="n">c</span><span class="o">.</span><span class="n">key</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sqlalchemy_obj</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inspect</span><span class="p">(</span><span class="n">sqlalchemy_obj</span><span class="p">)</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">column_attrs</span><span class="p">}</span></div>


<div class="viewcode-block" id="map_by_resource"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.scanner.dao.html#google.cloud.forseti.services.scanner.dao.map_by_resource">[docs]</a><span class="k">def</span> <span class="nf">map_by_resource</span><span class="p">(</span><span class="n">violation_rows</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a map of violation types to violations of that resource.</span>

<span class="sd">    Args:</span>
<span class="sd">        violation_rows (list): A list of dict of violation data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dict of violation types mapped to the list of corresponding</span>
<span class="sd">            violation types, i.e. { resource =&gt; [violation_data...] }.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># The defaultdict makes it easy to add a value to a key without having</span>
    <span class="c1"># to check if the key exists.</span>
    <span class="n">v_by_type</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">v_data</span> <span class="ow">in</span> <span class="n">violation_rows</span><span class="p">:</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">v_data</span><span class="p">[</span><span class="s1">&#39;violation_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">v_data</span><span class="p">[</span><span class="s1">&#39;violation_data&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Invalid violation data, unable to parse json for </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="n">v_data</span><span class="p">[</span><span class="s1">&#39;violation_data&#39;</span><span class="p">])</span>

        <span class="c1"># resource_data can be regular python string</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">v_data</span><span class="p">[</span><span class="s1">&#39;resource_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">v_data</span><span class="p">[</span><span class="s1">&#39;resource_data&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">v_data</span><span class="p">[</span><span class="s1">&#39;resource_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">v_data</span><span class="p">[</span><span class="s1">&#39;resource_data&#39;</span><span class="p">]))</span>

        <span class="n">v_resource</span> <span class="o">=</span> <span class="n">vm</span><span class="o">.</span><span class="n">VIOLATION_RESOURCES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">v_data</span><span class="p">[</span><span class="s1">&#39;violation_type&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">v_resource</span><span class="p">:</span>
            <span class="n">v_by_type</span><span class="p">[</span><span class="n">v_resource</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v_data</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">v_by_type</span><span class="p">)</span></div>


<div class="viewcode-block" id="_create_violation_hash"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.scanner.dao.html#google.cloud.forseti.services.scanner.dao._create_violation_hash">[docs]</a><span class="k">def</span> <span class="nf">_create_violation_hash</span><span class="p">(</span><span class="n">violation_full_name</span><span class="p">,</span> <span class="n">resource_data</span><span class="p">,</span> <span class="n">violation_data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a hash of violation data.</span>

<span class="sd">    Args:</span>
<span class="sd">        violation_full_name (str): The full name of the violation.</span>
<span class="sd">        resource_data (str): The inventory data.</span>
<span class="sd">        violation_data (dict): A violation.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The resulting hex digest or &#39;&#39; if we can&#39;t successfully create</span>
<span class="sd">        a hash.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># TODO: Intelligently choose from hashlib.algorithms_guaranteed if our</span>
    <span class="c1"># desired one is not available.</span>
    <span class="n">algorithm</span> <span class="o">=</span> <span class="s1">&#39;sha512&#39;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">violation_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">algorithm</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Cannot create hash for a violation with algorithm: &#39;</span>
                         <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">algorithm</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Group resources do not have full name.  Issue #1072</span>
        <span class="n">violation_hash</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">violation_full_name</span><span class="p">)</span> <span class="o">+</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">resource_data</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">+</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">violation_data</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Cannot create hash for a violation: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                         <span class="n">violation_full_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>

    <span class="k">return</span> <span class="n">violation_hash</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span></div>


<div class="viewcode-block" id="initialize"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.scanner.dao.html#google.cloud.forseti.services.scanner.dao.initialize">[docs]</a><span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">engine</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create all tables in the database if not existing.</span>

<span class="sd">    Args:</span>
<span class="sd">        engine (object): Database engine to operate on.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create tables if not exists.</span>
    <span class="n">BASE</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span></div>
</pre></div>
