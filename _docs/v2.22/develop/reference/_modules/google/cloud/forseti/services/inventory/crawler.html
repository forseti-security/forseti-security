---
layout: docs

title: "google.cloud.forseti.services.inventory.crawler"



hide:
  right_sidebar: true
---
<h1>Source code for google.cloud.forseti.services.inventory.crawler</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2017 The Forseti Security Authors. All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#    http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="sd">&quot;&quot;&quot;Crawler implementation.&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">builtins</span> <span class="k">import</span> <span class="nb">str</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="k">import</span> <span class="nb">range</span>
<span class="kn">from</span> <span class="nn">queue</span> <span class="k">import</span> <span class="n">Empty</span>
<span class="kn">from</span> <span class="nn">queue</span> <span class="k">import</span> <span class="n">Queue</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">future</span> <span class="k">import</span> <span class="n">standard_library</span>
<span class="kn">from</span> <span class="nn">google.cloud.forseti.common.util</span> <span class="k">import</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">google.cloud.forseti.services.inventory.base</span> <span class="k">import</span> <span class="n">cai_gcp_client</span>
<span class="kn">from</span> <span class="nn">google.cloud.forseti.services.inventory.base</span> <span class="k">import</span> <span class="n">cloudasset</span>
<span class="kn">from</span> <span class="nn">google.cloud.forseti.services.inventory.base</span> <span class="k">import</span> <span class="n">crawler</span>
<span class="kn">from</span> <span class="nn">google.cloud.forseti.services.inventory.base</span> <span class="k">import</span> <span class="n">gcp</span>
<span class="kn">from</span> <span class="nn">google.cloud.forseti.services.inventory.base</span> <span class="k">import</span> <span class="n">resources</span>

<span class="n">standard_library</span><span class="o">.</span><span class="n">install_aliases</span><span class="p">()</span>

<span class="n">LOGGER</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="CrawlerConfig"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.crawler.html#google.cloud.forseti.services.inventory.crawler.CrawlerConfig">[docs]</a><span class="k">class</span> <span class="nc">CrawlerConfig</span><span class="p">(</span><span class="n">crawler</span><span class="o">.</span><span class="n">CrawlerConfig</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Crawler configuration to inject dependencies.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">storage</span><span class="p">,</span> <span class="n">progresser</span><span class="p">,</span> <span class="n">api_client</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize</span>

<span class="sd">        Args:</span>
<span class="sd">            storage (Storage): The inventory storage</span>
<span class="sd">            progresser (QueueProgresser): The progresser implemented using</span>
<span class="sd">                a queue</span>
<span class="sd">            api_client (ApiClientImpl): GCP API client</span>
<span class="sd">            variables (dict): config variables</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CrawlerConfig</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage</span> <span class="o">=</span> <span class="n">storage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progresser</span> <span class="o">=</span> <span class="n">progresser</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variables</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">variables</span> <span class="k">else</span> <span class="n">variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">api_client</span></div>


<div class="viewcode-block" id="ParallelCrawlerConfig"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.crawler.html#google.cloud.forseti.services.inventory.crawler.ParallelCrawlerConfig">[docs]</a><span class="k">class</span> <span class="nc">ParallelCrawlerConfig</span><span class="p">(</span><span class="n">crawler</span><span class="o">.</span><span class="n">CrawlerConfig</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Multithreaded crawler configuration, to inject dependencies.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">storage</span><span class="p">,</span> <span class="n">progresser</span><span class="p">,</span> <span class="n">api_client</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                 <span class="n">variables</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize</span>

<span class="sd">        Args:</span>
<span class="sd">            storage (Storage): The inventory storage</span>
<span class="sd">            progresser (QueueProgresser): The progresser implemented using</span>
<span class="sd">                a queue</span>
<span class="sd">            api_client (ApiClientImpl): GCP API client</span>
<span class="sd">            threads (int): how many threads to use</span>
<span class="sd">            variables (dict): config variables</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ParallelCrawlerConfig</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage</span> <span class="o">=</span> <span class="n">storage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progresser</span> <span class="o">=</span> <span class="n">progresser</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variables</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">variables</span> <span class="k">else</span> <span class="n">variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threads</span> <span class="o">=</span> <span class="n">threads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">api_client</span></div>


<div class="viewcode-block" id="Crawler"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.crawler.html#google.cloud.forseti.services.inventory.crawler.Crawler">[docs]</a><span class="k">class</span> <span class="nc">Crawler</span><span class="p">(</span><span class="n">crawler</span><span class="o">.</span><span class="n">Crawler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Simple single-threaded Crawler implementation.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize</span>

<span class="sd">        Args:</span>
<span class="sd">            config (CrawlerConfig): The crawler configuration</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Crawler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>

<div class="viewcode-block" id="Crawler.run"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.crawler.html#google.cloud.forseti.services.inventory.crawler.Crawler.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run the crawler, given a start resource.</span>

<span class="sd">        Args:</span>
<span class="sd">            resource (object): Resource to start with.</span>

<span class="sd">        Returns:</span>
<span class="sd">            QueueProgresser: The filled progresser described in inventory</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">resource</span><span class="o">.</span><span class="n">accept</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">progresser</span></div>

<div class="viewcode-block" id="Crawler.visit"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.crawler.html#google.cloud.forseti.services.inventory.crawler.Crawler.visit">[docs]</a>    <span class="k">def</span> <span class="nf">visit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle a newly found resource.</span>

<span class="sd">        Args:</span>
<span class="sd">            resource (object): Resource to handle.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: Reraises any exception.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">progresser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">progresser</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="n">resource</span><span class="o">.</span><span class="n">get_iam_policy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_client</span><span class="p">())</span>
            <span class="n">resource</span><span class="o">.</span><span class="n">get_gcs_policy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_client</span><span class="p">())</span>
            <span class="n">resource</span><span class="o">.</span><span class="n">get_dataset_policy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_client</span><span class="p">())</span>
            <span class="n">resource</span><span class="o">.</span><span class="n">get_cloudsql_policy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_client</span><span class="p">())</span>
            <span class="n">resource</span><span class="o">.</span><span class="n">get_billing_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_client</span><span class="p">())</span>
            <span class="n">resource</span><span class="o">.</span><span class="n">get_enabled_apis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_client</span><span class="p">())</span>
            <span class="n">resource</span><span class="o">.</span><span class="n">get_kubernetes_service_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_client</span><span class="p">())</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">progresser</span><span class="o">.</span><span class="n">on_error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">progresser</span><span class="o">.</span><span class="n">on_new_object</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span></div>

<div class="viewcode-block" id="Crawler.dispatch"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.crawler.html#google.cloud.forseti.services.inventory.crawler.Crawler.dispatch">[docs]</a>    <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dispatch crawling of a subtree.</span>

<span class="sd">        Args:</span>
<span class="sd">            callback (function): Callback to dispatch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">callback</span><span class="p">()</span></div>

<div class="viewcode-block" id="Crawler.write"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.crawler.html#google.cloud.forseti.services.inventory.crawler.Crawler.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save resource to storage.</span>

<span class="sd">        Args:</span>
<span class="sd">            resource (object): Resource to handle.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span></div>

<div class="viewcode-block" id="Crawler.get_client"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.crawler.html#google.cloud.forseti.services.inventory.crawler.Crawler.get_client">[docs]</a>    <span class="k">def</span> <span class="nf">get_client</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the GCP API client.</span>

<span class="sd">        Returns:</span>
<span class="sd">            object: GCP API client</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">client</span></div>

<div class="viewcode-block" id="Crawler.on_child_error"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.crawler.html#google.cloud.forseti.services.inventory.crawler.Crawler.on_child_error">[docs]</a>    <span class="k">def</span> <span class="nf">on_child_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process the error generated by child of a resource</span>

<span class="sd">           Inventory does not stop for children errors but raise a warning</span>

<span class="sd">        Args:</span>
<span class="sd">            error (str): error message to handle</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">warning_message</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">warning_message</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">progresser</span><span class="o">.</span><span class="n">on_warning</span><span class="p">(</span><span class="n">error</span><span class="p">)</span></div>

<div class="viewcode-block" id="Crawler.update"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.crawler.html#google.cloud.forseti.services.inventory.crawler.Crawler.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the row of an existing resource</span>

<span class="sd">        Args:</span>
<span class="sd">            resource (Resource): Resource to update.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: Reraises any exception.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">progresser</span><span class="o">.</span><span class="n">on_error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span></div></div>


<div class="viewcode-block" id="ParallelCrawler"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.crawler.html#google.cloud.forseti.services.inventory.crawler.ParallelCrawler">[docs]</a><span class="k">class</span> <span class="nc">ParallelCrawler</span><span class="p">(</span><span class="n">Crawler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Multi-threaded Crawler implementation.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize</span>

<span class="sd">        Args:</span>
<span class="sd">            config (ParallelCrawlerConfig): The crawler configuration</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ParallelCrawler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dispatch_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_event</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>

<div class="viewcode-block" id="ParallelCrawler._start_workers"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.crawler.html#google.cloud.forseti.services.inventory.crawler.ParallelCrawler._start_workers">[docs]</a>    <span class="k">def</span> <span class="nf">_start_workers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Start a pool of worker threads for processing the dispatch queue.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_event</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">threads</span><span class="p">):</span>
            <span class="n">worker</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_process_queue</span><span class="p">)</span>
            <span class="n">worker</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">worker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>

<div class="viewcode-block" id="ParallelCrawler._process_queue"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.crawler.html#google.cloud.forseti.services.inventory.crawler.ParallelCrawler._process_queue">[docs]</a>    <span class="k">def</span> <span class="nf">_process_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process items in the queue until the shutdown event is set.&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">callback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dispatch_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">callback</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dispatch_queue</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span></div>

<div class="viewcode-block" id="ParallelCrawler.run"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.crawler.html#google.cloud.forseti.services.inventory.crawler.ParallelCrawler.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run the crawler, given a start resource.</span>

<span class="sd">        Args:</span>
<span class="sd">            resource (Resource): Resource to start with.</span>

<span class="sd">        Returns:</span>
<span class="sd">            QueueProgresser: The filled progresser described in inventory</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_start_workers</span><span class="p">()</span>
            <span class="n">resource</span><span class="o">.</span><span class="n">accept</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dispatch_queue</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
            <span class="c1"># Wait for threads to exit.</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">progresser</span></div>

<div class="viewcode-block" id="ParallelCrawler.dispatch"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.crawler.html#google.cloud.forseti.services.inventory.crawler.ParallelCrawler.dispatch">[docs]</a>    <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dispatch crawling of a subtree.</span>

<span class="sd">        Args:</span>
<span class="sd">            callback (function): Callback to dispatch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dispatch_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span></div>

<div class="viewcode-block" id="ParallelCrawler.write"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.crawler.html#google.cloud.forseti.services.inventory.crawler.ParallelCrawler.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save resource to storage.</span>

<span class="sd">        Args:</span>
<span class="sd">            resource (Resource): Resource to handle.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span></div>

<div class="viewcode-block" id="ParallelCrawler.on_child_error"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.crawler.html#google.cloud.forseti.services.inventory.crawler.ParallelCrawler.on_child_error">[docs]</a>    <span class="k">def</span> <span class="nf">on_child_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process the error generated by child of a resource</span>

<span class="sd">           Inventory does not stop for children errors but raise a warning</span>

<span class="sd">        Args:</span>
<span class="sd">            error (str): error message to handle</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">warning_message</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">warning_message</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">progresser</span><span class="o">.</span><span class="n">on_warning</span><span class="p">(</span><span class="n">error</span><span class="p">)</span></div>

<div class="viewcode-block" id="ParallelCrawler.update"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.crawler.html#google.cloud.forseti.services.inventory.crawler.ParallelCrawler.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the row of an existing resource</span>

<span class="sd">        Args:</span>
<span class="sd">            resource (Resource): The db row of Resource to update</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: Reraises any exception.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_lock</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">progresser</span><span class="o">.</span><span class="n">on_error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span></div></div>


<div class="viewcode-block" id="_api_client_factory"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.crawler.html#google.cloud.forseti.services.inventory.crawler._api_client_factory">[docs]</a><span class="k">def</span> <span class="nf">_api_client_factory</span><span class="p">(</span><span class="n">storage</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">parallel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates the proper initialized API client based on the configuration.</span>

<span class="sd">    Args:</span>
<span class="sd">        storage (object): Storage implementation to use.</span>
<span class="sd">        config (object): Inventory configuration on server.</span>
<span class="sd">        parallel (bool): If true, use the parallel crawler implementation.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Union[gcp.ApiClientImpl, cai_gcp_client.CaiApiClientImpl]:</span>
<span class="sd">            The initialized api client implementation class.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">client_config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_api_quota_configs</span><span class="p">()</span>
    <span class="n">client_config</span><span class="p">[</span><span class="s1">&#39;domain_super_admin_email&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_gsuite_admin_email</span><span class="p">()</span>
    <span class="n">client_config</span><span class="p">[</span><span class="s1">&#39;excluded_resources&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_excluded_resources</span><span class="p">()</span>
    <span class="n">asset_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get_cai_enabled</span><span class="p">():</span>
        <span class="c1"># TODO: When CAI supports resource exclusion, update the following</span>
        <span class="c1">#       method to handle resource exclusion during export time.</span>
        <span class="n">asset_count</span> <span class="o">=</span> <span class="n">cloudasset</span><span class="o">.</span><span class="n">load_cloudasset_data</span><span class="p">(</span><span class="n">storage</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> total assets loaded from Cloud Asset data.&#39;</span><span class="p">,</span>
                    <span class="n">asset_count</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">asset_count</span><span class="p">:</span>
        <span class="n">engine</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_service_config</span><span class="p">()</span><span class="o">.</span><span class="n">get_engine</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">cai_gcp_client</span><span class="o">.</span><span class="n">CaiApiClientImpl</span><span class="p">(</span><span class="n">client_config</span><span class="p">,</span>
                                               <span class="n">engine</span><span class="p">,</span>
                                               <span class="n">parallel</span><span class="p">,</span>
                                               <span class="n">storage</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>

    <span class="c1"># Default to the non-CAI implementation</span>
    <span class="k">return</span> <span class="n">gcp</span><span class="o">.</span><span class="n">ApiClientImpl</span><span class="p">(</span><span class="n">client_config</span><span class="p">)</span></div>


<div class="viewcode-block" id="_crawler_factory"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.crawler.html#google.cloud.forseti.services.inventory.crawler._crawler_factory">[docs]</a><span class="k">def</span> <span class="nf">_crawler_factory</span><span class="p">(</span><span class="n">storage</span><span class="p">,</span> <span class="n">progresser</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">parallel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates the proper initialized crawler based on the configuration.</span>

<span class="sd">    Args:</span>
<span class="sd">        storage (object): Storage implementation to use.</span>
<span class="sd">        progresser (object): Progresser to notify status updates.</span>
<span class="sd">        client (object): The API client instance.</span>
<span class="sd">        parallel (bool): If true, use the parallel crawler implementation.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Union[Crawler, ParallelCrawler]:</span>
<span class="sd">            The initialized crawler implementation class.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">excluded_resources</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;excluded_resources&#39;</span><span class="p">,</span> <span class="p">[]))</span>
    <span class="n">config_variables</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;excluded_resources&#39;</span><span class="p">:</span> <span class="n">excluded_resources</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">parallel</span><span class="p">:</span>
        <span class="n">parallel_config</span> <span class="o">=</span> <span class="n">ParallelCrawlerConfig</span><span class="p">(</span><span class="n">storage</span><span class="p">,</span>
                                                <span class="n">progresser</span><span class="p">,</span>
                                                <span class="n">client</span><span class="p">,</span>
                                                <span class="n">variables</span><span class="o">=</span><span class="n">config_variables</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ParallelCrawler</span><span class="p">(</span><span class="n">parallel_config</span><span class="p">)</span>

    <span class="c1"># Default to the non-parallel crawler</span>
    <span class="n">crawler_config</span> <span class="o">=</span> <span class="n">CrawlerConfig</span><span class="p">(</span><span class="n">storage</span><span class="p">,</span>
                                   <span class="n">progresser</span><span class="p">,</span>
                                   <span class="n">client</span><span class="p">,</span>
                                   <span class="n">variables</span><span class="o">=</span><span class="n">config_variables</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Crawler</span><span class="p">(</span><span class="n">crawler_config</span><span class="p">)</span></div>


<div class="viewcode-block" id="_root_resource_factory"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.crawler.html#google.cloud.forseti.services.inventory.crawler._root_resource_factory">[docs]</a><span class="k">def</span> <span class="nf">_root_resource_factory</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">client</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates the proper initialized crawler based on the configuration.</span>

<span class="sd">    Args:</span>
<span class="sd">        config (object): Inventory configuration on server.</span>
<span class="sd">        client (object): The API client instance.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Resource: The initialized root resource.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">use_composite_root</span><span class="p">():</span>
        <span class="n">composite_root_resources</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_composite_root_resources</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">resources</span><span class="o">.</span><span class="n">CompositeRootResource</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">composite_root_resources</span><span class="p">)</span>

    <span class="c1"># Default is a single resource as root.</span>
    <span class="k">return</span> <span class="n">resources</span><span class="o">.</span><span class="n">from_root_id</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">get_root_resource_id</span><span class="p">())</span></div>


<div class="viewcode-block" id="run_crawler"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.crawler.html#google.cloud.forseti.services.inventory.crawler.run_crawler">[docs]</a><span class="k">def</span> <span class="nf">run_crawler</span><span class="p">(</span><span class="n">storage</span><span class="p">,</span>
                <span class="n">progresser</span><span class="p">,</span>
                <span class="n">config</span><span class="p">,</span>
                <span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Run the crawler with a determined configuration.</span>

<span class="sd">    Args:</span>
<span class="sd">        storage (object): Storage implementation to use.</span>
<span class="sd">        progresser (object): Progresser to notify status updates.</span>
<span class="sd">        config (object): Inventory configuration on server.</span>
<span class="sd">        parallel (bool): If true, use the parallel crawler implementation.</span>

<span class="sd">    Returns:</span>
<span class="sd">        QueueProgresser: The progresser implemented in inventory</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">parallel</span> <span class="ow">and</span> <span class="s1">&#39;sqlite&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get_service_config</span><span class="p">()</span><span class="o">.</span><span class="n">get_engine</span><span class="p">()):</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;SQLite used, disabling parallel threads.&#39;</span><span class="p">)</span>
        <span class="n">parallel</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">client</span> <span class="o">=</span> <span class="n">_api_client_factory</span><span class="p">(</span><span class="n">storage</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">parallel</span><span class="p">)</span>
    <span class="n">crawler_impl</span> <span class="o">=</span> <span class="n">_crawler_factory</span><span class="p">(</span><span class="n">storage</span><span class="p">,</span> <span class="n">progresser</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">parallel</span><span class="p">)</span>
    <span class="n">resource</span> <span class="o">=</span> <span class="n">_root_resource_factory</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">client</span><span class="p">)</span>

    <span class="n">progresser</span> <span class="o">=</span> <span class="n">crawler_impl</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
    <span class="c1"># flush the buffer at the end to make sure nothing is cached.</span>
    <span class="n">storage</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">progresser</span></div>
</pre></div>
