---
layout: docs

title: "google.cloud.forseti.scanner.scanners.config_validator_scanner"



hide:
  right_sidebar: true
---
<h1>Source code for google.cloud.forseti.scanner.scanners.config_validator_scanner</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2019 The Forseti Security Authors. All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#    http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="sd">&quot;&quot;&quot;Config Validator Scanner.&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">google.protobuf</span> <span class="k">import</span> <span class="n">json_format</span>

<span class="kn">from</span> <span class="nn">google.cloud.forseti.common.util</span> <span class="k">import</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">google.cloud.forseti.scanner.scanners</span> <span class="k">import</span> <span class="n">base_scanner</span>
<span class="kn">from</span> <span class="nn">google.cloud.forseti.scanner.scanners.config_validator_util</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">cv_data_converter</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">google.cloud.forseti.scanner.scanners.config_validator_util</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">validator_client</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">google.cloud.forseti.services.model.importer</span> <span class="k">import</span> <span class="n">importer</span>


<span class="n">LOGGER</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="ConfigValidatorScanner"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.scanner.scanners.config_validator_scanner.html#google.cloud.forseti.scanner.scanners.config_validator_scanner.ConfigValidatorScanner">[docs]</a><span class="k">class</span> <span class="nc">ConfigValidatorScanner</span><span class="p">(</span><span class="n">base_scanner</span><span class="o">.</span><span class="n">BaseScanner</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Config Validator Scanner.&quot;&quot;&quot;</span>

    <span class="n">VIOLATION_TYPE</span> <span class="o">=</span> <span class="s1">&#39;CONFIG_VALIDATOR_VIOLATION&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">global_configs</span><span class="p">,</span> <span class="n">scanner_configs</span><span class="p">,</span> <span class="n">service_config</span><span class="p">,</span>
                 <span class="n">model_name</span><span class="p">,</span> <span class="n">snapshot_timestamp</span><span class="p">,</span> <span class="n">rules</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor for the base pipeline.</span>

<span class="sd">         Args:</span>
<span class="sd">             global_configs (dict): Global configurations.</span>
<span class="sd">             scanner_configs (dict): Scanner configurations.</span>
<span class="sd">             service_config (ServiceConfig): Service configuration.</span>
<span class="sd">             model_name (str): name of the data model</span>
<span class="sd">             snapshot_timestamp (str): Timestamp, formatted as YYYYMMDDTHHMMSSZ.</span>
<span class="sd">             rules (str): Fully-qualified path and filename of the rules file.</span>
<span class="sd">         &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ConfigValidatorScanner</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">global_configs</span><span class="p">,</span> <span class="n">scanner_configs</span><span class="p">,</span> <span class="n">service_config</span><span class="p">,</span>
            <span class="n">model_name</span><span class="p">,</span> <span class="n">snapshot_timestamp</span><span class="p">,</span> <span class="n">rules</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validator_client</span> <span class="o">=</span> <span class="n">validator_client</span><span class="o">.</span><span class="n">ValidatorClient</span><span class="p">()</span>

        <span class="c1"># Maps CAI resource name-&gt; (full_name, resource_data).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resource_lookup_table</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="ConfigValidatorScanner._flatten_violations"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.scanner.scanners.config_validator_scanner.html#google.cloud.forseti.scanner.scanners.config_validator_scanner.ConfigValidatorScanner._flatten_violations">[docs]</a>    <span class="k">def</span> <span class="nf">_flatten_violations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">violations</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Flatten Config Validator violations into a dict for each violation.</span>

<span class="sd">        Args:</span>
<span class="sd">            violations (list): The Config Validator violations to flatten.</span>

<span class="sd">        Yields:</span>
<span class="sd">            dict: Iterator of Config Validator violations</span>
<span class="sd">                as a dict per violation.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">violation</span> <span class="ow">in</span> <span class="n">violations</span><span class="p">:</span>
            <span class="n">resource_id</span> <span class="o">=</span> <span class="n">violation</span><span class="o">.</span><span class="n">resource</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">full_name</span><span class="p">,</span> <span class="n">resource_type</span><span class="p">,</span> <span class="n">resource_data</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resource_lookup_table</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">violation</span><span class="o">.</span><span class="n">resource</span><span class="p">,</span>
                                               <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)))</span>
            <span class="k">yield</span> <span class="p">{</span>
                <span class="s1">&#39;resource_id&#39;</span><span class="p">:</span> <span class="n">resource_id</span><span class="p">,</span>
                <span class="s1">&#39;resource_type&#39;</span><span class="p">:</span> <span class="n">resource_type</span><span class="p">,</span>
                <span class="s1">&#39;resource_name&#39;</span><span class="p">:</span> <span class="n">violation</span><span class="o">.</span><span class="n">resource</span><span class="p">,</span>
                <span class="s1">&#39;full_name&#39;</span><span class="p">:</span> <span class="n">full_name</span><span class="p">,</span>
                <span class="s1">&#39;rule_index&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;rule_name&#39;</span><span class="p">:</span> <span class="n">violation</span><span class="o">.</span><span class="n">constraint</span><span class="p">,</span>
                <span class="s1">&#39;violation_type&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">VIOLATION_TYPE</span><span class="p">,</span>
                <span class="s1">&#39;violation_data&#39;</span><span class="p">:</span> <span class="n">json_format</span><span class="o">.</span><span class="n">MessageToDict</span><span class="p">(</span>
                    <span class="n">violation</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="n">including_default_value_fields</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                <span class="s1">&#39;resource_data&#39;</span><span class="p">:</span> <span class="n">resource_data</span><span class="p">,</span>
                <span class="s1">&#39;violation_message&#39;</span><span class="p">:</span> <span class="n">violation</span><span class="o">.</span><span class="n">message</span>
            <span class="p">}</span></div>

<div class="viewcode-block" id="ConfigValidatorScanner._output_results"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.scanner.scanners.config_validator_scanner.html#google.cloud.forseti.scanner.scanners.config_validator_scanner.ConfigValidatorScanner._output_results">[docs]</a>    <span class="k">def</span> <span class="nf">_output_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">all_violations</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Output results.</span>

<span class="sd">        Args:</span>
<span class="sd">            all_violations (List[RuleViolation]): A list of</span>
<span class="sd">                flattened Config Validator violations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_output_results_to_db</span><span class="p">(</span><span class="n">all_violations</span><span class="p">)</span></div>

<div class="viewcode-block" id="ConfigValidatorScanner._retrieve"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.scanner.scanners.config_validator_scanner.html#google.cloud.forseti.scanner.scanners.config_validator_scanner.ConfigValidatorScanner._retrieve">[docs]</a>    <span class="k">def</span> <span class="nf">_retrieve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iam_policy</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieves the data for scanner.</span>

<span class="sd">        If iam_policy is not set, it will retrieve all the resources</span>
<span class="sd">        except iam policies.</span>

<span class="sd">        Args:</span>
<span class="sd">            iam_policy (bool): Retrieve iam policies only if set to true.</span>

<span class="sd">        Yields:</span>
<span class="sd">            Asset: Config Validator Asset.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: if resources have an unexpected type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model_manager</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_config</span><span class="o">.</span><span class="n">model_manager</span>
        <span class="n">scoped_session</span><span class="p">,</span> <span class="n">data_access</span> <span class="o">=</span> <span class="n">model_manager</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">iam_policy</span><span class="p">:</span>
            <span class="n">resource_types</span> <span class="o">=</span> <span class="n">importer</span><span class="o">.</span><span class="n">GCP_TYPE_LIST</span>
            <span class="n">data_type</span> <span class="o">=</span> <span class="s1">&#39;resource&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">resource_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;iam_policy&#39;</span><span class="p">]</span>
            <span class="n">data_type</span> <span class="o">=</span> <span class="s1">&#39;iam_policy&#39;</span>

        <span class="c1"># Clean up the resource look up table to release memory and</span>
        <span class="c1"># avoid confusion.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resource_lookup_table</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">with</span> <span class="n">scoped_session</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="c1"># fetching GCP resources based on their types.</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Retrieving GCP </span><span class="si">%s</span><span class="s1"> data.&#39;</span><span class="p">,</span> <span class="n">data_type</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">resource_type</span> <span class="ow">in</span> <span class="n">resource_types</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">resource</span> <span class="ow">in</span> <span class="n">data_access</span><span class="o">.</span><span class="n">scanner_iter</span><span class="p">(</span><span class="n">session</span><span class="p">,</span>
                                                         <span class="n">resource_type</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">resource</span><span class="o">.</span><span class="n">cai_resource_name</span> <span class="ow">and</span>
                            <span class="n">resource</span><span class="o">.</span><span class="n">type</span> <span class="ow">not</span> <span class="ow">in</span>
                            <span class="n">cv_data_converter</span><span class="o">.</span><span class="n">CAI_RESOURCE_TYPE_MAPPING</span><span class="p">):</span>
                        <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Resource type </span><span class="si">%s</span><span class="s1"> is not currently &#39;</span>
                                     <span class="s1">&#39;supported in Config Validator scanner.&#39;</span><span class="p">,</span>
                                     <span class="n">resource</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">resource_lookup_table</span><span class="p">[</span><span class="n">resource</span><span class="o">.</span><span class="n">cai_resource_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">resource</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span>
                        <span class="n">resource</span><span class="o">.</span><span class="n">cai_resource_type</span><span class="p">,</span>
                        <span class="n">resource</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                    <span class="k">yield</span> <span class="n">cv_data_converter</span><span class="o">.</span><span class="n">convert_data_to_cv_asset</span><span class="p">(</span>
                        <span class="n">resource</span><span class="p">,</span> <span class="n">data_type</span><span class="p">)</span></div>

<div class="viewcode-block" id="ConfigValidatorScanner._retrieve_flattened_violations"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.scanner.scanners.config_validator_scanner.html#google.cloud.forseti.scanner.scanners.config_validator_scanner.ConfigValidatorScanner._retrieve_flattened_violations">[docs]</a>    <span class="k">def</span> <span class="nf">_retrieve_flattened_violations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iam_policy</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieve flattened violations by flattening the config validator</span>
<span class="sd">        violations returned by the config validator client.</span>

<span class="sd">        If iam_policy is not set, it will retrieve violations from all resources</span>
<span class="sd">        except iam policies.</span>

<span class="sd">        Args:</span>
<span class="sd">            iam_policy (bool): Retrieve flattened IAM policy violations.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: A list of flattened violations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Clean up the validator environment by doing a reset pre audit.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validator_client</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

        <span class="c1"># Get all the data in Config Validator Asset format.</span>
        <span class="n">cv_assets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retrieve</span><span class="p">(</span><span class="n">iam_policy</span><span class="o">=</span><span class="n">iam_policy</span><span class="p">)</span>

        <span class="c1"># Add asset data in bulk to Config Validator.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validator_client</span><span class="o">.</span><span class="n">add_data_in_bulk</span><span class="p">(</span><span class="n">cv_assets</span><span class="p">)</span>

        <span class="c1"># Find all violations.</span>
        <span class="n">violations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validator_client</span><span class="o">.</span><span class="n">audit</span><span class="p">()</span>

        <span class="c1"># Clean up the validator environment by doing a reset post audit.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validator_client</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_flatten_violations</span><span class="p">(</span><span class="n">violations</span><span class="p">))</span></div>

<div class="viewcode-block" id="ConfigValidatorScanner.run"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.scanner.scanners.config_validator_scanner.html#google.cloud.forseti.scanner.scanners.config_validator_scanner.ConfigValidatorScanner.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Runs the Config Validator Scanner.</span>

<span class="sd">        Note: Resources and iam policies audit are separated into 2 steps.</span>
<span class="sd">        That&#39;s mainly because there is no good way of identifying from config</span>
<span class="sd">        validator validation whether a violation is an iam policy violation or</span>
<span class="sd">        a resource violation, the resource name for both will be the same and</span>
<span class="sd">        it will be hard for Forseti to retrieve the right resource_data for the</span>
<span class="sd">        corresponding violation types.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: break up the _retrieve_flattened_violations method.</span>
        <span class="c1"># Retrieving resource violations.</span>
        <span class="n">all_violations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retrieve_flattened_violations</span><span class="p">()</span>

        <span class="c1"># Retrieving iam violations.</span>
        <span class="n">all_violations</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_retrieve_flattened_violations</span><span class="p">(</span><span class="n">iam_policy</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

        <span class="c1"># Output all violations to db.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_output_results</span><span class="p">(</span><span class="n">all_violations</span><span class="p">)</span></div></div>
</pre></div>
