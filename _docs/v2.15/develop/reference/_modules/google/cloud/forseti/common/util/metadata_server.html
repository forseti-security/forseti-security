---
layout: docs

title: "google.cloud.forseti.common.util.metadata_server"



hide:
  right_sidebar: true
---
<h1>Source code for google.cloud.forseti.common.util.metadata_server</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2017 The Forseti Security Authors. All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#    http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="sd">&quot;&quot;&quot;Metadata server utilities.</span>

<span class="sd">The metadata server is only accessible on GCE.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">httplib</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">socket</span>

<span class="kn">from</span> <span class="nn">google.cloud.forseti.common.util</span> <span class="k">import</span> <span class="n">errors</span>
<span class="kn">from</span> <span class="nn">google.cloud.forseti.common.util</span> <span class="k">import</span> <span class="n">logger</span>

<span class="c1"># This is used to ping the metadata server, it avoids the cost of a DNS</span>
<span class="c1"># lookup.</span>
<span class="n">_METADATA_IP</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;GCE_METADATA_IP&#39;</span><span class="p">,</span> <span class="s1">&#39;169.254.169.254&#39;</span><span class="p">))</span>

<span class="n">METADATA_SERVER_HOSTNAME</span> <span class="o">=</span> <span class="s1">&#39;metadata.google.internal&#39;</span>
<span class="n">METADATA_SERVER_CONN_TIMEOUT</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">_METADATA_FLAVOR_HEADER</span> <span class="o">=</span> <span class="s1">&#39;metadata-flavor&#39;</span>
<span class="n">_METADATA_FLAVOR_VALUE</span> <span class="o">=</span> <span class="s1">&#39;Google&#39;</span>
<span class="n">REQUIRED_METADATA_HEADER</span> <span class="o">=</span> <span class="p">{</span><span class="n">_METADATA_FLAVOR_HEADER</span><span class="p">:</span> <span class="n">_METADATA_FLAVOR_VALUE</span><span class="p">}</span>
<span class="n">HTTP_SUCCESS</span> <span class="o">=</span> <span class="n">httplib</span><span class="o">.</span><span class="n">OK</span>
<span class="n">HTTP_GET</span> <span class="o">=</span> <span class="s1">&#39;GET&#39;</span>

<span class="n">LOGGER</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="_obtain_http_client"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.common.util.metadata_server.html#google.cloud.forseti.common.util.metadata_server._obtain_http_client">[docs]</a><span class="k">def</span> <span class="nf">_obtain_http_client</span><span class="p">(</span><span class="n">hostname</span><span class="o">=</span><span class="n">METADATA_SERVER_HOSTNAME</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get an HTTP client to the GCP metadata server.</span>

<span class="sd">    Args:</span>
<span class="sd">        hostname (str): A qualified hostname.</span>

<span class="sd">    Returns:</span>
<span class="sd">        HttpClient: A simple HTTP client to the GCP metadata server.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">httplib</span><span class="o">.</span><span class="n">HTTPConnection</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span>
                                  <span class="n">timeout</span><span class="o">=</span><span class="n">METADATA_SERVER_CONN_TIMEOUT</span><span class="p">)</span></div>


<div class="viewcode-block" id="_issue_http_request"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.common.util.metadata_server.html#google.cloud.forseti.common.util.metadata_server._issue_http_request">[docs]</a><span class="k">def</span> <span class="nf">_issue_http_request</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">headers</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Perform a request on a specified httplib connection object.</span>

<span class="sd">    Args:</span>
<span class="sd">        method (str): The http request method.</span>
<span class="sd">        path (str): The path on the server.</span>
<span class="sd">        headers (dict): A key-value pairs of headers.</span>

<span class="sd">    Returns:</span>
<span class="sd">        httplib.HTTPResponse: The HTTP response object.</span>

<span class="sd">    Raises:</span>
<span class="sd">        MetadataServerHttpError: When we can&#39;t reach the requested host.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">http_client</span> <span class="o">=</span> <span class="n">_obtain_http_client</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">http_client</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">http_client</span><span class="o">.</span><span class="n">getresponse</span><span class="p">()</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="n">httplib</span><span class="o">.</span><span class="n">HTTPException</span><span class="p">):</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Error occurred while issuing http request.&#39;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">MetadataServerHttpError</span></div>


<div class="viewcode-block" id="can_reach_metadata_server"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.common.util.metadata_server.html#google.cloud.forseti.common.util.metadata_server.can_reach_metadata_server">[docs]</a><span class="k">def</span> <span class="nf">can_reach_metadata_server</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Determine if we can reach the metadata server.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True if metadata server can be reached, False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">http_client</span> <span class="o">=</span> <span class="n">_obtain_http_client</span><span class="p">(</span><span class="n">hostname</span><span class="o">=</span><span class="n">_METADATA_IP</span><span class="p">)</span>
        <span class="n">http_client</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">REQUIRED_METADATA_HEADER</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">http_client</span><span class="o">.</span><span class="n">getresponse</span><span class="p">()</span>
        <span class="n">metadata_flavor</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">_METADATA_FLAVOR_HEADER</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">httplib</span><span class="o">.</span><span class="n">OK</span> <span class="ow">and</span>
                <span class="n">metadata_flavor</span> <span class="o">==</span> <span class="n">_METADATA_FLAVOR_VALUE</span><span class="p">)</span>

    <span class="k">except</span> <span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="n">httplib</span><span class="o">.</span><span class="n">HTTPException</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Compute Engine Metadata server unreachable: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="get_value_for_attribute"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.common.util.metadata_server.html#google.cloud.forseti.common.util.metadata_server.get_value_for_attribute">[docs]</a><span class="k">def</span> <span class="nf">get_value_for_attribute</span><span class="p">(</span><span class="n">attribute</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;For a given key return the value.</span>

<span class="sd">    Args:</span>
<span class="sd">        attribute (str): Some metadata key.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The value of the requested key, if key isn&#39;t present then None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;/computeMetadata/v1/instance/attributes/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">attribute</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">http_response</span> <span class="o">=</span> <span class="n">_issue_http_request</span><span class="p">(</span>
            <span class="n">HTTP_GET</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">REQUIRED_METADATA_HEADER</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">http_response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">MetadataServerHttpError</span><span class="p">):</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Unable to read value for attribute key </span><span class="si">%s</span><span class="s1"> &#39;</span>
                         <span class="s1">&#39;from metadata server.&#39;</span><span class="p">,</span> <span class="n">attribute</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="get_project_id"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.common.util.metadata_server.html#google.cloud.forseti.common.util.metadata_server.get_project_id">[docs]</a><span class="k">def</span> <span class="nf">get_project_id</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Get the project id from the metadata server.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The of the project id, on error, returns None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;/computeMetadata/v1/project/project-id&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">http_response</span> <span class="o">=</span> <span class="n">_issue_http_request</span><span class="p">(</span>
            <span class="n">HTTP_GET</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">REQUIRED_METADATA_HEADER</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">http_response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">MetadataServerHttpError</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Unable to read project id from metadata server.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>
</pre></div>
