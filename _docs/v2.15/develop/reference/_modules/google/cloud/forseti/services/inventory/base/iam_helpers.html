---
layout: docs

title: "google.cloud.forseti.services.inventory.base.iam_helpers"



hide:
  right_sidebar: true
---
<h1>Source code for google.cloud.forseti.services.inventory.base.iam_helpers</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2018 The Forseti Security Authors. All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#    http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="sd">&quot;&quot;&quot;Helper functions for handling IAM policies.&quot;&quot;&quot;</span>
<span class="c1"># pylint: disable=too-many-locals</span>

<span class="kn">from</span> <span class="nn">google.cloud.forseti.common.util</span> <span class="k">import</span> <span class="n">logger</span>

<span class="n">LOGGER</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="_split_member"><a class="viewcode-back" href="../../../../../../../google.cloud.forseti.services.inventory.base.iam_helpers.html#google.cloud.forseti.services.inventory.base.iam_helpers._split_member">[docs]</a><span class="k">def</span> <span class="nf">_split_member</span><span class="p">(</span><span class="n">member</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Splits an IAM member into type and optional value.</span>

<span class="sd">    Args:</span>
<span class="sd">        member (str): The IAM member to split.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: The member type and optionally member value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># &#39;allUsers&#39; and &#39;allAuthenticatedUsers&#39; member do not contain &#39;:&#39; so they</span>
    <span class="c1"># need to be handled seperately.</span>
    <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">member</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">member</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">member</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>


<div class="viewcode-block" id="convert_bigquery_policy_to_iam"><a class="viewcode-back" href="../../../../../../../google.cloud.forseti.services.inventory.base.iam_helpers.html#google.cloud.forseti.services.inventory.base.iam_helpers.convert_bigquery_policy_to_iam">[docs]</a><span class="k">def</span> <span class="nf">convert_bigquery_policy_to_iam</span><span class="p">(</span><span class="n">access_policy</span><span class="p">,</span> <span class="n">project_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert a bigquery Access Policy to IAM policy.</span>

<span class="sd">    This is used to enable IAM explain for legacy bigquery policies.</span>

<span class="sd">    Args:</span>
<span class="sd">        access_policy (list): A list of bigquery access policies.</span>
<span class="sd">        project_id (str): The project id for the project the dataset is under.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: An iam policy object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">access_policy</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="c1"># Map of iam policy roles to bigquery access policy roles.</span>
    <span class="n">access_policy_to_iam_role_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;WRITER&#39;</span><span class="p">:</span> <span class="s1">&#39;roles/bigquery.dataEditor&#39;</span><span class="p">,</span>
        <span class="s1">&#39;OWNER&#39;</span><span class="p">:</span> <span class="s1">&#39;roles/bigquery.dataOwner&#39;</span><span class="p">,</span>
        <span class="s1">&#39;READER&#39;</span><span class="p">:</span> <span class="s1">&#39;roles/bigquery.dataViewer&#39;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="c1"># Map iam policy member type to bigquery access policy member type.</span>
    <span class="n">special_group_to_iam_member_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;allAuthenticatedUsers&#39;</span><span class="p">:</span> <span class="s1">&#39;allAuthenticatedUsers&#39;</span><span class="p">,</span>
        <span class="s1">&#39;projectWriters&#39;</span><span class="p">:</span> <span class="s1">&#39;projectEditor&#39;</span><span class="p">,</span>
        <span class="s1">&#39;projectOwners&#39;</span><span class="p">:</span> <span class="s1">&#39;projectOwner&#39;</span><span class="p">,</span>
        <span class="s1">&#39;projectReaders&#39;</span><span class="p">:</span> <span class="s1">&#39;projectViewer&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">iam_policy</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bindings&#39;</span><span class="p">:</span> <span class="p">[]}</span>
    <span class="n">roles</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">policy</span> <span class="ow">in</span> <span class="n">access_policy</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">policy</span><span class="p">[</span><span class="s1">&#39;role&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">access_policy_to_iam_role_map</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;unknown role in access policy </span><span class="si">%s</span><span class="s1"> under project </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="n">policy</span><span class="p">,</span> <span class="n">project_id</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">iam_role</span> <span class="o">=</span> <span class="n">access_policy_to_iam_role_map</span><span class="p">[</span><span class="n">policy</span><span class="p">[</span><span class="s1">&#39;role&#39;</span><span class="p">]]</span>

        <span class="k">if</span> <span class="s1">&#39;userByEmail&#39;</span> <span class="ow">in</span> <span class="n">policy</span><span class="p">:</span>
            <span class="n">member</span> <span class="o">=</span> <span class="n">policy</span><span class="p">[</span><span class="s1">&#39;userByEmail&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">member</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;gserviceaccount.com&#39;</span><span class="p">):</span>
                <span class="n">member</span> <span class="o">=</span> <span class="s1">&#39;serviceAccount:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">member</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">member</span> <span class="o">=</span> <span class="s1">&#39;user:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">member</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;groupByEmail&#39;</span> <span class="ow">in</span> <span class="n">policy</span><span class="p">:</span>
            <span class="n">member</span> <span class="o">=</span> <span class="s1">&#39;group:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">policy</span><span class="p">[</span><span class="s1">&#39;groupByEmail&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="s1">&#39;domain&#39;</span> <span class="ow">in</span> <span class="n">policy</span><span class="p">:</span>
            <span class="n">member</span> <span class="o">=</span> <span class="s1">&#39;domain:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">policy</span><span class="p">[</span><span class="s1">&#39;domain&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="s1">&#39;specialGroup&#39;</span> <span class="ow">in</span> <span class="n">policy</span><span class="p">:</span>
            <span class="n">member</span> <span class="o">=</span> <span class="n">policy</span><span class="p">[</span><span class="s1">&#39;specialGroup&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">member</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">special_group_to_iam_member_map</span><span class="p">:</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;unknown special group type </span><span class="si">%s</span><span class="s1"> in access policy </span><span class="si">%s</span><span class="s1"> &#39;</span>
                            <span class="s1">&#39;under project </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">member</span><span class="p">,</span> <span class="n">policy</span><span class="p">,</span> <span class="n">project_id</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">member</span> <span class="o">=</span> <span class="n">special_group_to_iam_member_map</span><span class="p">[</span><span class="n">member</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">member</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;project&#39;</span><span class="p">):</span>
                <span class="n">member</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">member</span><span class="p">,</span> <span class="n">project_id</span><span class="p">)</span>

        <span class="n">roles</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">iam_role</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">member</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">role</span><span class="p">,</span> <span class="n">members</span> <span class="ow">in</span> <span class="n">roles</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">iam_policy</span><span class="p">[</span><span class="s1">&#39;bindings&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="n">role</span><span class="p">,</span> <span class="s1">&#39;members&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">members</span><span class="p">)})</span>
    <span class="k">return</span> <span class="n">iam_policy</span></div>


<div class="viewcode-block" id="convert_iam_to_bigquery_policy"><a class="viewcode-back" href="../../../../../../../google.cloud.forseti.services.inventory.base.iam_helpers.html#google.cloud.forseti.services.inventory.base.iam_helpers.convert_iam_to_bigquery_policy">[docs]</a><span class="k">def</span> <span class="nf">convert_iam_to_bigquery_policy</span><span class="p">(</span><span class="n">iam_policy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts an IAM policy to a bigquery Access Policy.</span>

<span class="sd">    This is used for backwards compatibility between data returned from live</span>
<span class="sd">    API and the data stored in CAI. Once the live API returns IAM policies</span>
<span class="sd">    instead, this can be deprecated.</span>

<span class="sd">    Args:</span>
<span class="sd">        iam_policy (dict): The BigQuery dataset IAM policy.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: A list of access policies.</span>

<span class="sd">        An example return value:</span>

<span class="sd">            [</span>
<span class="sd">                {&#39;role&#39;: &#39;WRITER&#39;, &#39;specialGroup&#39;: &#39;projectWriters&#39;},</span>
<span class="sd">                {&#39;role&#39;: &#39;OWNER&#39;, &#39;specialGroup&#39;: &#39;projectOwners&#39;},</span>
<span class="sd">                {&#39;role&#39;: &#39;OWNER&#39;, &#39;userByEmail&#39;: &#39;user@domain.com&#39;},</span>
<span class="sd">                {&#39;role&#39;: &#39;READER&#39;, &#39;specialGroup&#39;: &#39;projectReaders&#39;}</span>
<span class="sd">            ]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Map of iam policy roles to bigquery access policy roles.</span>
    <span class="n">iam_to_access_policy_role_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;roles/bigquery.dataEditor&#39;</span><span class="p">:</span> <span class="s1">&#39;WRITER&#39;</span><span class="p">,</span>
        <span class="s1">&#39;roles/bigquery.dataOwner&#39;</span><span class="p">:</span> <span class="s1">&#39;OWNER&#39;</span><span class="p">,</span>
        <span class="s1">&#39;roles/bigquery.dataViewer&#39;</span><span class="p">:</span> <span class="s1">&#39;READER&#39;</span>
    <span class="p">}</span>
    <span class="c1"># Map iam policy member type to bigquery access policy member type.</span>
    <span class="c1"># The value of the map is a tuple of access policy member type and access</span>
    <span class="c1"># policy member value pairs. If the member value is None, then the value</span>
    <span class="c1"># from the IAM policy binding is used.</span>
    <span class="n">iam_to_access_policy_member_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;allAuthenticatedUsers&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;specialGroup&#39;</span><span class="p">,</span> <span class="s1">&#39;allAuthenticatedUsers&#39;</span><span class="p">),</span>
        <span class="s1">&#39;projectEditor&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;specialGroup&#39;</span><span class="p">,</span> <span class="s1">&#39;projectWriters&#39;</span><span class="p">),</span>
        <span class="s1">&#39;projectOwner&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;specialGroup&#39;</span><span class="p">,</span> <span class="s1">&#39;projectOwners&#39;</span><span class="p">),</span>
        <span class="s1">&#39;projectViewer&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;specialGroup&#39;</span><span class="p">,</span> <span class="s1">&#39;projectReaders&#39;</span><span class="p">),</span>
        <span class="s1">&#39;domain&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;domain&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;groupByEmail&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;userByEmail&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="s1">&#39;serviceAccount&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;userByEmail&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="n">access_policies</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">binding</span> <span class="ow">in</span> <span class="n">iam_policy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bindings&#39;</span><span class="p">,</span> <span class="p">[]):</span>
        <span class="k">if</span> <span class="n">binding</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;role&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">iam_to_access_policy_role_map</span><span class="p">:</span>
            <span class="n">role</span> <span class="o">=</span> <span class="n">iam_to_access_policy_role_map</span><span class="p">[</span><span class="n">binding</span><span class="p">[</span><span class="s1">&#39;role&#39;</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="n">binding</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;members&#39;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="n">member_type</span><span class="p">,</span> <span class="n">member_value</span> <span class="o">=</span> <span class="n">_split_member</span><span class="p">(</span><span class="n">member</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">member_type</span> <span class="ow">in</span> <span class="n">iam_to_access_policy_member_map</span><span class="p">:</span>
                    <span class="n">new_type</span><span class="p">,</span> <span class="n">new_value</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">iam_to_access_policy_member_map</span><span class="p">[</span><span class="n">member_type</span><span class="p">])</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">new_value</span><span class="p">:</span>
                        <span class="n">new_value</span> <span class="o">=</span> <span class="n">member_value</span>
                    <span class="n">access_policies</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="n">role</span><span class="p">,</span> <span class="n">new_type</span><span class="p">:</span> <span class="n">new_value</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">access_policies</span></div>


<div class="viewcode-block" id="convert_iam_to_bucket_acls"><a class="viewcode-back" href="../../../../../../../google.cloud.forseti.services.inventory.base.iam_helpers.html#google.cloud.forseti.services.inventory.base.iam_helpers.convert_iam_to_bucket_acls">[docs]</a><span class="k">def</span> <span class="nf">convert_iam_to_bucket_acls</span><span class="p">(</span><span class="n">iam_policy</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">project_id</span><span class="p">,</span> <span class="n">project_number</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts an IAM policy to Bucket Access Controls.</span>

<span class="sd">    The is used for backwards compatibility between data returned from live</span>
<span class="sd">    API and the data stored in CAI. Once acls are removed from cloud storage,</span>
<span class="sd">    this can be deprecated.</span>

<span class="sd">    Args:</span>
<span class="sd">        iam_policy (dict): The Storage Bucket IAM policy.</span>
<span class="sd">        bucket (str): The Storage Bucket name.</span>
<span class="sd">        project_id (str): The project id for the project the bucket is under.</span>
<span class="sd">        project_number (str): The project number for the project the bucket is</span>
<span class="sd">            under.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: A list of access policies.</span>

<span class="sd">        An example return value:</span>

<span class="sd">        [</span>
<span class="sd">          {</span>
<span class="sd">            &quot;bucket&quot;: &quot;my-bucket&quot;,</span>
<span class="sd">            &quot;id&quot;: &quot;my-bucket/project-owners-12345&quot;,</span>
<span class="sd">            &quot;entity&quot;: &quot;project-owners-12345&quot;,</span>
<span class="sd">            &quot;projectTeam&quot;: {&quot;projectNumber&quot;: &quot;12345&quot;, &quot;team&quot;: &quot;owners&quot;},</span>
<span class="sd">            &quot;role&quot;: &quot;OWNER&quot;</span>
<span class="sd">          },</span>
<span class="sd">          {</span>
<span class="sd">            &quot;bucket&quot;: &quot;my-bucket&quot;,</span>
<span class="sd">            &quot;id&quot;: &quot;my-bucket/project-editors-12345&quot;,</span>
<span class="sd">            &quot;entity&quot;: &quot;project-editors-12345&quot;,</span>
<span class="sd">            &quot;projectTeam&quot;: {&quot;projectNumber&quot;: &quot;12345&quot;, &quot;team&quot;: &quot;editors&quot;},</span>
<span class="sd">            &quot;role&quot;: &quot;OWNER&quot;</span>
<span class="sd">          },</span>
<span class="sd">          {</span>
<span class="sd">            &quot;bucket&quot;: &quot;my-bucket&quot;,</span>
<span class="sd">            &quot;id&quot;: &quot;my-bucket/project-viewers-12345&quot;,</span>
<span class="sd">            &quot;entity&quot;: &quot;project-viewers-12345&quot;,</span>
<span class="sd">            &quot;projectTeam&quot;: {&quot;projectNumber&quot;: &quot;12345&quot;, &quot;team&quot;: &quot;viewers&quot;},</span>
<span class="sd">            &quot;role&quot;: &quot;READER&quot;</span>
<span class="sd">          },</span>
<span class="sd">          {</span>
<span class="sd">            &quot;bucket&quot;: &quot;my-bucket&quot;,</span>
<span class="sd">            &quot;id&quot;: &quot;my-bucket/domain-forseti.test&quot;,</span>
<span class="sd">            &quot;domain&quot;: &quot;forseti.test&quot;,</span>
<span class="sd">            &quot;entity&quot;: &quot;domain-forseti.test&quot;,</span>
<span class="sd">            &quot;role&quot;: &quot;READER&quot;</span>
<span class="sd">          },</span>
<span class="sd">          {</span>
<span class="sd">            &quot;bucket&quot;: &quot;my-bucket&quot;,</span>
<span class="sd">            &quot;id&quot;: &quot;my-bucket/group-my-group@forseti.test&quot;,</span>
<span class="sd">            &quot;email&quot;: &quot;my-group@forseti.test&quot;,</span>
<span class="sd">            &quot;entity&quot;: &quot;group-my-group@forseti.test&quot;,</span>
<span class="sd">            &quot;role&quot;: &quot;WRITER&quot;</span>
<span class="sd">          },</span>
<span class="sd">          {</span>
<span class="sd">            &quot;bucket&quot;: &quot;my-bucket&quot;,</span>
<span class="sd">            &quot;id&quot;: &quot;my-bucket/user-12345-compute@developer.gserviceaccount.com&quot;,</span>
<span class="sd">            &quot;email&quot;: &quot;12345-compute@developer.gserviceaccount.com&quot;,</span>
<span class="sd">            &quot;entity&quot;: &quot;user-12345-compute@developer.gserviceaccount.com&quot;,</span>
<span class="sd">            &quot;role&quot;: &quot;WRITER&quot;</span>
<span class="sd">          },</span>
<span class="sd">          {</span>
<span class="sd">            &quot;bucket&quot;: &quot;my-bucket&quot;,</span>
<span class="sd">            &quot;id&quot;: &quot;my-bucket/allAuthenticatedUsers&quot;,</span>
<span class="sd">            &quot;entity&quot;: &quot;allAuthenticatedUsers&quot;,</span>
<span class="sd">            &quot;role&quot;: &quot;READER&quot;</span>
<span class="sd">          },</span>
<span class="sd">          {</span>
<span class="sd">            &quot;bucket&quot;: &quot;my-bucket&quot;,</span>
<span class="sd">            &quot;id&quot;: &quot;my-bucket/allUsers&quot;,</span>
<span class="sd">            &quot;entity&quot;: &quot;allUsers&quot;,</span>
<span class="sd">            &quot;role&quot;: &quot;READER&quot;</span>
<span class="sd">          }</span>
<span class="sd">        ]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Map of iam policy roles to bucket access control roles.</span>
    <span class="n">iam_to_access_policy_role_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;roles/storage.legacyBucketOwner&#39;</span><span class="p">:</span> <span class="s1">&#39;OWNER&#39;</span><span class="p">,</span>
        <span class="s1">&#39;roles/storage.legacyBucketReader&#39;</span><span class="p">:</span> <span class="s1">&#39;READER&#39;</span><span class="p">,</span>
        <span class="s1">&#39;roles/storage.legacyBucketWriter&#39;</span><span class="p">:</span> <span class="s1">&#39;WRITER&#39;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="c1"># Map iam policy member type to bucket access control entity type.</span>
    <span class="n">iam_to_entity_member_type_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;allAuthenticatedUsers&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;allAuthenticatedUsers&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="s1">&#39;allUsers&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;allUsers&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="s1">&#39;domain&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;domain&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="s1">&#39;projectEditor&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;project-editors&#39;</span><span class="p">,</span> <span class="s1">&#39;editors&#39;</span><span class="p">),</span>
        <span class="s1">&#39;projectOwner&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;project-owners&#39;</span><span class="p">,</span> <span class="s1">&#39;owners&#39;</span><span class="p">),</span>
        <span class="s1">&#39;projectViewer&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;project-viewers&#39;</span><span class="p">,</span> <span class="s1">&#39;viewers&#39;</span><span class="p">),</span>
        <span class="s1">&#39;serviceAccount&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="n">access_policies</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">binding</span> <span class="ow">in</span> <span class="n">iam_policy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bindings&#39;</span><span class="p">,</span> <span class="p">[]):</span>
        <span class="k">if</span> <span class="n">binding</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;role&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">iam_to_access_policy_role_map</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">role</span> <span class="o">=</span> <span class="n">iam_to_access_policy_role_map</span><span class="p">[</span><span class="n">binding</span><span class="p">[</span><span class="s1">&#39;role&#39;</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="n">binding</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;members&#39;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">acl</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bucket&#39;</span><span class="p">:</span> <span class="n">bucket</span><span class="p">,</span> <span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="n">role</span><span class="p">}</span>
            <span class="n">member_type</span><span class="p">,</span> <span class="n">member_value</span> <span class="o">=</span> <span class="n">_split_member</span><span class="p">(</span><span class="n">member</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">member_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">iam_to_entity_member_type_map</span><span class="p">:</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;unparsable member in binding: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">member</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">team</span><span class="p">)</span> <span class="o">=</span> <span class="n">iam_to_entity_member_type_map</span><span class="p">[</span><span class="n">member_type</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">team</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">member_value</span> <span class="o">==</span> <span class="n">project_id</span><span class="p">:</span>
                    <span class="n">member_value</span> <span class="o">=</span> <span class="n">project_number</span>
                <span class="n">acl</span><span class="p">[</span><span class="s1">&#39;entity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">entity</span><span class="p">,</span> <span class="n">member_value</span><span class="p">])</span>
                <span class="n">acl</span><span class="p">[</span><span class="s1">&#39;projectTeam&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;projectNumber&#39;</span><span class="p">:</span> <span class="n">member_value</span><span class="p">,</span>
                                      <span class="s1">&#39;team&#39;</span><span class="p">:</span> <span class="n">team</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">member_value</span><span class="p">:</span>
                    <span class="n">entity</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">entity</span><span class="p">,</span> <span class="n">member_value</span><span class="p">])</span>
                    <span class="k">if</span> <span class="s1">&#39;@&#39;</span> <span class="ow">in</span> <span class="n">member_value</span><span class="p">:</span>
                        <span class="n">acl</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">member_value</span>
                <span class="n">acl</span><span class="p">[</span><span class="s1">&#39;entity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">entity</span>

            <span class="n">acl</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">bucket</span><span class="p">,</span> <span class="n">acl</span><span class="p">[</span><span class="s1">&#39;entity&#39;</span><span class="p">]])</span>
            <span class="k">if</span> <span class="n">acl</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">access_policies</span><span class="p">:</span>
                <span class="n">other_acl</span> <span class="o">=</span> <span class="n">access_policies</span><span class="p">[</span><span class="n">acl</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span>
                <span class="c1"># If existing acl is equal or higher permission,</span>
                <span class="c1"># then it takes precedence.</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">other_acl</span><span class="p">[</span><span class="s1">&#39;role&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;OWNER&#39;</span> <span class="ow">or</span>
                        <span class="p">(</span><span class="n">other_acl</span><span class="p">[</span><span class="s1">&#39;role&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;WRITER&#39;</span> <span class="ow">and</span> <span class="n">role</span> <span class="o">!=</span> <span class="s1">&#39;OWNER&#39;</span><span class="p">)</span> <span class="ow">or</span>
                        <span class="p">(</span><span class="n">other_acl</span><span class="p">[</span><span class="s1">&#39;role&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;READER&#39;</span> <span class="ow">and</span> <span class="n">role</span> <span class="o">==</span> <span class="s1">&#39;READER&#39;</span><span class="p">)):</span>
                    <span class="k">continue</span>

            <span class="n">access_policies</span><span class="p">[</span><span class="n">acl</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">acl</span>

    <span class="k">return</span> <span class="n">access_policies</span><span class="o">.</span><span class="n">values</span><span class="p">()</span></div>
</pre></div>
