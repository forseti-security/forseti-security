---
layout: docs

title: "google.cloud.forseti.actions.action_config_validator"



hide:
  right_sidebar: true
---
<h1>Source code for google.cloud.forseti.actions.action_config_validator</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2017 The Forseti Security Authors. All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#    http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="sd">&quot;&quot;&quot;Actions configuration validator.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">yaml</span>


<div class="viewcode-block" id="validate"><a class="viewcode-back" href="../../../../../google.cloud.forseti.actions.action_config_validator.html#google.cloud.forseti.actions.action_config_validator.validate">[docs]</a><span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">actions_config_path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validates the actions config.</span>

<span class="sd">    Action configuration validation:</span>
<span class="sd">    1. Config is a valid yaml file.</span>
<span class="sd">    2. Each action has an id and it is unique.</span>
<span class="sd">    3. Check each action for:</span>
<span class="sd">      1. An action type.</span>
<span class="sd">      2. That the action type is valid.</span>
<span class="sd">      3. A trigger.</span>
<span class="sd">      4. That the trigger is valid.</span>

<span class="sd">    Args:</span>
<span class="sd">        actions_config_path (str): The actions configuration path.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: The dict configuration.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ConfigLoadError: If the config cannot be loaded.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">_load_and_validate_yaml</span><span class="p">(</span>
        <span class="n">actions_config_path</span><span class="p">)</span>

    <span class="n">actions</span><span class="p">,</span> <span class="n">errs</span> <span class="o">=</span> <span class="n">_load_actions</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="n">errors</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">errs</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">:</span>
        <span class="n">action_errs</span> <span class="o">=</span> <span class="p">[</span><span class="n">_check_action_type</span><span class="p">(</span><span class="n">action</span><span class="p">)]</span>
        <span class="n">action_errs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_check_trigger</span><span class="p">(</span><span class="n">action</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">err</span> <span class="ow">in</span> <span class="n">action_errs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">err</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ConfigLoadError</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">config</span></div>


<div class="viewcode-block" id="_load_and_validate_yaml"><a class="viewcode-back" href="../../../../../google.cloud.forseti.actions.action_config_validator.html#google.cloud.forseti.actions.action_config_validator._load_and_validate_yaml">[docs]</a><span class="k">def</span> <span class="nf">_load_and_validate_yaml</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Loads the configuration from a path.</span>

<span class="sd">    Args:</span>
<span class="sd">      path (str): The path the the configuration.</span>

<span class="sd">    Returns:</span>
<span class="sd">      dict: The loaded configuration dictionary.</span>

<span class="sd">    Raises:</span>
<span class="sd">      ConfigLoadError: If the config cannot be loaded.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">filep</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">filep</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">yaml</span><span class="o">.</span><span class="n">YAMLError</span> <span class="k">as</span> <span class="n">yaml_error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigLoadError</span><span class="p">(</span><span class="n">yaml_error</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">config</span></div>


<div class="viewcode-block" id="_load_actions"><a class="viewcode-back" href="../../../../../google.cloud.forseti.actions.action_config_validator.html#google.cloud.forseti.actions.action_config_validator._load_actions">[docs]</a><span class="k">def</span> <span class="nf">_load_actions</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Loads the actions actions from the config.</span>

<span class="sd">    Args:</span>
<span class="sd">      config (dict): A dictionary configuration.</span>

<span class="sd">    Returns:</span>
<span class="sd">      Tuple: A tuple of the actions and errors.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">action_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">actions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;actions&#39;</span><span class="p">,</span> <span class="p">[]):</span>
        <span class="n">action_id</span> <span class="o">=</span> <span class="n">action</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">action_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MissingRequiredActionField</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">action_id</span> <span class="ow">in</span> <span class="n">action_ids</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DuplicateActionIdError</span><span class="p">(</span><span class="n">action_id</span><span class="p">))</span>
        <span class="n">action_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">action_id</span><span class="p">)</span>
        <span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">actions</span><span class="p">,</span> <span class="n">errors</span></div>


<div class="viewcode-block" id="_check_action_type"><a class="viewcode-back" href="../../../../../google.cloud.forseti.actions.action_config_validator.html#google.cloud.forseti.actions.action_config_validator._check_action_type">[docs]</a><span class="k">def</span> <span class="nf">_check_action_type</span><span class="p">(</span><span class="n">action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validates the action type.</span>

<span class="sd">    Args:</span>
<span class="sd">      action (dict): An action dictionary.</span>

<span class="sd">    Returns:</span>
<span class="sd">      ActionTypeDoesntExist: If the action type doesn&#39;t exist.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">action_id</span> <span class="o">=</span> <span class="n">action</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
    <span class="n">action_type</span> <span class="o">=</span> <span class="n">action</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">action_type</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">EmptyActionType</span><span class="p">(</span><span class="n">action_id</span><span class="p">)</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">action_type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">_</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">ImportError</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ActionTypeDoesntExist</span><span class="p">(</span><span class="n">action_type</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="_check_trigger"><a class="viewcode-back" href="../../../../../google.cloud.forseti.actions.action_config_validator.html#google.cloud.forseti.actions.action_config_validator._check_trigger">[docs]</a><span class="k">def</span> <span class="nf">_check_trigger</span><span class="p">(</span><span class="n">action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validates the triggers.</span>

<span class="sd">    Args:</span>
<span class="sd">      action (dict): An action dictionary.</span>

<span class="sd">    Returns:</span>
<span class="sd">      Error: If the trigger type doesn&#39;t exist or the trigger is missing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">action_id</span> <span class="o">=</span> <span class="n">action</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
    <span class="n">action_triggers</span> <span class="o">=</span> <span class="n">action</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;triggers&#39;</span><span class="p">)</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">action_triggers</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">EmptyActionTrigger</span><span class="p">(</span><span class="n">action_id</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">trigger</span> <span class="ow">in</span> <span class="n">action_triggers</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">trigger</span> <span class="o">==</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">trigger</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;rules&#39;</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TriggerDoesntExist</span><span class="p">(</span><span class="n">trigger</span><span class="p">))</span>
        <span class="c1"># TODO: once the rules classes and the action classes are set up,</span>
        <span class="c1"># this should be changed handle any valid type instead of straight</span>
        <span class="c1"># replacement.</span>
        <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;google.cloud.forseti.auditor.rules&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">_</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">ImportError</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TriggerDoesntExist</span><span class="p">(</span><span class="n">trigger</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">errors</span></div>


<div class="viewcode-block" id="Error"><a class="viewcode-back" href="../../../../../google.cloud.forseti.actions.action_config_validator.html#google.cloud.forseti.actions.action_config_validator.Error">[docs]</a><span class="k">class</span> <span class="nc">Error</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base Error class.&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="ConfigLoadError"><a class="viewcode-back" href="../../../../../google.cloud.forseti.actions.action_config_validator.html#google.cloud.forseti.actions.action_config_validator.ConfigLoadError">[docs]</a><span class="k">class</span> <span class="nc">ConfigLoadError</span><span class="p">(</span><span class="n">Error</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;ConfigLoadError.&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="ConfigParseError"><a class="viewcode-back" href="../../../../../google.cloud.forseti.actions.action_config_validator.html#google.cloud.forseti.actions.action_config_validator.ConfigParseError">[docs]</a><span class="k">class</span> <span class="nc">ConfigParseError</span><span class="p">(</span><span class="n">Error</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;ConfigParseError.&quot;&quot;&quot;</span>

    <span class="n">CUSTOM_ERROR_MSG</span> <span class="o">=</span> <span class="s1">&#39;Found </span><span class="si">{0}</span><span class="s1"> errors in the config.&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">errors</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize ConfigParseError.</span>

<span class="sd">        Args:</span>
<span class="sd">          errors (list): A list of errors parsing the config.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ConfigParseError</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">CUSTOM_ERROR_MSG</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="n">errors</span></div>


<div class="viewcode-block" id="MissingRequiredActionField"><a class="viewcode-back" href="../../../../../google.cloud.forseti.actions.action_config_validator.html#google.cloud.forseti.actions.action_config_validator.MissingRequiredActionField">[docs]</a><span class="k">class</span> <span class="nc">MissingRequiredActionField</span><span class="p">(</span><span class="n">Error</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;MissingRequiredActionField.&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="EmptyActionType"><a class="viewcode-back" href="../../../../../google.cloud.forseti.actions.action_config_validator.html#google.cloud.forseti.actions.action_config_validator.EmptyActionType">[docs]</a><span class="k">class</span> <span class="nc">EmptyActionType</span><span class="p">(</span><span class="n">Error</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;EmptyActionType.&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="EmptyActionTrigger"><a class="viewcode-back" href="../../../../../google.cloud.forseti.actions.action_config_validator.html#google.cloud.forseti.actions.action_config_validator.EmptyActionTrigger">[docs]</a><span class="k">class</span> <span class="nc">EmptyActionTrigger</span><span class="p">(</span><span class="n">Error</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;EmptyActionType.&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="ActionTypeDoesntExist"><a class="viewcode-back" href="../../../../../google.cloud.forseti.actions.action_config_validator.html#google.cloud.forseti.actions.action_config_validator.ActionTypeDoesntExist">[docs]</a><span class="k">class</span> <span class="nc">ActionTypeDoesntExist</span><span class="p">(</span><span class="n">Error</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;ActionTypeDoesntExist.&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="TriggerDoesntExist"><a class="viewcode-back" href="../../../../../google.cloud.forseti.actions.action_config_validator.html#google.cloud.forseti.actions.action_config_validator.TriggerDoesntExist">[docs]</a><span class="k">class</span> <span class="nc">TriggerDoesntExist</span><span class="p">(</span><span class="n">Error</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;ActionTypeDoesntExist.&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="DuplicateActionIdError"><a class="viewcode-back" href="../../../../../google.cloud.forseti.actions.action_config_validator.html#google.cloud.forseti.actions.action_config_validator.DuplicateActionIdError">[docs]</a><span class="k">class</span> <span class="nc">DuplicateActionIdError</span><span class="p">(</span><span class="n">Error</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;DuplicateActionIdError.&quot;&quot;&quot;</span>

    <span class="n">CUSTOM_ERROR_MSG</span> <span class="o">=</span> <span class="s1">&#39;Found duplicate action id: </span><span class="si">{0}</span><span class="s1">&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize DuplicateActionIdError.</span>
<span class="sd">        Args:</span>
<span class="sd">          action_id (str): The string action id.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DuplicateActionIdError</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">CUSTOM_ERROR_MSG</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">action_id</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action_id</span> <span class="o">=</span> <span class="n">action_id</span></div>
</pre></div>
