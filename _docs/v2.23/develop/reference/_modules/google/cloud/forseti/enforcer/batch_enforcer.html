---
layout: docs

title: "google.cloud.forseti.enforcer.batch_enforcer"



hide:
  right_sidebar: true
---
<h1>Source code for google.cloud.forseti.enforcer.batch_enforcer</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2017 The Forseti Security Authors. All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#    http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="sd">&quot;&quot;&quot;Manages enforcement of policies for multiple cloud projects in parallel.&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="k">import</span> <span class="nb">object</span>
<span class="kn">import</span> <span class="nn">threading</span>

<span class="kn">import</span> <span class="nn">concurrent.futures</span>

<span class="kn">from</span> <span class="nn">google.cloud.forseti.common.gcp_api</span> <span class="k">import</span> <span class="n">compute</span>
<span class="kn">from</span> <span class="nn">google.cloud.forseti.common.util</span> <span class="k">import</span> <span class="n">date_time</span>
<span class="kn">from</span> <span class="nn">google.cloud.forseti.common.util</span> <span class="k">import</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">google.cloud.forseti.enforcer</span> <span class="k">import</span> <span class="n">enforcer_log_pb2</span>
<span class="kn">from</span> <span class="nn">google.cloud.forseti.enforcer</span> <span class="k">import</span> <span class="n">project_enforcer</span>

<span class="n">STATUS_SUCCESS</span> <span class="o">=</span> <span class="n">enforcer_log_pb2</span><span class="o">.</span><span class="n">SUCCESS</span>
<span class="n">STATUS_ERROR</span> <span class="o">=</span> <span class="n">enforcer_log_pb2</span><span class="o">.</span><span class="n">ERROR</span>
<span class="n">STATUS_SKIPPED</span> <span class="o">=</span> <span class="n">enforcer_log_pb2</span><span class="o">.</span><span class="n">SKIPPED</span>
<span class="n">STATUS_DELETED</span> <span class="o">=</span> <span class="n">enforcer_log_pb2</span><span class="o">.</span><span class="n">PROJECT_DELETED</span>

<span class="n">LOGGER</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># Per thread storage.</span>
<span class="n">LOCAL_THREAD</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">local</span><span class="p">()</span>


<div class="viewcode-block" id="BatchFirewallEnforcer"><a class="viewcode-back" href="../../../../../google.cloud.forseti.enforcer.batch_enforcer.html#google.cloud.forseti.enforcer.batch_enforcer.BatchFirewallEnforcer">[docs]</a><span class="k">class</span> <span class="nc">BatchFirewallEnforcer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Manage the parallel enforcement of firewall policies across projects.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">global_configs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">concurrent_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">project_sema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">max_running_operations</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize.</span>

<span class="sd">        Args:</span>
<span class="sd">          global_configs (dict): Global configurations.</span>
<span class="sd">          dry_run (bool): If True, will simply log what action would have been</span>
<span class="sd">              taken without actually applying any modifications.</span>
<span class="sd">          concurrent_workers (int): The number of parallel enforcement threads</span>
<span class="sd">              to execute.</span>
<span class="sd">          project_sema (threading.BoundedSemaphore): An optional semaphore</span>
<span class="sd">              object, used to limit the number of concurrent projects getting</span>
<span class="sd">              written to.</span>
<span class="sd">          max_running_operations (int): [DEPRECATED] Used to limit the number of</span>
<span class="sd">              concurrent write operations on a single project&#39;s firewall rules.</span>
<span class="sd">              Set to 0 to allow unlimited in flight asynchronous operations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">global_configs</span> <span class="o">=</span> <span class="n">global_configs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enforcement_log</span> <span class="o">=</span> <span class="n">enforcer_log_pb2</span><span class="o">.</span><span class="n">EnforcerLog</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dry_run</span> <span class="o">=</span> <span class="n">dry_run</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_concurrent_workers</span> <span class="o">=</span> <span class="n">concurrent_workers</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_project_sema</span> <span class="o">=</span> <span class="n">project_sema</span>

        <span class="k">if</span> <span class="n">max_running_operations</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;Max running operations is deprecated. Argument ignored.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_running_operations</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_local</span> <span class="o">=</span> <span class="n">LOCAL_THREAD</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">compute_client</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A thread local instance of compute.ComputeClient.</span>

<span class="sd">        Returns:</span>
<span class="sd">            compute.ComputeClient: A Compute API client instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_local</span><span class="p">,</span> <span class="s1">&#39;compute_client&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">compute_client</span> <span class="o">=</span> <span class="n">compute</span><span class="o">.</span><span class="n">ComputeClient</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">global_configs</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dry_run</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">compute_client</span>

<div class="viewcode-block" id="BatchFirewallEnforcer.run"><a class="viewcode-back" href="../../../../../google.cloud.forseti.enforcer.batch_enforcer.html#google.cloud.forseti.enforcer.batch_enforcer.BatchFirewallEnforcer.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_policies</span><span class="p">,</span> <span class="n">prechange_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">new_result_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">add_rule_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Runs the enforcer over all projects passed in to the function.</span>

<span class="sd">        Args:</span>
<span class="sd">          project_policies (iterable): An iterable of</span>
<span class="sd">              (project_id, firewall_policy) tuples to enforce or a dictionary</span>
<span class="sd">              in the format {project_id: firewall_policy}</span>

<span class="sd">          prechange_callback (Callable): A callback function that will get</span>
<span class="sd">              called if the firewall policy for a project does not match the</span>
<span class="sd">              expected policy, before any changes are actually applied. If the</span>
<span class="sd">              callback returns False then no changes will be made to the</span>
<span class="sd">              project. If it returns True then the changes will be pushed.</span>

<span class="sd">              See FirewallEnforcer.apply_firewall() docstring for more details.</span>

<span class="sd">          new_result_callback (Callable): An optional function to call with each</span>
<span class="sd">              new result proto message as they are returned from a</span>
<span class="sd">              ProjectEnforcer thread.</span>

<span class="sd">          add_rule_callback (Callable): A callback function that checks whether</span>
<span class="sd">              a firewall rule should be applied. If the callback returns False,</span>
<span class="sd">              that rule will not be modified.</span>

<span class="sd">        Returns:</span>
<span class="sd">          enforcer_log_pb2.EnforcerLog: The EnforcerLog proto for the last run,</span>
<span class="sd">          including individual results for each project, and a summary of all</span>
<span class="sd">          results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dry_run</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Simulating changes&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">project_policies</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">project_policies</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">project_policies</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">enforcement_log</span><span class="o">.</span><span class="n">Clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enforcement_log</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">projects_total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">project_policies</span><span class="p">)</span>

        <span class="n">started_time</span> <span class="o">=</span> <span class="n">date_time</span><span class="o">.</span><span class="n">get_utc_now_datetime</span><span class="p">()</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;starting enforcement wave: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">started_time</span><span class="p">)</span>

        <span class="n">projects_enforced_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enforce_projects</span><span class="p">(</span><span class="n">project_policies</span><span class="p">,</span>
                                                         <span class="n">prechange_callback</span><span class="p">,</span>
                                                         <span class="n">new_result_callback</span><span class="p">,</span>
                                                         <span class="n">add_rule_callback</span><span class="p">)</span>

        <span class="n">finished_time</span> <span class="o">=</span> <span class="n">date_time</span><span class="o">.</span><span class="n">get_utc_now_datetime</span><span class="p">()</span>

        <span class="n">started_timestamp</span> <span class="o">=</span> <span class="n">date_time</span><span class="o">.</span><span class="n">get_utc_now_unix_timestamp</span><span class="p">(</span><span class="n">started_time</span><span class="p">)</span>
        <span class="n">finished_timestamp</span> <span class="o">=</span> <span class="n">date_time</span><span class="o">.</span><span class="n">get_utc_now_unix_timestamp</span><span class="p">(</span><span class="n">finished_time</span><span class="p">)</span>
        <span class="n">total_time</span> <span class="o">=</span> <span class="n">finished_timestamp</span> <span class="o">-</span> <span class="n">started_timestamp</span>

        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;finished wave in </span><span class="si">%i</span><span class="s1"> seconds&#39;</span><span class="p">,</span> <span class="n">total_time</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">enforcement_log</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">timestamp_start_msec</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">date_time</span><span class="o">.</span><span class="n">get_utc_now_microtimestamp</span><span class="p">(</span><span class="n">started_time</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enforcement_log</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">timestamp_end_msec</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">date_time</span><span class="o">.</span><span class="n">get_utc_now_microtimestamp</span><span class="p">(</span><span class="n">finished_time</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_summarize_results</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">projects_enforced_count</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No projects enforced on the last run, exiting.&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">enforcement_log</span></div>

<div class="viewcode-block" id="BatchFirewallEnforcer._enforce_projects"><a class="viewcode-back" href="../../../../../google.cloud.forseti.enforcer.batch_enforcer.html#google.cloud.forseti.enforcer.batch_enforcer.BatchFirewallEnforcer._enforce_projects">[docs]</a>    <span class="k">def</span> <span class="nf">_enforce_projects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_policies</span><span class="p">,</span> <span class="n">prechange_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">new_result_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">add_rule_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Do a single enforcement run on the projects.</span>

<span class="sd">        Args:</span>
<span class="sd">          project_policies (iterable): An iterable of</span>
<span class="sd">              (project_id, firewall_policy) tuples to enforce.</span>
<span class="sd">          prechange_callback (Callable): See docstring for self.Run().</span>
<span class="sd">          new_result_callback (Callable): See docstring for self.Run().</span>
<span class="sd">          add_rule_callback (Callable): See docstring for self.Run().</span>

<span class="sd">        Returns:</span>
<span class="sd">          int: The number of projects that were enforced.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get a 64 bit int to use as the unique batch ID for this run.</span>
        <span class="n">batch_id</span> <span class="o">=</span> <span class="n">date_time</span><span class="o">.</span><span class="n">get_utc_now_microtimestamp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enforcement_log</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">batch_id</span> <span class="o">=</span> <span class="n">batch_id</span>

        <span class="n">projects_enforced_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">future_to_key</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">with</span> <span class="p">(</span>
            <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span>
                <span class="n">max_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_concurrent_workers</span><span class="p">))</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">firewall_policy</span><span class="p">)</span> <span class="ow">in</span> <span class="n">project_policies</span><span class="p">:</span>
                <span class="n">future</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_enforce_project</span><span class="p">,</span> <span class="n">project_id</span><span class="p">,</span>
                                         <span class="n">firewall_policy</span><span class="p">,</span> <span class="n">prechange_callback</span><span class="p">,</span>
                                         <span class="n">add_rule_callback</span><span class="p">)</span>
                <span class="n">future_to_key</span><span class="p">[</span><span class="n">future</span><span class="p">]</span> <span class="o">=</span> <span class="n">project_id</span>

            <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">as_completed</span><span class="p">(</span><span class="n">future_to_key</span><span class="p">):</span>
                <span class="n">project_id</span> <span class="o">=</span> <span class="n">future_to_key</span><span class="p">[</span><span class="n">future</span><span class="p">]</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Project </span><span class="si">%s</span><span class="s1"> finished enforcement run.&#39;</span><span class="p">,</span>
                             <span class="n">project_id</span><span class="p">)</span>
                <span class="n">projects_enforced_count</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">enforcement_log</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">add</span><span class="p">()</span>
                <span class="n">result</span><span class="o">.</span><span class="n">CopyFrom</span><span class="p">(</span><span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">())</span>

                <span class="c1"># Make sure all results have the current batch_id set</span>
                <span class="n">result</span><span class="o">.</span><span class="n">batch_id</span> <span class="o">=</span> <span class="n">batch_id</span>
                <span class="n">result</span><span class="o">.</span><span class="n">run_context</span> <span class="o">=</span> <span class="n">enforcer_log_pb2</span><span class="o">.</span><span class="n">ENFORCER_BATCH</span>

                <span class="k">if</span> <span class="n">new_result_callback</span><span class="p">:</span>
                    <span class="n">new_result_callback</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">projects_enforced_count</span></div>

<div class="viewcode-block" id="BatchFirewallEnforcer._enforce_project"><a class="viewcode-back" href="../../../../../google.cloud.forseti.enforcer.batch_enforcer.html#google.cloud.forseti.enforcer.batch_enforcer.BatchFirewallEnforcer._enforce_project">[docs]</a>    <span class="k">def</span> <span class="nf">_enforce_project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_id</span><span class="p">,</span> <span class="n">firewall_policy</span><span class="p">,</span>
                         <span class="n">prechange_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">add_rule_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Enforces the policy on the project.</span>

<span class="sd">        Args:</span>
<span class="sd">          project_id (str): The project id to enforce.</span>
<span class="sd">          firewall_policy (list): A list of rules which are used to construct a</span>
<span class="sd">              fe.FirewallRules object of expected rules to enforce.</span>
<span class="sd">          prechange_callback (Callable): See docstring for self.Run().</span>
<span class="sd">          add_rule_callback (Callable): See docstring for self.Run().</span>

<span class="sd">        Returns:</span>
<span class="sd">          enforcer_log_pb2.GceFirewallEnforcementResult: The result proto.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">enforcer</span> <span class="o">=</span> <span class="n">project_enforcer</span><span class="o">.</span><span class="n">ProjectEnforcer</span><span class="p">(</span>
            <span class="n">project_id</span><span class="p">,</span>
            <span class="n">compute_client</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_client</span><span class="p">,</span>
            <span class="n">dry_run</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dry_run</span><span class="p">,</span>
            <span class="n">project_sema</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_project_sema</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">enforcer</span><span class="o">.</span><span class="n">enforce_firewall_policy</span><span class="p">(</span>
            <span class="n">firewall_policy</span><span class="p">,</span>
            <span class="n">prechange_callback</span><span class="o">=</span><span class="n">prechange_callback</span><span class="p">,</span>
            <span class="n">add_rule_callback</span><span class="o">=</span><span class="n">add_rule_callback</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="BatchFirewallEnforcer._summarize_results"><a class="viewcode-back" href="../../../../../google.cloud.forseti.enforcer.batch_enforcer.html#google.cloud.forseti.enforcer.batch_enforcer.BatchFirewallEnforcer._summarize_results">[docs]</a>    <span class="k">def</span> <span class="nf">_summarize_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse enforcement results into the BatchResult summary proto.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">enforcement_log</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">STATUS_ERROR</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">enforcement_log</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">projects_error</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">result</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">(</span><span class="n">STATUS_SUCCESS</span><span class="p">,</span> <span class="n">STATUS_DELETED</span><span class="p">):</span>
                <span class="c1"># Treat deleted projects as success, they will be removed from</span>
                <span class="c1"># the queue automatically on the next run of the QueueManager</span>
                <span class="c1"># job.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">enforcement_log</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">projects_success</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">gce_firewall_enforcement</span><span class="o">.</span><span class="n">rules_modified_count</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">enforcement_log</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">projects_changed</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">enforcement_log</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">projects_unchanged</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enforcement_log</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">projects_total</span> <span class="o">-</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enforcement_log</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">projects_changed</span><span class="p">)</span></div></div>
</pre></div>
