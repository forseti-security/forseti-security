---
layout: docs

title: "google.cloud.forseti.services.inventory.cai_temporary_storage"



hide:
  right_sidebar: true
---
<h1>Source code for google.cloud.forseti.services.inventory.cai_temporary_storage</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2017 The Forseti Security Authors. All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#    http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="sd">&quot;&quot;&quot;Inventory temporary storage for Cloud Asset data.&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">enum</span>
<span class="kn">import</span> <span class="nn">tempfile</span>

<span class="kn">from</span> <span class="nn">retrying</span> <span class="k">import</span> <span class="n">retry</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">Column</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">Index</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">PrimaryKeyConstraint</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">String</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">LargeBinary</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.exc</span> <span class="k">import</span> <span class="n">SQLAlchemyError</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="k">import</span> <span class="n">declarative_base</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.pool</span> <span class="k">import</span> <span class="n">SingletonThreadPool</span>

<span class="kn">from</span> <span class="nn">google.cloud.forseti.common.util</span> <span class="k">import</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">google.cloud.forseti.services.dao</span> <span class="k">import</span> <span class="n">create_engine</span>
<span class="kn">from</span> <span class="nn">google.cloud.forseti.services.inventory.base.gcp</span> <span class="k">import</span> <span class="n">AssetMetadata</span>

<span class="n">LOGGER</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">BASE</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>

<span class="c1"># Maximum insert size, used to bound the memory used to cache rows to insert</span>
<span class="c1"># before they are flushed to the database. Larger values allow for more</span>
<span class="c1"># efficient index writing by sqlite at the cost of more process memory.</span>
<span class="c1">#</span>
<span class="c1"># NOTE: This is different from https://www.sqlite.org/limits.html#max_sql_length</span>
<span class="c1"># as that limit applies to the individual SQL insert statements, not the</span>
<span class="c1"># combined size of all values inserted at one time.</span>
<span class="c1">#</span>
<span class="c1"># Set to 32 MB as a balance between frequency of writes and memory. This value</span>
<span class="c1"># should be re-evaluated for large Virtual Machines.</span>
<span class="n">MAX_ALLOWED_INSERT_SIZE</span> <span class="o">=</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>  <span class="c1"># 32 Megabytes</span>


<div class="viewcode-block" id="ContentTypes"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.cai_temporary_storage.html#google.cloud.forseti.services.inventory.cai_temporary_storage.ContentTypes">[docs]</a><span class="k">class</span> <span class="nc">ContentTypes</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Cloud Asset Inventory Content Types.&quot;&quot;&quot;</span>
    <span class="n">resource</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">iam_policy</span> <span class="o">=</span> <span class="mi">2</span></div>


<span class="n">SUPPORTED_CONTENT_TYPES</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">ContentTypes</span><span class="p">))</span>


<div class="viewcode-block" id="CaiTemporaryStore"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.cai_temporary_storage.html#google.cloud.forseti.services.inventory.cai_temporary_storage.CaiTemporaryStore">[docs]</a><span class="k">class</span> <span class="nc">CaiTemporaryStore</span><span class="p">(</span><span class="n">BASE</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;CAI temporary inventory table.&quot;&quot;&quot;</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;cai_temporary_store&#39;</span>

    <span class="c1"># Class members created in initialize() by mapper()</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">2048</span><span class="p">,</span> <span class="n">collation</span><span class="o">=</span><span class="s1">&#39;binary&#39;</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">parent_name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">content_type</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Enum</span><span class="p">(</span><span class="n">ContentTypes</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">asset_type</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">asset_data</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">LargeBinary</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">32</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Index</span><span class="p">(</span><span class="s1">&#39;idx_parent_name&#39;</span><span class="p">,</span> <span class="s1">&#39;parent_name&#39;</span><span class="p">),</span>
        <span class="n">PrimaryKeyConstraint</span><span class="p">(</span><span class="s1">&#39;content_type&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;asset_type&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;name&#39;</span><span class="p">,</span>
                             <span class="n">name</span><span class="o">=</span><span class="s1">&#39;cai_temp_store_pk&#39;</span><span class="p">))</span>

    <span class="c1"># Assets with no parent resource.</span>
    <span class="n">UNPARENTED_ASSETS</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span>
        <span class="s1">&#39;cloudresourcemanager.googleapis.com/Organization&#39;</span><span class="p">,</span>
        <span class="s1">&#39;cloudbilling.googleapis.com/BillingAccount&#39;</span><span class="p">,</span>
    <span class="p">])</span>

<div class="viewcode-block" id="CaiTemporaryStore.from_json"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.cai_temporary_storage.html#google.cloud.forseti.services.inventory.cai_temporary_storage.CaiTemporaryStore.from_json">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_json</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">asset_json</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates a database row object from the json data in a dump file.</span>

<span class="sd">        Args:</span>
<span class="sd">            asset_json (str): The json representation of an Asset.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: database row dictionary or None if there is no data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">asset</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">asset_json</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">asset</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">2048</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Skipping insert of asset </span><span class="si">%s</span><span class="s1">, name too long.&#39;</span><span class="p">,</span>
                           <span class="n">asset</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="s1">&#39;resource&#39;</span> <span class="ow">in</span> <span class="n">asset</span><span class="p">:</span>
            <span class="n">content_type</span> <span class="o">=</span> <span class="s1">&#39;resource&#39;</span>
            <span class="n">parent_name</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_parent_name</span><span class="p">(</span><span class="n">asset</span><span class="p">)</span>
            <span class="n">resource_data</span> <span class="o">=</span> <span class="n">asset</span><span class="p">[</span><span class="s1">&#39;resource&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
            <span class="c1"># Remove unused proto representation of asset</span>
            <span class="n">resource_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;internal_data&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">asset_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">resource_data</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;iam_policy&#39;</span> <span class="ow">in</span> <span class="n">asset</span><span class="p">:</span>
            <span class="n">content_type</span> <span class="o">=</span> <span class="s1">&#39;iam_policy&#39;</span>
            <span class="n">parent_name</span> <span class="o">=</span> <span class="n">asset</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="n">asset_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">asset</span><span class="p">[</span><span class="s1">&#39;iam_policy&#39;</span><span class="p">],</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Unparsable asset, no resource or iam policy: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                           <span class="n">asset</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">asset</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                <span class="s1">&#39;parent_name&#39;</span><span class="p">:</span> <span class="n">parent_name</span><span class="p">,</span>
                <span class="s1">&#39;content_type&#39;</span><span class="p">:</span> <span class="n">content_type</span><span class="p">,</span>
                <span class="s1">&#39;asset_type&#39;</span><span class="p">:</span> <span class="n">asset</span><span class="p">[</span><span class="s1">&#39;asset_type&#39;</span><span class="p">],</span>
                <span class="s1">&#39;asset_data&#39;</span><span class="p">:</span> <span class="n">asset_data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)}</span></div>

<div class="viewcode-block" id="CaiTemporaryStore.delete_all"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.cai_temporary_storage.html#google.cloud.forseti.services.inventory.cai_temporary_storage.CaiTemporaryStore.delete_all">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">delete_all</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">engine</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Deletes all rows from this table.</span>

<span class="sd">        Args:</span>
<span class="sd">            engine (object): db engine</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: The number of rows deleted.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: Reraises any exception.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">delete</span><span class="p">())</span>
            <span class="k">return</span> <span class="n">results</span><span class="o">.</span><span class="n">rowcount</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span></div>

    <span class="c1"># pylint: disable=too-many-return-statements</span>
<div class="viewcode-block" id="CaiTemporaryStore._get_parent_name"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.cai_temporary_storage.html#google.cloud.forseti.services.inventory.cai_temporary_storage.CaiTemporaryStore._get_parent_name">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_parent_name</span><span class="p">(</span><span class="n">asset</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determines the parent name from the resource data.</span>

<span class="sd">        Args:</span>
<span class="sd">            asset (dict): An Asset object.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The parent name for the resource.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;parent&#39;</span> <span class="ow">in</span> <span class="n">asset</span><span class="p">[</span><span class="s1">&#39;resource&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">asset</span><span class="p">[</span><span class="s1">&#39;resource&#39;</span><span class="p">][</span><span class="s1">&#39;parent&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">asset</span><span class="p">[</span><span class="s1">&#39;asset_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;cloudkms.googleapis.com/KeyRing&#39;</span><span class="p">:</span>
            <span class="c1"># KMS KeyRings are parented by a location under a project, but</span>
            <span class="c1"># the location is not directly discoverable without iterating all</span>
            <span class="c1"># locations, so instead this creates an artificial parent at the</span>
            <span class="c1"># project level, which acts as an aggregated list of all keyrings</span>
            <span class="c1"># in all locations to fix this broken behavior.</span>
            <span class="c1">#</span>
            <span class="c1"># Strip locations/{LOCATION}/keyRings/{RING} off name to get the</span>
            <span class="c1"># parent project.</span>
            <span class="k">return</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">asset</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span>

        <span class="k">elif</span> <span class="n">asset</span><span class="p">[</span><span class="s1">&#39;asset_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;dataproc.googleapis.com/Cluster&#39;</span><span class="p">:</span>
            <span class="c1"># Dataproc Clusters are parented by a region under a project, but</span>
            <span class="c1"># the region is not directly discoverable without iterating all</span>
            <span class="c1"># regions, so instead this creates an artificial parent at the</span>
            <span class="c1"># project level, which acts as an aggregated list of all clusters</span>
            <span class="c1"># in all regions to fix this broken behavior.</span>
            <span class="c1">#</span>
            <span class="c1"># Strip regions/{REGION}/clusters/{CLUSTER_NAME} off name to get the</span>
            <span class="c1"># parent project.</span>
            <span class="k">return</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">asset</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span>

        <span class="k">elif</span> <span class="p">(</span><span class="n">asset</span><span class="p">[</span><span class="s1">&#39;asset_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;appengine.googleapis.com/&#39;</span><span class="p">)</span> <span class="ow">or</span>
              <span class="n">asset</span><span class="p">[</span><span class="s1">&#39;asset_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;bigquery.googleapis.com/&#39;</span><span class="p">)</span> <span class="ow">or</span>
              <span class="n">asset</span><span class="p">[</span><span class="s1">&#39;asset_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;cloudkms.googleapis.com/&#39;</span><span class="p">)</span> <span class="ow">or</span>
              <span class="n">asset</span><span class="p">[</span><span class="s1">&#39;asset_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;sqladmin.googleapis.com/&#39;</span><span class="p">)</span> <span class="ow">or</span>
              <span class="n">asset</span><span class="p">[</span><span class="s1">&#39;asset_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;spanner.googleapis.com/&#39;</span><span class="p">)):</span>
            <span class="c1"># Strip off the last two segments of the name to get the parent</span>
            <span class="k">return</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">asset</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>

        <span class="k">elif</span> <span class="n">asset</span><span class="p">[</span><span class="s1">&#39;asset_type&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;k8s.io/Node&#39;</span><span class="p">,</span> <span class="s1">&#39;k8s.io/Namespace&#39;</span><span class="p">):</span>
            <span class="c1"># &quot;name&quot;:&quot;//container.googleapis.com/projects/test-project/zones/</span>
            <span class="c1"># us-central1-b/clusters/test-cluster/k8s/nodes/test-node&quot;</span>
            <span class="c1">#</span>
            <span class="c1"># Strip k8s/nodes/{NODE} off name to get the parent.</span>
            <span class="c1">#</span>
            <span class="c1"># &quot;name&quot;:&quot;//container.googleapis.com/projects/test-project/zones/</span>
            <span class="c1"># us-central1-b/clusters/test-cluster/k8s/namespaces/test-namespace&quot;</span>
            <span class="c1">#</span>
            <span class="c1"># Strip k8s/namespaces/{NAMESPACE} off name to get the parent.</span>
            <span class="k">return</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">asset</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span>

        <span class="k">elif</span> <span class="n">asset</span><span class="p">[</span><span class="s1">&#39;asset_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;k8s.io/Pod&#39;</span><span class="p">:</span>
            <span class="c1"># &quot;name&quot;:&quot;//container.googleapis.com/projects/test-project/zones/</span>
            <span class="c1"># us-central1-b/clusters/test-cluster/k8s/namespaces/</span>
            <span class="c1"># test-namespace/pods/test-pod&quot;</span>
            <span class="c1">#</span>
            <span class="c1"># Strip pods/{POD} off name to get the parent.</span>
            <span class="k">return</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">asset</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>

        <span class="k">elif</span> <span class="n">asset</span><span class="p">[</span><span class="s1">&#39;asset_type&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;rbac.authorization.k8s.io/Role&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;rbac.authorization.k8s.io/RoleBinding&#39;</span><span class="p">):</span>
            <span class="c1"># &quot;name&quot;:&quot;//container.googleapis.com/projects/test-project/zones/</span>
            <span class="c1"># us-central1-b/clusters/test-cluster/k8s/namespaces/</span>
            <span class="c1"># test-namespace/rbac.authorization.k8s.io/roles/</span>
            <span class="c1"># extension-apiserver-authentication-reader&quot;</span>
            <span class="c1">#</span>
            <span class="c1"># Strip rbac.authorization.k8s.io/roles/{ROLE} off name to get the</span>
            <span class="c1"># parent.</span>
            <span class="c1">#</span>
            <span class="c1"># &quot;name&quot;:&quot;//container.googleapis.com/projects/test-project/zones/</span>
            <span class="c1"># us-central1-b/clusters/test-cluster/k8s/namespaces/test-namespace/</span>
            <span class="c1"># rbac.authorization.k8s.io/rolebindings/</span>
            <span class="c1"># system:controller:bootstrap-signer&quot;</span>
            <span class="c1">#</span>
            <span class="c1"># Strip rbac.authorization.k8s.io/rolebindings/{ROLEBINDING} off</span>
            <span class="c1"># name to get the parent.</span>
            <span class="k">return</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">asset</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span>

        <span class="k">elif</span> <span class="n">asset</span><span class="p">[</span><span class="s1">&#39;asset_type&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="s1">&#39;rbac.authorization.k8s.io/ClusterRole&#39;</span><span class="p">,</span>
                <span class="s1">&#39;rbac.authorization.k8s.io/ClusterRoleBinding&#39;</span><span class="p">):</span>
            <span class="c1"># Kubernetes ClusterRoles and ClusterRoleBindings are parented by a</span>
            <span class="c1"># k8s under a cluster, but the k8 is not directly discoverable</span>
            <span class="c1"># without iterating all k8s, so instead this creates an artificial</span>
            <span class="c1"># parent at the cluster level, which acts as an aggregated list of</span>
            <span class="c1"># all cluster roles and cluster role bindings in all k8s to fix this</span>
            <span class="c1"># broken behavior.</span>
            <span class="c1">#</span>
            <span class="c1"># &quot;name&quot;:&quot;//container.googleapis.com/projects/test-project/zones/</span>
            <span class="c1"># us-central1-b/clusters/test-cluster/k8s/rbac.authorization.k8s.io/</span>
            <span class="c1"># clusterroles/cloud-provider&quot;</span>
            <span class="c1">#</span>
            <span class="c1"># Strip k8s/rbac.authorization.k8s.io/clusterroles/</span>
            <span class="c1"># {CLUSTERROLE} off name to get the parent.</span>
            <span class="c1">#</span>
            <span class="c1"># &quot;name&quot;:&quot;//container.googleapis.com/projects/test-project/zones/</span>
            <span class="c1"># us-central1-b/clusters/test-cluster/k8s/</span>
            <span class="c1"># rbac.authorization.k8s.io/clusterrolebindings/cluster-admin&quot;</span>
            <span class="c1">#</span>
            <span class="c1"># Strip k8s/rbac.authorization.k8s.io/clusterrolebindings/</span>
            <span class="c1"># {CLUSTERROLEBINDING} off name to get the parent.</span>
            <span class="k">return</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">asset</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span>

        <span class="c1"># Known unparented asset types.</span>
        <span class="k">if</span> <span class="n">asset</span><span class="p">[</span><span class="s1">&#39;asset_type&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">CaiTemporaryStore</span><span class="o">.</span><span class="n">UNPARENTED_ASSETS</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Could not determine parent name for </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">asset</span><span class="p">)</span>

        <span class="k">return</span> <span class="s1">&#39;&#39;</span></div></div>


<div class="viewcode-block" id="CaiDataAccess"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.cai_temporary_storage.html#google.cloud.forseti.services.inventory.cai_temporary_storage.CaiDataAccess">[docs]</a><span class="k">class</span> <span class="nc">CaiDataAccess</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Access to the CAI temporary store table.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="CaiDataAccess.clear_cai_data"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.cai_temporary_storage.html#google.cloud.forseti.services.inventory.cai_temporary_storage.CaiDataAccess.clear_cai_data">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">clear_cai_data</span><span class="p">(</span><span class="n">engine</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Deletes all temporary CAI data from the cai temporary table.</span>

<span class="sd">        Args:</span>
<span class="sd">            engine (object): Database engine.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: The number of rows deleted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">CaiTemporaryStore</span><span class="o">.</span><span class="n">delete_all</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span></div>

<div class="viewcode-block" id="CaiDataAccess.populate_cai_data"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.cai_temporary_storage.html#google.cloud.forseti.services.inventory.cai_temporary_storage.CaiDataAccess.populate_cai_data">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">populate_cai_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">engine</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add assets from cai data dump into cai temporary table.</span>

<span class="sd">        Args:</span>
<span class="sd">            data (file): A file like object, line delimeted text dump of json</span>
<span class="sd">                data representing assets from Cloud Asset Inventory exportAssets</span>
<span class="sd">                API.</span>
<span class="sd">            engine (object): Database engine.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: The number of rows inserted</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">num_rows</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">cai_table_insert</span> <span class="o">=</span> <span class="n">CaiTemporaryStore</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">insert</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rows_total_length</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">row</span> <span class="o">=</span> <span class="n">CaiTemporaryStore</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">row</span><span class="p">:</span>
                    <span class="n">num_rows</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                    <span class="n">rows_total_length</span> <span class="o">+=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                    <span class="k">if</span> <span class="n">rows_total_length</span> <span class="o">&gt;</span> <span class="n">MAX_ALLOWED_INSERT_SIZE</span> <span class="o">*</span> <span class="o">.</span><span class="mi">9</span><span class="p">:</span>
                        <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Flushing </span><span class="si">%i</span><span class="s1"> rows to CAI table&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">))</span>
                        <span class="n">engine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">cai_table_insert</span><span class="p">(),</span> <span class="n">rows</span><span class="p">)</span>
                        <span class="n">rows_total_length</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="n">rows</span><span class="p">:</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Flushing remaining </span><span class="si">%i</span><span class="s1"> rows to CAI table&#39;</span><span class="p">,</span>
                             <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">))</span>
                <span class="n">engine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">cai_table_insert</span><span class="p">(),</span> <span class="n">rows</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">SQLAlchemyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Error populating CAI data: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">num_rows</span></div>

<div class="viewcode-block" id="CaiDataAccess.iter_cai_assets"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.cai_temporary_storage.html#google.cloud.forseti.services.inventory.cai_temporary_storage.CaiDataAccess.iter_cai_assets">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="nd">@retry</span><span class="p">(</span><span class="n">wait_exponential_multiplier</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">wait_exponential_max</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
           <span class="n">stop_max_attempt_number</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">iter_cai_assets</span><span class="p">(</span><span class="n">content_type</span><span class="p">,</span> <span class="n">asset_type</span><span class="p">,</span> <span class="n">parent_name</span><span class="p">,</span> <span class="n">engine</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iterate the objects in the cai temporary table.</span>

<span class="sd">        Retries query on exception up to 5 times.</span>

<span class="sd">        Args:</span>
<span class="sd">            content_type (ContentTypes): The content type to return.</span>
<span class="sd">            asset_type (str): The asset type to return.</span>
<span class="sd">            parent_name (str): The parent resource to iter children under.</span>
<span class="sd">            engine (object): Database engine.</span>

<span class="sd">        Yields:</span>
<span class="sd">            object: The content_type data for each resource.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">base_query</span> <span class="o">=</span> <span class="n">CaiTemporaryStore</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
        <span class="n">filters</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">CaiTemporaryStore</span><span class="o">.</span><span class="n">parent_name</span> <span class="o">==</span> <span class="n">parent_name</span><span class="p">,</span>
            <span class="n">CaiTemporaryStore</span><span class="o">.</span><span class="n">content_type</span> <span class="o">==</span> <span class="n">content_type</span><span class="p">,</span>
            <span class="n">CaiTemporaryStore</span><span class="o">.</span><span class="n">asset_type</span> <span class="o">==</span> <span class="n">asset_type</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">qry_filter</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
            <span class="n">base_query</span> <span class="o">=</span> <span class="n">base_query</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">qry_filter</span><span class="p">)</span>

        <span class="n">base_query</span> <span class="o">=</span> <span class="n">base_query</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">CaiTemporaryStore</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">asc</span><span class="p">())</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">base_query</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">CaiDataAccess</span><span class="o">.</span><span class="n">_extract_asset_data</span><span class="p">(</span><span class="n">row</span><span class="p">)</span></div>

<div class="viewcode-block" id="CaiDataAccess.fetch_cai_asset"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.cai_temporary_storage.html#google.cloud.forseti.services.inventory.cai_temporary_storage.CaiDataAccess.fetch_cai_asset">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="nd">@retry</span><span class="p">(</span><span class="n">wait_exponential_multiplier</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">wait_exponential_max</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
           <span class="n">stop_max_attempt_number</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">fetch_cai_asset</span><span class="p">(</span><span class="n">content_type</span><span class="p">,</span> <span class="n">asset_type</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">engine</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a single resource from the cai temporary store.</span>

<span class="sd">        Retries query on exception up to 5 times.</span>

<span class="sd">        Args:</span>
<span class="sd">            content_type (ContentTypes): The content type to return.</span>
<span class="sd">            asset_type (str): The asset type to return.</span>
<span class="sd">            name (str): The resource to return.</span>
<span class="sd">            engine (object): Database engine.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: The content data for the specified resource.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">base_query</span> <span class="o">=</span> <span class="n">CaiTemporaryStore</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
        <span class="n">filters</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">CaiTemporaryStore</span><span class="o">.</span><span class="n">content_type</span> <span class="o">==</span> <span class="n">content_type</span><span class="p">,</span>
            <span class="n">CaiTemporaryStore</span><span class="o">.</span><span class="n">asset_type</span> <span class="o">==</span> <span class="n">asset_type</span><span class="p">,</span>
            <span class="n">CaiTemporaryStore</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">qry_filter</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
            <span class="n">base_query</span> <span class="o">=</span> <span class="n">base_query</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">qry_filter</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">base_query</span><span class="p">)</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">row</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">CaiDataAccess</span><span class="o">.</span><span class="n">_extract_asset_data</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{},</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="CaiDataAccess._extract_asset_data"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.cai_temporary_storage.html#google.cloud.forseti.services.inventory.cai_temporary_storage.CaiDataAccess._extract_asset_data">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_extract_asset_data</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extracts the data from the database row.</span>

<span class="sd">        Args:</span>
<span class="sd">            row (dict): Database row from select query.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[dict, AssetMetadata]: The dict representation of the asset</span>
<span class="sd">                data and an Asset metadata along with it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">asset</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;asset_data&#39;</span><span class="p">])</span>
        <span class="n">asset_metadata</span> <span class="o">=</span> <span class="n">AssetMetadata</span><span class="p">(</span><span class="n">cai_name</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                                       <span class="n">cai_type</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;asset_type&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">asset</span><span class="p">,</span> <span class="n">asset_metadata</span></div></div>


<div class="viewcode-block" id="create_sqlite_db"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.cai_temporary_storage.html#google.cloud.forseti.services.inventory.cai_temporary_storage.create_sqlite_db">[docs]</a><span class="k">def</span> <span class="nf">create_sqlite_db</span><span class="p">(</span><span class="n">threads</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create and initialize a sqlite db engine for use as the CAI temp store.</span>

<span class="sd">    Args:</span>
<span class="sd">        threads (int): The number of threads to support. Pool size is set to 5</span>
<span class="sd">            greater than the number of threads, so that each thread can get its</span>
<span class="sd">            own connection to the temp database, with a few spare.</span>
<span class="sd">    Returns:</span>
<span class="sd">        Tuple[sqlalchemy.engine.Engine, str]: A tuple containing an engine</span>
<span class="sd">            object initialized to a temporary sqlite db file, and the path to</span>
<span class="sd">            the temporary file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dbfile</span><span class="p">,</span> <span class="n">tmpfile</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">(</span><span class="s1">&#39;.db&#39;</span><span class="p">,</span> <span class="s1">&#39;forseti-cai-store-&#39;</span><span class="p">)</span>
    <span class="n">pool_size</span> <span class="o">=</span> <span class="n">threads</span> <span class="o">+</span> <span class="mi">5</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s1">&#39;sqlite:///</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tmpfile</span><span class="p">),</span>
                               <span class="n">sqlite_enforce_fks</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                               <span class="n">pool_size</span><span class="o">=</span><span class="n">pool_size</span><span class="p">,</span>
                               <span class="n">connect_args</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;check_same_thread&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
                               <span class="n">poolclass</span><span class="o">=</span><span class="n">SingletonThreadPool</span><span class="p">)</span>
        <span class="n">_initialize</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">engine</span><span class="p">,</span> <span class="n">tmpfile</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">dbfile</span><span class="p">)</span></div>


<div class="viewcode-block" id="_initialize"><a class="viewcode-back" href="../../../../../../google.cloud.forseti.services.inventory.cai_temporary_storage.html#google.cloud.forseti.services.inventory.cai_temporary_storage._initialize">[docs]</a><span class="k">def</span> <span class="nf">_initialize</span><span class="p">(</span><span class="n">engine</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create all tables in the database if not existing.</span>

<span class="sd">    Args:</span>
<span class="sd">        engine (object): Database engine to operate on.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">BASE</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span></div>
</pre></div>
